//>>built
define("esri/renderers/smartMapping","require module dojo/_base/array dojo/_base/lang dojo/has dojo/Deferred dojo/DeferredList dojo/promise/all dojo/when ../kernel ../Color ../numberUtils ../styles/type ../styles/size ../styles/choropleth ../styles/heatmap ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ./UniqueValueRenderer ./ClassBreaksRenderer ./HeatmapRenderer ./BlendRenderer ./utils dojo/i18n!../nls/jsapi".split(" "),function(U,ia,v,D,ja,y,E,ka,la,ma,w,G,
V,H,I,W,na,P,oa,pa,J,qa,ra,A,sa){function k(a,c){a.reject(Error(c))}function u(a,c,b,d){var e;switch(b){case "point":e=new na;e.setColor(c);e.setSize(null!=d?d:a.size);c=new P;c.setColor(a.outline.color);c.setWidth(a.outline.width);e.setOutline(c);break;case "line":e=new P;e.setColor(c);e.setWidth(null!=d?d:a.width);break;case "polygon":e=new oa,e.setColor(c),c=new P,c.setColor(a.outline.color),c.setWidth(a.outline.width),e.setOutline(c)}return e}function C(a){a=a.geometryType;"esriGeometryPoint"===
a||"esriGeometryMultipoint"===a?a="point":"esriGeometryPolyline"===a?a="line":"esriGeometryPolygon"===a&&(a="polygon");return a}function Q(a,c){var b=a.scheme;b=b?V.cloneScheme(b):(b=V.getSchemes({theme:a.theme||ta,basemap:a.basemap,geometryType:c}))&&b.primaryScheme;return b}function X(a,c){return a.label<c.label?-1:a.label>c.label?1:0}function Y(a,c){return a.value<c.value?-1:a.value>c.value?1:0}function ua(a,c){var b=c.count-a.count;0===b&&(b=X(a,c));return b}function va(a,c){var b=c.count-a.count;
0===b&&(b=Y(a,c));return b}function wa(a,c,b){var d;"count"===c?(d=va,b&&b.codedValues&&(d=ua)):"value"===c&&(d=Y,b&&b.codedValues&&(d=X));d&&a.sort(d)}function Z(a,c,b){var d=b.layer,e=b.field,f=D.isFunction(e),g=f?null:d.getField(e),l=f?null:d.getDomain(g.name),p,h=-1,n,k=null==b.numTypes?10:-1===b.numTypes?a.length:b.numTypes,f=null==b.showOthers?!0:b.showOthers,m=null==b.sortBy?"count":b.sortBy,r=b&&b.labelCallback,s=C(d),q=Q(b,s),d=new pa(null,e),z={domain:l,fieldInfo:g};v.forEach(a,function(a,
c){z.value=a.value;a.label=A.createUniqueValueLabel(z);r&&(a.label=r(a));null===a.value&&(h=c)});-1<h&&(n=a.splice(h,1)[0]);wa(a,m,l);z.dateFormatInterval=A.calculateDateFormatInterval(v.map(v.filter(a,function(a,c){return c<k}),function(a){return a.value}));p=x.createColors(q.colors,a.length);v.forEach(a,function(a,c){z.value=a.value;a.label=A.createUniqueValueLabel(z);r&&(a.label=r(a));a.symbol=u(q,p[c],s)});p=x.createColors(q.colors,k);for(g=0;g<k;g++)(e=a[g])&&d.addValue({value:e.value,label:e.label,
symbol:u(q,p[g],s)});f&&(d.defaultSymbol=u(q,q.noDataColor,s),d.defaultLabel=F.other);n&&(n.symbol=u(q,q.noDataColor,s),a.push(n));c&&c.widthInfo&&d.setVisualVariables([c.widthInfo]);return{renderer:d,uniqueValueInfos:a,othersStartIndex:d.infos.length===a.length?-1:d.infos.length,scheme:Q(b,s)}}function K(a,c,b){var d=a.scheme;d=d?I.cloneScheme(d):(d=I.getSchemes({theme:b||a.theme||xa,basemap:a.basemap,geometryType:c}))&&d.primaryScheme;return d}function R(a){var c=a.avg,b=c-a.stddev,d=c+a.stddev;
b<a.min&&(b=a.min);d>a.max&&(d=a.max);a=G.round([b,d],{strictBounds:!0});b=a[0];d=a[1];a=[b,b+(c-b)/2,c,c+(d-c)/2,d];return G.round(a,{strictBounds:!0})}function ya(a,c,b){var d=(c-a)/(b-1),e,f=[a];for(e=1;e<=b-2;e++)f.push(a+e*d);f.push(c);return G.round(f,{strictBounds:!0})}function L(a,c){var b,d;if(null==a.min)b=0,d=100;else if(a.min===a.max)0>a.min?(b=2*a.min,d=0):0<a.min?(b=0,d=2*a.min):(b=0,d=100);else if(c&&(null==a.avg||!a.stddev))b=a.min,d=a.max;return null!=b?[b,d]:null}function $(a,c,
b,d,e){var f=null==d.useDefaultStatistics?!0:d.useDefaultStatistics;if(a&&!a.count&&!f)k(e,"smartMapping.createColorInfo: cannot create renderer when statistics.count is 0.");else{var g=d.field,l=C(d.layer),p=K(d,l),h=d.semiContinuous,n,t,m,r=c&&c.classBreakInfos,s=r&&r.length,q=c?s:5;if(p){var z=c&&-1<p.id.indexOf("seq-")?aa(p,{length:q}):x.createColors(p.colors,q);if(z.length<q)k(e,"smartMapping.createColorInfo: not enough colors in the scheme.");else{if(c){n=[];var u;1===s?(t=[r[0].minValue,r[0].maxValue],
n=[0,1],u=x.createColors(z,q)[0],m=[u,new w(u)]):h?(t=[],m=[],v.forEach(r,function(a,c){var b=0.1*(a.maxValue-a.minValue);0===c?t.push(a.minValue):t.push(a.minValue+b);c===s-1?t.push(a.maxValue):t.push(a.maxValue-b);u=new w(z[c]);m.push(u);m.push(new w(u));n.push(2*c);n.push(2*c+1)})):(t=v.map(r,function(a,c){n.push(c);return(a.minValue+a.maxValue)/2}),m=x.createColors(z,q));t=G.round(t,{strictBounds:!0})}else t=(f=f?L(a,!0):null)?ya(f[0],f[1],5):R(a),n=[0,2,4],m=x.createColors(z,q);b={type:"colorInfo",
field:g,normalizationField:b,stops:A.createColorStops({values:t,colors:m,labelIndexes:n})};e.resolve({colorInfo:b,statistics:a,classBreaks:c,scheme:K(d,l)})}}else k(e,"smartMapping.createColorInfo: unable to find the specified scheme.")}}function ba(a,c,b,d){var e=null==b.useDefaultStatistics?!0:b.useDefaultStatistics;if(a&&!a.count&&!e)k(d,"smartMapping.createOpacityInfo: cannot create opacityInfo when statistics.count is 0.");else{var f=b.useStdDev,g=f?R(a):null,f=(e=e?L(a,f):null)||(f?[g[0],g[4]]:
[a.min,a.max]);d.resolve({opacityInfo:{type:"opacityInfo",field:b.field,normalizationField:c,stops:[{value:f[0],opacity:0.3},{value:f[1],opacity:0.7}]},statistics:a,defaultStatistics:!!e})}}function M(a,c){var b=a.scheme;b=b?H.cloneScheme(b):(b=H.getSchemes({theme:a.theme||za,basemap:a.basemap,geometryType:c}))&&b.primaryScheme;return b}function ca(a,c){var b;switch(c){case "point":b=[a.minSize,a.maxSize];break;case "line":b=[a.minWidth,a.maxWidth];break;case "polygon":b=[a.marker.minSize,a.marker.maxSize]}return b}
function da(a,c,b,d,e){var f=null==d.useDefaultStatistics?!0:d.useDefaultStatistics,g=c&&[c.minSize,c.maxSize];if(a&&!a.count&&!f)k(e,"smartMapping.createSizeInfo: cannot create renderer when statistics.count is 0.");else{var l=d.field,p=C(d.layer),h=M(d,p),g=g||ca(h,p),n=(h=d.useStdDev)?R(a):null,h=(f=f?L(a,h):null)||(h?[n[0],n[4]]:[a.min,a.max]);e.resolve({sizeInfo:{type:"sizeInfo",field:l,valueUnit:"unknown",normalizationField:b,minSize:g[0],maxSize:g[1],minDataValue:h[0],maxDataValue:h[1]},statistics:a,
defaultStatistics:!!f,suggestedSizeRange:c,scheme:M(d,p)})}}function N(a,c,b){var d,e=[],f=1/(b+1);for(d=1;d<=b;d++)e.push(w.blendColors(a,c,f*d));return e}function ea(a,c){var b=[];if(1===c)b=[a[0]];else if(2===c)b=[a[0],a[2]];else if(3===c)b=a;else{var d=c-a.length,b=d/2;0===d%2?(d=N(a[0],a[1],b),b=N(a[1],a[2],b)):(d=N(a[0],a[1],Math.floor(b)),b=N(a[1],a[2],Math.ceil(b)));b=[a[0]].concat(d).concat([a[1]]).concat(b).concat([a[2]])}return b}function aa(a,c,b){var d,e=c.length,f=-1;b&&v.some(c,function(a,
c){a.hasAvg&&(f=c);return-1<f});if(-1<f){var g=a.colors;a=f+1;c=e-f;b=g.slice(0,3);g=g.slice(2);b.reverse();b=ea(b,a);g=ea(g,c);b.reverse();d=[].concat(b).concat(g.slice(1))}else if((a=a.colorsForClassBreaks)&&0<a.length)if(v.some(a,function(a){a.numClasses===e&&(d=a.colors);return!!d}),!d&&(b=a[a.length-1],a=e-b.numClasses,0<a)){c=b.colors[b.numClasses-1];d=b.colors.splice(0);for(b=1;b<=a;b++)d.push(c)}d&&(d=x.createColors(d,d.length));return d}function Aa(a,c,b,d){var e=b.field,f=C(b.layer),g=null==
b.showOthers?!0:b.showOthers,l=b.classificationMethod||"equal-interval",p="standard-deviation"===l,h=b.normalizationType,n,t,m,r=a.classBreakInfos;(n=K(b,f,"high-to-low"))?(t=aa(n,r),!t||t.length!=r.length?k(d,"smartMapping.createClassedColorRenderer: unable to find suitable colors for number of classes."):(m=new J(null,e),m.classificationMethod=l,m.normalizationType=h,m.normalizationField="field"===h?b.normalizationField:void 0,m.normalizationTotal="percent-of-total"===h?a.normalizationTotal:void 0,
g&&(m.defaultSymbol=u(n,n.noDataColor,f),m.defaultLabel=F.other),v.forEach(r,function(a,c){m.addBreak({minValue:a.minValue,maxValue:a.maxValue,symbol:u(n,t[c],f),label:a.label})}),p||A.setLabelsForClassBreaks({classBreaks:m.infos,classificationMethod:l,normalizationType:h,round:!0}),c&&c.widthInfo&&m.setVisualVariables([c.widthInfo]),a.renderer=m,a.scheme=K(b,f,"high-to-low"),d.resolve(a))):k(d,"smartMapping.createClassedColorRenderer: unable to find suitable style scheme.")}function fa(a){var c=
new y,b=a.layer,d=null==a.useDefaultBreaks?!0:a.useDefaultBreaks,e=a.optimizeOutline,f=[b.statisticsPlugin.getClassBreaks(a)];e&&f.push(b.statisticsPlugin.getSuggestedOutline("object"===typeof e?e:null));(new E(f)).then(function(f){var l=f[0];f=f[1];var p=e&&f[0]?f[1]:null;if(l[0]||d&&!b.graphics.length){var l=l[1],h=d?L(l?{min:l.minValue,max:l.maxValue}:{}):null;h&&(l=a.layer.statisticsPlugin.getClassBreaks(D.mixin(a,{classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:h[0],
maxValue:h[1],normalizationTotal:h[0]+h[1]})));la(l).then(function(a){a.defaultStatistics=!!h;c.resolve({cbResponse:a,suggestedOutline:p})}).otherwise(function(){k(c,"smartMapping: error when calculating default class breaks.")})}else k(c,"smartMapping: error when calculating class breaks.")});return c.promise}function Ba(a,c,b,d){c=d||ca(a,c);a=c[0];c=(c[1]-a)/(4<=b?b-1:b);var e=[];for(d=0;d<b;d++)e.push(a+c*d);return e}function S(a,c,b,d,e){var f=d.field,g=C(d.layer),l=null==d.showOthers?!0:d.showOthers,
p=d.classificationMethod||"equal-interval",h=d.normalizationType,n=a.classBreakInfos,k=M(d,g),m=Ba(k,g,n.length,c),r="polygon"===g,s=r?k.marker:k;c=r?k.background:null;var q;q=new J(null,f);q.classificationMethod=p;q.normalizationType=h;q.normalizationField="field"===h?d.normalizationField:void 0;q.normalizationTotal="percent-of-total"===h?a.normalizationTotal:void 0;l&&(q.defaultSymbol=u(s,s.noDataColor,r?"point":g),q.defaultLabel=F.other);c&&(q.backgroundFillSymbol=u(c,c.color,g));v.forEach(n,function(a,
c){q.addBreak({minValue:a.minValue,maxValue:a.maxValue,symbol:u(s,s.color,r?"point":g,m[c]),label:a.label})});"standard-deviation"!==p&&A.setLabelsForClassBreaks({classBreaks:q.infos,classificationMethod:p,normalizationType:h,round:!0});b&&b.widthInfo&&q.setVisualVariables([b.widthInfo]);a.renderer=q;a.scheme=M(d,g);e.resolve(a)}function T(a){var c=a.scheme;c=c?W.cloneScheme(c):(c=W.getSchemes({theme:a.theme||Ca,basemap:a.basemap}))&&c.primaryScheme;return c}function ga(a,c,b){var d=null==c.useDefaultStatistics?
!0:c.useDefaultStatistics;if(!a.count&&!d)k(b,"smartMapping.createHeatmapRenderer: cannot create renderer when statistics.count is 0.");else{var e=a.fieldOffset,f=null==c.blurRadius?10:c.blurRadius,g=null==c.minRatio?0.01:c.minRatio,l=null==c.maxRatio?1:c.maxRatio,p=null==c.fadeToTransparent?!0:c.fadeToTransparent,h=T(c).colors,n=h.length,t=(d=!a.count&&d)?[0,100]:[a.min,a.max],m=new qa;m.setBlurRadius(f);m.setField(c.field);null!=e&&m.setFieldOffset(e);m.setMinPixelIntensity(t[0]);m.setMaxPixelIntensity(t[1]);
var e=h[0],r=[{ratio:0,color:new w([e.r,e.g,e.b,0])},{ratio:ha,color:new w([e.r,e.g,e.b,0])},{ratio:p?g:ha,color:e}],s=(l-g)/(n-1),h=x.createColors(h,n);v.forEach(h,function(a,c){r.push({ratio:g+s*c,color:a})});m.setColorStops(r);b.resolve({renderer:m,statistics:a,defaultStatistics:d,scheme:T(c)})}}function Da(a){return function(c){var b=c.attributes,d=-Infinity,e=null,f;b&&v.forEach(a,function(a){f=b[a];null!=f&&(f>d?(d=f,e=a):f===d&&(e=null))});return e}}function Ea(a,c){var b={};v.forEach(a,function(a){var e=
c.getField(a.name);b[a.name]=a.label||e&&e.alias||a.name});return function(a){return b[a.value]}}function Fa(a,c){return function(b){var d=b.attributes,e,f=0,g,l=null;d&&(e=(b=c.getUniqueValueInfo(b))&&d[b.value]);null!=e&&(v.forEach(a,function(a){g=d[a];null!=g&&(f+=g)}),0!==f&&(l=e/f));return l}}function Ga(a,c,b,d){var e=b.layer,f=b.fields,g=Da(c),l=v.map(f,function(a){return{value:a.name,count:0}}),f=Z(l,null,{layer:e,field:g,labelCallback:Ea(f,e),numTypes:-1,showOthers:b.showOthers,sortBy:"value",
theme:b.theme,basemap:b.basemap,scheme:b.scheme}),p={renderer:f.renderer,scheme:f.scheme,sampleInfo:a};b&&b.includeOpacityInfo?x.createOpacityInfo({layer:e,field:Fa(c,p.renderer),features:a.features,useStdDev:!0}).then(function(a){p.renderer.setVisualVariables([a.opacityInfo]);d.resolve(p)}).otherwise(function(a){d.resolve(p)}):d.resolve(p)}var x={},O=Math.pow(2,53)-1,F=sa.smartMapping,ta="default",xa="high-to-low",za="default",Ca="default",ha=0.01,B=U.toAbsMid?U.toAbsMid("../plugins/FeatureLayerStatistics"):
ia.id.replace(/\/[^\/]*$/ig,"/")+"../plugins/FeatureLayerStatistics";D.mixin(x,{createColors:function(a,c){var b=[],d=a.length,e;for(e=0;e<c;e++)b.push(new w(a[e%d]));return b},createTypeRenderer:function(a){var c=new y;if(!a||!a.layer||!a.field||!a.scheme&&!a.basemap)return k(c,"smartMapping.createTypeRenderer: missing parameters."),c.promise;var b=a.layer,d=a.optimizeOutline;b.addPlugin(B).then(function(){var e=[b.statisticsPlugin.getUniqueValues({field:a.field,includeAllCodedValues:a.includeAllCodedValues})];
d&&e.push(b.statisticsPlugin.getSuggestedOutline("object"===typeof d?d:null));(new E(e)).then(function(b){var e=b[0];b=b[1];b=d&&b[0]?b[1]:null;e[0]?(e=e[1],b=Z(e.uniqueValueInfos,b,a),b.source=e.source,c.resolve(b)):k(c,"smartMapping.createTypeRenderer: error when calculating unique values.")})}).otherwise(function(a){k(c,"smartMapping.createTypeRenderer: error when adding feature layer statistics plugin.")});return c.promise},createColorInfo:function(a){var c=new y;if(!a||!a.layer||!a.field)return k(c,
"smartMapping.createColorInfo: missing parameters."),c.promise;var b=a.layer,d=a.normalizationField,e=d?"field":void 0;a.statistics?$(a.statistics,null,d,a,c):b.addPlugin(B).then(function(){var f="group-similar"===a.theme||a.scheme&&0===a.scheme.id.indexOf("group-similar/");(f?b.statisticsPlugin.getClassBreaks({field:a.field,classificationMethod:"natural-breaks",numClasses:a.numGroups||5,normalizationType:e,normalizationField:d,minValue:a.minValue,maxValue:a.maxValue}):b.statisticsPlugin.getFieldStatistics({field:a.field,
normalizationType:e,normalizationField:d,minValue:a.minValue,maxValue:a.maxValue})).then(function(b){var e,p;f?e=b:p=b;$(p,e,d,a,c)}).otherwise(function(a){k(c,f?"smartMapping.createColorInfo: error when calculating class breaks.":"smartMapping.createColorInfo: error when calculating field statistics.")})}).otherwise(function(a){k(c,"smartMapping.createColorInfo: error when adding feature layer statistics plugin.")});return c.promise},createColorRenderer:function(a){var c=new y;if(!a||!a.layer||!a.field)return k(c,
"smartMapping.createColorRenderer: missing parameters."),c.promise;var b=a.layer,d=a.normalizationField,e=d?"field":void 0,f=a.optimizeOutline;b.addPlugin(B).then(function(){var g=[x.createColorInfo(a)];f&&g.push(b.statisticsPlugin.getSuggestedOutline("object"===typeof f?f:null));(new E(g)).then(function(b){var g=b[0];b=b[1];b=f&&b[0]?b[1]:null;if(g[0]){var g=g[1],h=a.field,n=C(a.layer),t=null==a.showOthers?!0:a.showOthers,m=I.cloneScheme(g.scheme),h=new J(null,h);t&&(h.defaultSymbol=u(m,m.noDataColor,
n),h.defaultLabel=F.other);h.addBreak({minValue:-O,maxValue:O,symbol:u(m,m.noDataColor,n)});h.normalizationType=e;h.normalizationField=d;n=[A.cloneColorInfo(g.colorInfo)];b&&b.widthInfo&&n.push(b.widthInfo);h.setVisualVariables(n);c.resolve({renderer:h,colorInfo:A.cloneColorInfo(g.colorInfo),statistics:g.statistics,classBreaks:g.classBreaks,scheme:I.cloneScheme(g.scheme)})}else k(c,"smartMapping.createColorRenderer: error when calculating colorInfo.")})}).otherwise(function(a){k(c,"smartMapping.createColorRenderer: error when adding feature layer statistics plugin.")});
return c.promise},createOpacityInfo:function(a){var c=new y;if(!a||!a.layer||!a.field)return k(c,"smartMapping.createOpacityInfo: missing parameters."),c.promise;var b=a.layer,d=a.normalizationField,e=d?"field":void 0;a.statistics?ba(a.statistics,d,a,c):b.addPlugin(B).then(function(){b.statisticsPlugin.getFieldStatistics({field:a.field,normalizationType:e,normalizationField:d,minValue:a.minValue,maxValue:a.maxValue,features:a.features}).then(function(b){ba(b,d,a,c)}).otherwise(function(a){k(c,"smartMapping.createOpacityInfo: error when calculating field statistics.")})}).otherwise(function(a){k(c,
"smartMapping.createOpacityInfo: error when adding feature layer statistics plugin.")});return c.promise},createBlendRenderer:function(a){var c=new y,b=this,d,e=[],f={},g=[],l=[],p=a.opacityValueCombinationMethod||"avg",h={};if(!a||!a.layer||!a.blendedFields)return k(c,"smartMapping.createBlendRenderer: missing parameters."),c.promise;a.basemap=a.basemap||"topo";e=C(a.layer);d=Q({basemap:a.basemap},e);d.colors=[new w("#e60000"),new w("#0000e6"),new w("#00e600"),new w("#e67300"),new w("#a900e6")];
h.fields=[];h.normalizationField=a.normalizationField;h.blendMode=a.blendMode||"source-over";h.symbol=u(d,d.noDataColor,a.markers?"point":e);f.layer=a.layer;f.normalizationField=a.normalizationField;f.useStdDev=a.useStdDev||!1;e=v.map(a.blendedFields,function(a,c){h.fields.push({field:a,color:d.colors[c]});f.field=a;return b.createOpacityInfo(f)});ka(e).then(function(b){l[0]=b[0].opacityInfo.stops[0].value;l[1]=b[1].opacityInfo.stops[1].value;v.forEach(b.slice(0,1),function(a){var c=a.opacityInfo.stops[0].value,
b=a.opacityInfo.stops[1].value;"union"===p?(l[0]=c<l[0]?c:l[0],l[1]=b>l[1]?b:l[1]):"avg"===p&&(l[0]+=a.opacityInfo.stops[0].value,l[1]+=a.opacityInfo.stops[1].value)});g[0]={value:"avg"===p?l[0]/b.length:l[0],opacity:a.minOpacity?a.minOpacity:b[0].opacityInfo.stops[0].opacity};g[1]={value:"avg"===p?l[1]/b.length:l[1],opacity:a.maxOpacity?a.maxOpacity:b[0].opacityInfo.stops[1].opacity};h.opacityStops=g;c.resolve({renderer:new ra(h),scheme:d,opacityInfos:b})});return c.promise},createSizeInfo:function(a){var c=
new y;if(!a||!a.layer||!a.field)return k(c,"smartMapping.createSizeInfo: missing parameters."),c.promise;var b=a.layer,d=a.normalizationField,e=d?"field":void 0,f=a.optimizeForScale;a.statistics?da(a.statistics,null,d,a,c):b.addPlugin(B).then(function(){var g=[b.statisticsPlugin.getFieldStatistics({field:a.field,normalizationType:e,normalizationField:d,minValue:a.minValue,maxValue:a.maxValue})];f&&g.push(b.statisticsPlugin.getSuggestedSizeRange({optimizeForScale:!0===f?"map-scale":f}));(new E(g)).then(function(b){var e=
b[0];b=f&&b[1];b=f&&b[0]?b[1]:null;e[0]?da(e[1],b,d,a,c):k(c,"smartMapping.createSizeInfo: error when calculating field statistics.")})}).otherwise(function(a){k(c,"smartMapping.createSizeInfo: error when adding feature layer statistics plugin.")});return c.promise},createSizeRenderer:function(a){var c=new y;if(!a||!a.layer||!a.field)return k(c,"smartMapping.createSizeRenderer: missing parameters."),c.promise;var b=a.layer,d=a.normalizationField,e=d?"field":void 0,f=a.optimizeOutline;b.addPlugin(B).then(function(){var g=
[x.createSizeInfo(a)];f&&g.push(b.statisticsPlugin.getSuggestedOutline("object"===typeof f?f:null));(new E(g)).then(function(b){var g=b[0];b=b[1];b=f&&b[0]?b[1]:null;if(g[0]){var g=g[1],h=a.field,n=C(a.layer),t=null==a.showOthers?!0:a.showOthers,m=H.cloneScheme(g.scheme),r="polygon"===n,s=r?m.marker:m,m=r?m.background:null,q="line"===n?s.noDataWidth:s.noDataSize,h=new J(null,h);t&&(h.defaultSymbol=u(s,s.noDataColor,r?"point":n,q),h.defaultLabel=F.other);h.addBreak({minValue:-O,maxValue:O,symbol:u(s,
s.color,r?"point":n)});m&&(h.backgroundFillSymbol=u(m,m.color,n));h.normalizationType=e;h.normalizationField=d;n=[A.cloneSizeInfo(g.sizeInfo)];b&&b.widthInfo&&n.push(b.widthInfo);h.setVisualVariables(n);c.resolve({renderer:h,sizeInfo:A.cloneSizeInfo(g.sizeInfo),statistics:g.statistics,defaultStatistics:g.defaultStatistics,suggestedSizeRange:g.suggestedSizeRange,scheme:H.cloneScheme(g.scheme)})}else k(c,"smartMapping.createSizeRenderer: error when calculating sizeInfo.")})}).otherwise(function(a){k(c,
"smartMapping.createSizeRenderer: error when adding feature layer statistics plugin.")});return c.promise},createClassedColorRenderer:function(a){var c=new y,b=a.minValue,d=a.maxValue,e;if(!a||!a.layer||!a.field)return k(c,"smartMapping.createClassedColorRenderer: missing parameters."),c.promise;e=null!=b&&null!=d;if(!e&&(null!=b||null!=d))return k(c,"smartMapping.createClassedColorRenderer: both minValue and maxValue are required when specifying custom data range."),c.promise;a=D.mixin({analyzeData:!e},
a);a.layer.addPlugin(B).then(function(){fa(a).then(function(b){Aa(b.cbResponse,b.suggestedOutline,a,c)}).otherwise(function(a){k(c,"smartMapping.createClassedColorRenderer: error when calculating class breaks.")})}).otherwise(function(a){k(c,"smartMapping.createClassedColorRenderer: error when adding feature layer statistics plugin.")});return c.promise},createClassedSizeRenderer:function(a){var c=new y,b=a.minValue,d=a.maxValue,e;if(!a||!a.layer||!a.field)return k(c,"smartMapping.createClassedSizeRenderer: missing parameters."),
c.promise;e=null!=b&&null!=d;if(!e&&(null!=b||null!=d))return k(c,"smartMapping.createClassedColorRenderer: both minValue and maxValue are required when specifying custom data range."),c.promise;a=D.mixin({analyzeData:!e},a);var f=a.layer;f.addPlugin(B).then(function(){fa(a).then(function(b){a.optimizeForScale?f.statisticsPlugin.getSuggestedSizeRange().then(function(d){S(b.cbResponse,[d.minSize,d.maxSize],b.suggestedOutline,a,c)}).otherwise(function(d){S(b.cbResponse,null,b.suggestedOutline,a,c)}):
S(b.cbResponse,null,b.suggestedOutline,a,c)}).otherwise(function(a){k(c,"smartMapping.createClassedSizeRenderer: error when calculating class breaks.")})}).otherwise(function(a){k(c,"smartMapping.createClassedSizeRenderer: error when adding feature layer statistics plugin.")});return c.promise},createHeatmapRenderer:function(a){var c=new y;if(!a||!a.layer)return k(c,"smartMapping.createHeatmapRenderer: missing parameters."),c.promise;var b=a.layer;a.statistics?ga(a.statistics,a,c):b.addPlugin(B).then(function(){b.statisticsPlugin.getHeatmapStatistics(a).then(function(b){ga(b,
a,c)}).otherwise(function(a){k(c,"smartMapping.createHeatmapRenderer: error when calculating heatmap statistics.")})}).otherwise(function(a){k(c,"smartMapping.createHeatmapRenderer: error when adding feature layer statistics plugin.")});return c.promise},applyHeatmapScheme:function(a){if(a&&a.renderer&&a.scheme){var c=T({scheme:a.scheme});a=a.renderer;var b=a.colorStops,c=c.colors;if(b.length===c.length+3){var d;d=new w(c[0]);b=v.map(b,function(a){return D.mixin({},a)});b[0].color=new w([d.r,d.g,
d.b,0]);b[1].color=new w([d.r,d.g,d.b,0]);b[2].color=d;for(d=3;d<b.length;d++)b[d].color=c[d-3];a.setColorStops(b)}}},sampleSize:500,createPredominanceRenderer:function(a){var c=new y;if(!a||!a.layer||!a.fields)return k(c,"smartMapping.createPredominanceRenderer: missing parameters."),c.promise;var b=a.layer;b.addPlugin(B).then(function(){var d=a&&a.sampleSize||x.sampleSize,e=v.map(a.fields,function(a){return a.name});b.statisticsPlugin.getSampleFeatures({sampleSize:d,outFields:e,returnGeometry:!1}).then(function(b){Ga(b,
e,a,c)}).otherwise(function(a){k(c,"smartMapping.createPredominanceRenderer: unable to sample features.")})}).otherwise(function(a){k(c,"smartMapping.createPredominanceRenderer: error when adding feature layer statistics plugin.")});return c.promise}});ja("extend-esri")&&D.setObject("renderer.smartMapping",x,ma);return x});