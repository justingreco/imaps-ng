//>>built
require({cache:{"url:esri/dijit/templates/Directions.html":'\x3cdiv class\x3d"${options.theme}" role\x3d"presentation"\x3e\r\n    \x3cdiv data-dojo-attach-point\x3d"_widgetContainer" class\x3d"${_css.widgetContainerClass}" role\x3d"presentation"\x3e\r\n        \x3cdiv class\x3d"${_css.stopsContainerClass}" role\x3d"presentation"\x3e\r\n            \x3cdiv id\x3d"search-source-container" class\x3d"${_css.searchSourceContainerClass}" data-dojo-attach-point\x3d"_searchSourceContainerNode"\x3e\r\n                \x3cdiv data-dojo-attach-point\x3d"_searchSourceSelectorContainer"\x3e\x3c/div\x3e\r\n            \x3c/div\x3e\r\n            \x3ctable class\x3d"${_css.stopsClass}" data-dojo-attach-point\x3d"_dndNode"\x3e\x3c/table\x3e\r\n            \x3cdiv class\x3d"${_css.clearClass}"\x3e\x3c/div\x3e\r\n            \x3cdiv class\x3d"${_css.stopsButtonContainerClass}"\x3e\r\n                \x3cdiv class\x3d"${_css.stopsAddDestinationClass}"\x3e\r\n                    \x3cdiv tabindex\x3d"0" role\x3d"button" data-dojo-attach-point\x3d"_activateButtonNode" title\x3d"${_i18n.widgets.directions.activate}" class\x3d"${_css.activateButtonClass} ${_css.stopsButtonClass} ${_css.stopsButtonTabClass} ${_css.stopsPressedButtonClass}"\x3e\x3c/div\x3e\r\n                    \x3cdiv role\x3d"button" tabindex\x3d"0" class\x3d"${_css.linkButtonClass} ${_css.stopsAddDestinationBtnClass}" data-dojo-attach-point\x3d"_addDestinationNode"\x3e${_i18n.widgets.directions.addDestination}\x3c/div\x3e\r\n                \x3c/div\x3e\r\n                \x3cdiv class\x3d"${_css.travelModesContainerClass}" data-dojo-attach-point\x3d"_travelModeContainerNode"\x3e\r\n                    \x3cdiv data-dojo-attach-point\x3d"_travelModeSelectorContainer"\x3e\x3c/div\x3e\r\n                \x3c/div\x3e\r\n                \x3cdiv tabindex\x3d"0" role\x3d"button" class\x3d"${_css.linkButtonClass} ${_css.stopsOptionsButtonClass}" data-dojo-attach-point\x3d"_optionsButtonNode"\x3e${_i18n.widgets.directions.showOptions}\x3c/div\x3e\r\n            \t\x3cdiv class\x3d"${_css.clearClass}"\x3e\x3c/div\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv role\x3d"presentation" class\x3d"${_css.stopsOptionsMenuClass}" data-dojo-attach-point\x3d"_optionsMenuNode"\x3e\r\n                \x3cdiv class\x3d"${_css.stopsOptionsCheckboxesClass}"\x3e\r\n                    \x3cul\x3e\r\n                        \x3cli class\x3d"${_css.stopsFindOptimalOrderClass}" data-dojo-attach-point\x3d"_findOptimalOrderItemNode"\x3e\x3cinput tabindex\x3d"0" data-dojo-attach-point\x3d"_findOptimalOrderNode" type\x3d"checkbox" id\x3d"${id}_find_optimal_order" /\x3e\x3clabel for\x3d"${id}_find_optimal_order"\x3e${_i18n.widgets.directions.findOptimalOrder}\x3c/label\x3e\x3c/li\x3e\r\n                        \x3cli class\x3d"${_css.stopsReturnToStartClass}" data-dojo-attach-point\x3d"_returnToStartItemNode"\x3e\x3cinput tabindex\x3d"0" data-dojo-attach-point\x3d"_returnToStartNode" type\x3d"checkbox" id\x3d"${id}_stopsReturnToStart" /\x3e\x3clabel for\x3d"${id}_stopsReturnToStart"\x3e${_i18n.widgets.directions.returnToStart}\x3c/label\x3e\x3c/li\x3e\r\n                        \x3cli class\x3d"${_css.stopsUseTrafficClass}" data-dojo-attach-point\x3d"_useTrafficItemNode"\x3e\x3cinput tabindex\x3d"0" data-dojo-attach-point\x3d"_useTrafficNode" type\x3d"checkbox" id\x3d"${id}_stopsUseTraffic" /\x3e\x3clabel for\x3d"${id}_stopsUseTraffic"\x3e${_i18n.widgets.directions.useTraffic}\x3c/label\x3e\x3c/li\x3e\r\n                    \x3c/ul\x3e\r\n                \x3c/div\x3e\r\n                \x3cdiv class\x3d"${_css.stopsOptionsToggleContainerClass}"\x3e\r\n                    \x3cdiv class\x3d"${_css.stopsOptionsUnitsContainerClass}"  data-dojo-attach-point\x3d"_agolDistanceUnitsNode"\x3e\r\n                        \x3cdiv tabindex\x3d"0" role\x3d"button" class\x3d"${_css.stopsOptionsUnitsMiClass} ${_css.stopsButtonClass} ${_css.stopsButtonTabClass}" data-dojo-attach-point\x3d"_useMilesNode"\x3e${_i18n.widgets.directions.units.MILES.abbr}\x3c/div\x3e\r\n                        \x3cdiv tabindex\x3d"0" role\x3d"button" class\x3d"${_css.stopsOptionsUnitsKmClass} ${_css.stopsButtonClass} ${_css.stopsButtonTabClass} ${_css.stopsButtonTabLastClass} ${_css.stopsPressedButtonClass}" data-dojo-attach-point\x3d"_useKilometersNode"\x3e${_i18n.widgets.directions.units.KILOMETERS.abbr}\x3c/div\x3e\r\n                        \x3cdiv class\x3d"${_css.clearClass}"\x3e\x3c/div\x3e\r\n                    \x3c/div\x3e\r\n                    \x3cdiv class\x3d"${_css.clearClass}"\x3e\x3c/div\x3e\r\n                \x3c/div\x3e\r\n                \x3cdiv class\x3d"${_css.clearClass}"\x3e\x3c/div\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv class\x3d"${_css.stopsGetDirectionsContainerClass}"\x3e\r\n                \x3cdiv tabindex\x3d"0" role\x3d"button" class\x3d"${_css.stopsButtonClass} ${_css.stopsGetDirectionsClass}" data-dojo-attach-point\x3d"_getDirectionsButtonNode"\x3e${_i18n.widgets.directions.getDirections}\x3c/div\x3e\r\n                \x3cdiv tabindex\x3d"0" role\x3d"button" class\x3d"${_css.linkButtonClass} ${_css.stopsClearDirectionsClass}" data-dojo-attach-point\x3d"_clearDirectionsButtonNode"\x3e${_i18n.widgets.directions.clearDirections}\x3c/div\x3e\r\n                \x3cdiv class\x3d"${_css.clearClass}"\x3e\x3c/div\x3e\r\n            \x3c/div\x3e\r\n    \t\x3c/div\x3e\r\n    \t\x3cdiv class\x3d"${_css.clearClass}"\x3e\x3c/div\x3e\r\n    \t\x3cdiv data-dojo-attach-point\x3d"_errorNode" role\x3d"presentation"\x3e\x3c/div\x3e\r\n    \t\x3cdiv class\x3d"${_css.resultsContainerClass}" role\x3d"presentation"\x3e\r\n        \t\x3cdiv class\x3d"${_css.routesContainerClass}" data-dojo-attach-point\x3d"_resultsNode" role\x3d"presentation"\x3e\x3c/div\x3e\r\n    \t\x3c/div\x3e\r\n    \x3c/div\x3e\r\n\x3c/div\x3e'}});
define("esri/dijit/Directions","require dojo/_base/declare dojo/_base/lang dojo/_base/kernel dojo/_base/array dojo/_base/Color dijit/a11yclick dijit/_TemplatedMixin dijit/form/Select dojo/store/Memory dojo/data/ObjectStore dojo/keys dojo/has dojo/on dojo/mouse dojo/dom dojo/dom-geometry dojo/dom-style dojo/dom-class dojo/dom-attr dojo/query dojo/number dojo/i18n!../nls/jsapi dojo/text!./templates/Directions.html ./Search dojo/dom-construct dojo/promise/all dojo/Deferred dojo/dnd/Source ../kernel ../graphic ../units ../InfoTemplate ../SpatialReference ../layers/ArcGISDynamicMapServiceLayer ../geometry/webMercatorUtils ../geometry/geodesicUtils ../arcgis/utils ../geometry/Point ../geometry/Extent ../geometry/Polyline ../geometry/mathUtils ../symbols/PictureMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/TextSymbol ../symbols/Font ./_EventedWidget ../tasks/FeatureSet ../tasks/RouteTask ../tasks/RouteParameters ../tasks/GeometryService ../tasks/DistanceParameters ../tasks/PrintTask ../tasks/PrintParameters ../tasks/PrintTemplate ../toolbars/edit ../config ../tasks/ProjectParameters dojo/uacss".split(" "),
function(u,F,d,O,s,J,v,V,P,W,X,C,Y,l,D,G,Z,w,n,x,B,K,f,$,Q,t,H,p,aa,ba,y,q,R,S,ca,E,da,ea,L,fa,M,ga,z,T,ha,I,ia,ja,ka,la,N,ma,na,oa,pa,U,qa,ra){F=F("esri.dijit.Directions",[ia,V],{templateString:$,mapClickActive:!1,_eventMap:{activate:!0,deactivate:!1,load:!0,"directions-start":!0,"directions-finish":["result"],"directions-clear":!0,"segment-select":["graphic"],"segment-highlight":["graphic"],error:["error"],"stops-update":["stops"]},_emptyStop:{name:""},constructor:function(b,a){this._i18n=f;this._css=
{widgetContainerClass:"esriDirectionsContainer",stopsContainerClass:"esriStopsContainer",reverseStopsClass:"esriStopsReverse",addStopsClass:"esriStopsAdd",stopsClass:"esriStops",stopsRemovableClass:"esriStopsRemovable",stopsButtonContainerClass:"esriStopsButtons",stopsOptionsButtonClass:"esriStopsOptionsButton",stopsAddDestinationClass:"esriStopsAddDestination",stopsAddDestinationBtnClass:"esriStopsAddDestinationBtn",stopsGetDirectionsContainerClass:"esriStopsGetDirectionsContainer",stopsGetDirectionsClass:"esriStopsGetDirections",
stopsClearDirectionsClass:"esriStopsClearDirections",stopsInnerGeocoderClass:"esriInnerGeocoder",stopsOptionsOptionsEnabledClass:"esriStopsOptionsEnabled",stopsOptionsMenuClass:"esriStopsOptionsMenu",stopsFindOptimalOrderClass:"esriFindOptimalOrderOption",stopsUseTrafficClass:"esriUseTrafficOption",stopsReturnToStartClass:"esriReturnToStartOption",stopsOptionsCheckboxesClass:"esriOptionsCheckboxes",stopsOptionsToggleContainerClass:"esriOptionsToggleContainer",stopsOptionsUnitsContainerClass:"esriOptionsUnitsContainer",
stopsOptionsUnitsMiClass:"esriOptionsUnitsMi",stopsOptionsUnitsKmClass:"esriOptionsUnitsKm",stopsOptionsImpedanceContainerClass:"esriOptionsImpedanceContainer",stopsOptionsImpedanceTimeClass:"esriOptionsImpedanceTime",stopsOptionsImpedanceDistanceClass:"esriOptionsImpedanceDistance",stopClass:"esriStop",stopOriginClass:"esriStopOrigin",stopDestinationClass:"esriStopDestination",stopUnreachedFirstOrLastClass:"esriStopUnreachedFirstOrLast",stopUnreachedClass:"esriStopUnreached",esriStopGeocoderColumnClass:"esriStopGeocoderColumn",
esriStopReverseColumnClass:"esriStopReverseColumn",stopDnDHandleClass:"esriStopDnDHandle",stopDnDHandleClassHidden:"esriStopDnDHandleHidden",stopIconColumnClass:"esriStopIconColumn",stopIconClass:"esriStopIcon",stopIconRemoveColumnClass:"esriStopIconRemoveColumn",stopIconRemoveClass:"esriStopIconRemove",stopIconRemoveClassHidden:"esriStopIconRemoveHidden",resultsContainerClass:"esriResultsContainer",resultsLoadingClass:"esriResultsLoading",resultsPrintClass:"esriResultsPrint",resultsSummaryClass:"esriResultsSummary",
resultsViewFullRouteClass:"esriResultsViewFullRoute",resultsRouteNameClass:"esriResultsRouteName",resultsRouteButtonContainerClass:"esriResultsButtonsContainer",routesContainerClass:"esriRoutesContainer",routesClass:"esriRoutes",routesErrorClass:"esriRoutesError",routeClass:"esriRoute",routeTextColumnClass:"esriRouteTextColumn",routeTextClass:"esriRouteText",routeLengthClass:"esriRouteLength",routeOriginClass:"esriDMTStopOrigin",routeDestinationClass:"esriDMTStopDestination",routeLastClass:"esriDMTStopLast",
routeInfoClass:"esriRouteInfo",routeIconColumnClass:"esriRouteIconColumn",routeIconClass:"esriRouteIcon",infoWindowRouteClass:"esriInfoWindowRoute",routeZoomClass:"esriRouteZoom",esriPrintPageClass:"esriPrintPage",esriPrintBarClass:"esriPrintBar",esriPrintButtonClass:"esriPrintButton",esriCloseButtonClass:"esriCloseButton",esriPrintMainClass:"esriPrintMain",esriPrintHeaderClass:"esriPrintHeader",esriPrintLogoClass:"esriPrintLogo",esriPrintMapClass:"esriPrintMap",esriPrintNameClass:"esriPrintName",
esriPrintNotesClass:"esriPrintNotes",esriPrintLengthClass:"esriPrintLength",esriPrintDirectionsClass:"esriPrintDirections",esriPrintFooterClass:"esriPrintFooter",esriPrintStopLabelClass:"esriPrintStopLabel",clearClass:"esriClear",dndDragBodyClass:"esriDndDragDirection",stopsButtonClass:"esriDirectionsButton",stopsButtonTabClass:"esriDirectionsTabButton",stopsButtonTabLastClass:"esriDirectionsTabLastButton",stopsPressedButtonClass:"esriDirectionsPressedButton",linkButtonClass:"esriLinkButton",activateButtonClass:"esriActivateButton",
travelModesContainerClass:"esriTravelModesContainer",searchSourceContainerClass:"esriSearchSourceContainer"};this.options={map:null,autoSolve:!0,minStops:2,maxStops:20,theme:"simpleDirections",alphabet:"1234567890",directions:null,returnToStart:!1,optimalRoute:!1,routeTaskUrl:location.protocol+"//route.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World",printTaskUrl:location.protocol+"//utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task",
geometryTaskUrl:location.protocol+"//utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",routeParams:{},stops:["",""],searchOptions:{},stopsInfoTemplate:new R(f.widgets.directions.stop,"${address}${error}"),segmentInfoTemplate:new R(f.widgets.directions.maneuver,'\x3cdiv class\x3d"${maneuverType}"\x3e\x3cdiv class\x3d"'+this._css.routeIconClass+" "+this._css.infoWindowRouteClass+'"\x3e\x3cstrong\x3e${step}.\x3c/strong\x3e ${formattedText}\x3c/div\x3e\x3c/div\x3e'),textSymbolFont:new I("11px",
I.STYLE_NORMAL,I.VARIANT_NORMAL,I.WEIGHT_NORMAL,"Arial, Helvetica, sans-serif"),textSymbolColor:new J([255,255,255]),textSymbolOffset:{x:0,y:10.875},fromSymbol:(new z({url:u.toUrl("./images/Directions/greenPoint.png"),height:21.75,width:15.75,type:"esriPMS"})).setOffset(0,10.875),fromSymbolDrag:(new z({url:u.toUrl("./images/Directions/greenPointMove.png"),height:21.75,width:15.75,type:"esriPMS"})).setOffset(0,10.875),stopSymbol:(new z({url:u.toUrl("./images/Directions/bluePoint.png"),height:21.75,
width:15.75,type:"esriPMS"})).setOffset(0,10.875),stopSymbolDrag:(new z({url:u.toUrl("./images/Directions/bluePointMove.png"),height:21.75,width:15.75,type:"esriPMS"})).setOffset(0,10.875),toSymbol:(new z({url:u.toUrl("./images/Directions/redPoint.png"),height:21.75,width:15.75,type:"esriPMS"})).setOffset(0,10.875),toSymbolDrag:(new z({url:u.toUrl("./images/Directions/redPointMove.png"),height:21.75,width:15.75,type:"esriPMS"})).setOffset(0,10.875),unreachedSymbol:(new z({url:u.toUrl("./images/Directions/grayPoint.png"),
height:21.75,width:15.75,type:"esriPMS"})).setOffset(0,10.875),unreachedSymbolDrag:(new z({url:u.toUrl("./images/Directions/grayPointMove.png"),height:21.75,width:15.75,type:"esriPMS"})).setOffset(0,10.875),routeSymbol:(new T).setColor(new J([0,69,117,1])).setWidth(4),segmentSymbol:(new T).setColor(new J([0,122,194,1])).setWidth(8),printPage:"",printTemplate:"",autoCenterAtSegmentStart:!0,focusOnNewStop:!0,dragging:!0,canModifyStops:!0,directionsLengthUnits:null,directionsLanguage:null,traffic:!1,
trafficLayer:null,showPrintPage:!0,showSegmentPopup:!0,showSegmentHighlight:!0,showReverseStopsButton:!0,showReturnToStartOption:!0,showOptimalRouteOption:!0,showTravelModesOption:!0,showMilesKilometersOption:!0,showClearButton:!1,showActivateButton:!0};this.defaults=d.mixin({},this.options,b);this._sortId="_dndId_"+this.id;this._stopReference="_dndStop_"+this.id;this.domNode=a},postCreate:function(){this.inherited(arguments);this.own(l(this._activateButtonNode,v,d.hitch(this,function(){this.mapClickActive?
this.deactivate():this.activate()})));this.own(l(this._addDestinationNode,v,d.hitch(this,this._addStopButton)));this.own(l(this._optionsButtonNode,v,d.hitch(this,this._toggleOptionsMenu)));this.own(l(this._findOptimalOrderNode,v,d.hitch(this,this._toggleCheckbox)));this.own(l(this._returnToStartNode,v,d.hitch(this,this._toggleCheckbox)));this.own(l(this._useTrafficNode,v,d.hitch(this,this._toggleCheckbox)));this.own(l(this._useMilesNode,v,d.hitch(this,this._toggleUnits)));this.own(l(this._useKilometersNode,
v,d.hitch(this,this._toggleUnits)));this.own(l(this._getDirectionsButtonNode,v,d.hitch(this,this.getDirections)));this.own(l(this._clearDirectionsButtonNode,v,d.hitch(this,function(){this.clearDirections();this.onDirectionsClear()})));this._setWidgetProperties();this._activate(this.mapClickActive)},startup:function(){this.inherited(arguments);return this._enqueue(this._init)},destroy:function(){this._disconnectEvents();t.empty(this.domNode);this.inherited(arguments)},activate:function(){return this._enqueue(function(){this.set("mapClickActive",
!0)})},deactivate:function(){return this._enqueue(function(){this.set("mapClickActive",!1)})},clearDirections:function(){return this._enqueue(function(){this.clearErrors();return this._clearDirections()})},reset:function(){return this._enqueue(this._reset)},onActivate:function(){},onDeactivate:function(){},onLoad:function(){},onDirectionsStart:function(){this._clearDisplayBeforeSolve();this.set("solving",!0);this._showLoadingSpinner(!0)},onDirectionsFinish:function(){this._showLoadingSpinner(!1);
this.set("solving",!1)},onDirectionsClear:function(){},onSegmentSelect:function(){},onSegmentHighlight:function(){},onStopsUpdate:function(){},onError:function(){},removeStops:function(){return this.reset()},removeStop:function(b){return this._enqueue(function(){this.clearErrors();return this._removeStop(b)})},updateStops:function(b){return this._enqueue(function(){return this._updateStops(b)})},addStops:function(b,a){return this._enqueue(function(){return this._addStops(b,a)})},addStop:function(b,
a){return this._enqueue(function(){return this._addStop(b,a)})},updateStop:function(b,a){return this._enqueue(function(){return this._updateStop(b,a)})},clearErrors:function(){this.errors=[];this._errorNode&&(this._errorNode.innerHTML="")},getDirections:function(){return this._enqueue(function(){return this._getDirections().then(d.hitch(this,function(){this.zoomToFullRoute()}))})},unhighlightSegment:function(){this.get("map")&&(this.get("map").graphics&&this.get("showSegmentHighlight"))&&(this.get("map").graphics.remove(this._segmentGraphic),
this._segmentGraphic=null)},highlightSegment:function(b){"undefined"===typeof b&&(b=0);b=this.get("directions").features[b];var a=new M(b.geometry),c=a.getPoint(0,0),e=a.getPoint(0,1);ga.getLength(c,e)||(a=c);this.unhighlightSegment();(this._segmentGraphic=new y(a,this.get("segmentSymbol"),b.attributes,this.get("segmentInfoTemplate")))&&this.get("map")&&this.get("map").graphics&&this.get("showSegmentHighlight")&&this.get("map").graphics.add(this._segmentGraphic)},zoomToSegment:function(b){"undefined"===
typeof b&&(b=0);if(this.get("map")){var a=this.get("directions").features[b],c=(new M(a.geometry)).getExtent(),c=this.get("map").setExtent(c,!0);c.then(d.hitch(this,function(){this._showSegmentPopup(a,b)}));return c.promise}return null},centerAtSegmentStart:function(b){"undefined"===typeof b&&(b=0);if(this.get("map")){var a=this.get("directions").features[b],c=a.geometry.getPoint(0,0);this.get("map").centerAt(c).then(d.hitch(this,function(){this._showSegmentPopup(a,b)}))}},zoomToFullRoute:function(){return this.get("map")&&
this.get("directions")?(this._clearInfoWindow(),this.unhighlightSegment(),this.get("map").setExtent(this.get("directions").extent,!0)):null},setListIcons:function(){var b,a=this._dnd.getAllNodes();for(b=0;b<a.length;b++){var c=B("."+this._css.stopIconClass,a[b])[0];c&&(c.innerHTML=this._getLetter(b));n.remove(a[b],this._css.stopOriginClass+" "+this._css.stopDestinationClass+" "+this._css.stopUnreachedClass+" "+this._css.stopUnreachedFirstOrLastClass);c=this.stopGraphics&&this.stopGraphics[b]&&this.stopGraphics[b].attributes?
this.stopGraphics[b].attributes.Status:void 0;c=0<c&&6>c;0===b?n.add(a[b],c?this._css.stopUnreachedFirstOrLastClass:this._css.stopOriginClass):b===a.length-1&&!this._startReturn?n.add(a[b],c?this._css.stopUnreachedFirstOrLastClass:this._css.stopDestinationClass):c&&n.add(a[b],this._css.stopUnreachedClass)}b=B("[data-reverse-td]",this._dndNode)[0];t.destroy(b);this.get("showReverseStopsButton")&&t.create("td",{"data-reverse-td":"true",rowspan:a.length,className:this._css.esriStopReverseColumnClass,
innerHTML:'\x3cdiv role\x3d"button" class\x3d"'+this._css.reverseStopsClass+'" data-reverse-stops\x3d"true" title\x3d"'+f.widgets.directions.reverseDirections+'"\x3e\x3c/div\x3e',onmouseover:function(a){a.stopPropagation()},onmouseout:function(a){a.stopPropagation()}},a[0])},addRouteSymbols:function(){if(this.stopGraphics.length&&this.get("map")&&this.get("map").graphics)for(var b=0;b<this.stopGraphics.length;b++)if(this.stopGraphics[b]){this.get("map").graphics.add(this.stopGraphics[b]);var a=this.stopGraphics[b].getDojoShape();
a&&a.moveToFront();this.get("map").graphics.add(this.textGraphics[b]);(a=this.textGraphics[b].getDojoShape())&&a.moveToFront()}},createRouteSymbols:function(){this._clearStopGraphics();for(var b=this.get("stops"),a=0;a<b.length;a++){var c=b[a];if(c&&c.feature){var e=c.feature.attributes?c.feature.attributes.Status:void 0,d=this._setStopSymbol(a,b.length+(this._startReturn?1:0),!1,e),m=this._defaultSR;this.get("map")&&(m=this.get("map").spatialReference);var m=new L(c.feature.geometry.x,c.feature.geometry.y,
m),g=this._getLetter(a),g=new ha(g,this.get("textSymbolFont"),this.get("textSymbolColor"));this.get("textSymbolOffset")&&g.setOffset(this.get("textSymbolOffset").x,this.get("textSymbolOffset").y);g=new y(m,g);g._textGraphic=!0;g._index=a;var k=c.feature.attributes,c=new y(m,d,{address:c.name,Status:void 0===e?0:e,SourceID:k&&k.SourceID?k.SourceID:null,SourceOID:k&&k.SourceOID?k.SourceOID:null,PosAlong:k&&k.PosAlong?k.PosAlong:null,SideOfEdge:k&&k.SideOfEdge?k.SideOfEdge:null},this.get("stopsInfoTemplate"));
c._drag=!0;c._index=a;this.stopGraphics[a]=c;this.textGraphics[a]=g}}this.set("stopGraphics",this.stopGraphics);this.set("textGraphics",this.textGraphics);this.addRouteSymbols();this.setListIcons()},setTravelMode:function(b){return this._enqueue(function(){this.clearErrors();this._travelModeSelector.setValue(b);return this._setTravelMode(b)})},getSupportedTravelModeNames:function(){var b=[],a=this.serviceDescription;if(a&&a.supportedTravelModes&&a.supportedTravelModes.length)for(var a=a.supportedTravelModes,
c=0;c<a.length;c++)b.push(a[c].name);return b},setDirectionsLengthUnits:function(){var b=1===arguments.length?arguments[0]:this.get("directionsLengthUnits");return this._enqueue(function(){this.clearErrors();return this._setDirectionsLengthUnits(b)})},setDirectionsLanguage:function(){var b=1===arguments.length?arguments[0]:this.get("directionsLanguage");return this._enqueue(function(){this.clearErrors();return this._setDirectionsLanguage(b)})},useMyCurrentLocation:function(b){return this._enqueue(function(){this.clearErrors();
return this._createLocateButton(this.geocoders[b],!0,!0)})},_reset:function(){var b=this.mapClickActive;this._setWidgetProperties();return this._init().then(d.hitch(this,function(){this.mapClickActive=b;this._searchSourceSelector&&this._searchSourceSelector.setValue("all")}))},_activate:function(){var b=this.get("mapClickActive");this._addStopOnMapClickListener&&this._addStopOnMapClickListener.remove();b?(this.map&&(this.map.activeDirectionsWidget&&this.map.activeDirectionsWidget!==this&&this.map.activeDirectionsWidget.deactivate(),
this.map.activeDirectionsWidget=this,this._addStopOnMapClickListener=l(this.map,"click",d.hitch(this,function(a){this.addStop(new y(a.mapPoint))}))),n.add(this._activateButtonNode,this._css.stopsPressedButtonClass),this.onActivate()):(n.remove(this._activateButtonNode,this._css.stopsPressedButtonClass),this.onDeactivate());this.emit("map-click-active",{mapClickActive:this.mapClickActive})},_destroyGeocoders:function(){var b=this.get("geocoders");if(b&&b.length)for(var a=0;a<b.length;a++)b[a]&&b[a].destroy();
this.set("geocoders",[])},_disconnectEvents:function(){var b=this._clearDirections(!0),a;if(this._watchEvents&&this._watchEvents.length)for(a=0;a<this._watchEvents.length;a++)this._watchEvents[a].unwatch();if(this._onEvents&&this._onEvents.length)for(a=0;a<this._onEvents.length;a++)this._onEvents[a].remove();if(this._geocoderFindEvents&&this._geocoderFindEvents.length)for(a=0;a<this._geocoderFindEvents.length;a++)this._geocoderFindEvents[a].remove();if(this._geocoderWatchEvents&&this._geocoderWatchEvents.length)for(a=
0;a<this._geocoderWatchEvents.length;a++)this._geocoderWatchEvents[a].value.unwatch();if(this._geocoderSelectEvents&&this._geocoderSelectEvents.length)for(a=0;a<this._geocoderSelectEvents.length;a++)this._geocoderSelectEvents[a].remove();this._onEvents=[];this._watchEvents=[];this._geocoderSelectEvents=[];this._geocoderFindEvents=[];this._geocoderWatchEvents=[];this._disconnectResults();this._destroyGeocoders();this._destroyGlobalGeocoder();this._destroyDnD();return b},_getDirections:function(){this._removeEmptyStops();
var b=new p;this._calculateValidStops()>=this.get("minStops")?(this.onDirectionsStart(),this.clearErrors(),this._dnd.sync(),this._sortGeocoders(),this._getCandidates(this.get("stops")).then(d.hitch(this,function(a){this.stops=a;this._setStops();var c=this._validateStops(a);c.error?(a=f.widgets.directions.error.locator,(c=this.get("geocoders")[c.index])&&(a=f.widgets.directions.error.unknownStop.replace("\x3cname\x3e",c.get("value"))),this._resultError(a),this.set("directions",null),this._clearRouteGraphics(),
b.reject(a),this.onDirectionsFinish(Error([a]))):this._configureRoute().always(d.hitch(this,function(a){b.resolve(a)}))}),d.hitch(this,function(a){this.set("directions",null);this._clearRouteGraphics();b.reject(a);this.onDirectionsFinish(a)}))):this._clearDirections(!0).always(d.hitch(this,function(){this.createRouteSymbols();b.reject(f.widgets.directions.error.notEnoughStops)}));return b.promise},_clearDirections:function(){var b=new p;this.get("routeParams")&&this.get("routeParams").stops?this.get("routeParams").stops.features.length?
(this.get("routeParams").stops.features=[],b.resolve()):arguments.length?b.resolve():this._reset().then(b.resolve,b.reject):b.resolve();this.set("directions",null);this._clearDisplayBeforeSolve();this._clearDisplayAfterSolve();this._removeTrafficLayer();return b.promise},_setTravelMode:function(b){var a=new p,c=this.serviceDescription,e,d;if(c&&c.supportedTravelModes&&c.supportedTravelModes.length){d=c.supportedTravelModes;c=!1;for(e=0;e<d.length;e++)if(d[e].name===b){c=!0;if(!this.routeParams.travelMode||
this.routeParams.travelMode&&this.routeParams.travelMode.name!==b){this.routeParams.travelMode=d[e].impedanceAttributeName?d[e]:d[e].itemId;for(e=0;e<this.stops.length;e++)this.stops[e].feature&&(d=this.stops[e].feature.attributes,d.SourceID=null,d.SourceOID=null,d.PosAlong=null,d.SideOfEdge=null);this._solveAndZoom().always(function(){a.resolve(b)})}else a.resolve(b);this._updateTrafficCheckbox();break}c||a.reject(b)}else a.reject(b);return a.promise},_updateTrafficCheckbox:function(){if(this.serviceDescription){for(var b=
this.routeParams.travelMode,a=this.routeParams.impedanceAttribute,c=this.serviceDescription.impedance,b=b?b.impedanceAttributeName:a?a:c,a=this.serviceDescription.networkDataset.networkAttributes,c=!1,e=0;e<a.length;e++)if(a[e].name===b){c=void 0!==a[e].trafficSupport&&"esriNTSNone"!==a[e].trafficSupport||void 0===a[e].trafficSupport&&"TravelTime"===b;break}this._useTrafficNode.disabled=!c;this._useTrafficNode.checked=this._useTrafficNode.checked&&c;c||this._removeTrafficLayer()}},_setDirectionsLengthUnits:function(b){var a=
new p;n.remove(this._useMilesNode,this._css.stopsPressedButtonClass);n.remove(this._useKilometersNode,this._css.stopsPressedButtonClass);b===q.KILOMETERS?n.add(this._useKilometersNode,this._css.stopsPressedButtonClass):b===q.MILES&&n.add(this._useMilesNode,this._css.stopsPressedButtonClass);b===q.KILOMETERS||b===q.METERS||b===q.MILES||b===q.FEET||b===q.NAUTICAL_MILES?(this.directionsLengthUnits=b,this.autoSolve?this._getDirections().always(function(){a.resolve(b)}):a.resolve(b)):a.reject(b);return a.promise},
_setDirectionsLanguage:function(b){var a=new p;b=this._setDirectionsLanguageByLocale(b);this.autoSolve?this._getDirections().always(function(){a.resolve(b)}):a.resolve(b);return a.promise},_showLoadingSpinner:function(b){void 0===b&&(b=this._requestQueueTail&&!this._requestQueueTail.isFulfilled());b?n.add(this._widgetContainer,this._css.resultsLoadingClass):n.remove(this._widgetContainer,this._css.resultsLoadingClass)},_enqueue:function(b){var a=new p;this._requestQueueTail||(this._requestQueueTail=
new p,this._requestQueueTail.resolve());this._requestQueueTail.promise.always(d.hitch(this,function(){try{var c=b.call(this);c&&"object"===typeof c&&c.hasOwnProperty("isFulfilled")?c.then(d.hitch(this,function(b){a.resolve(b);this._showLoadingSpinner()}),d.hitch(this,function(b){a.reject(b);this._showLoadingSpinner()})):(a.resolve(c),this._showLoadingSpinner())}catch(e){a.reject(e),this._showLoadingSpinner()}}));this._requestQueueTail=a;this._showLoadingSpinner();return a.promise},_createDnD:function(){this._dnd=
new aa(this._dndNode,{skipForm:!0,withHandles:!0})},_destroyDnD:function(){t.empty(this._dndNode);this._dnd&&(this._dnd.destroy(),this._dnd=null)},_usingAGOL:function(){return-1<this.get("routeTaskUrl").search(/^(https?:)*\/\/route*[^.]*\.arcgis\.com.*$/i)},_setSearchOptions:function(){var b={map:this.get("map"),autoNavigate:!1,enableInfoWindow:!1,enableHighlight:!1,enableSourcesMenu:!1};this.searchOptions=d.mixin({maxResults:1,locationToAddressDistance:100},this.defaults.searchOptions,b)},_setDefaultUnits:function(){if(this.get("directionsLengthUnits"))this.setDirectionsLengthUnits(this.directionsLengthUnits);
else{var b="EN-US"===O.locale.toUpperCase()?q.MILES:q.KILOMETERS;this.defaults.directionsLengthUnits&&(b=this.defaults.directionsLengthUnits);this.set("directionsLengthUnits",b)}},_setTrafficOptions:function(){this.set("showTrafficOption",(this.defaults.showTrafficOption||!this.defaults.hasOwnProperty("showTrafficOption"))&&("esriNTSHistoricalAndLive"===this.serviceDescription.trafficSupport||"esriNTSHistorical"===this.serviceDescription.trafficSupport||"esriNTSLive"===this.serviceDescription.trafficSupport));
this._usingAGOL()&&this.get("showTrafficOption")&&(this.get("trafficLayer")||this.set("trafficLayer",new ca(location.protocol+"//traffic.arcgis.com/arcgis/rest/services/World/Traffic/MapServer",{opacity:0.4})));this._optionsMenu()},_updateCanModifyStops:function(){this.get("canModifyStops")?this._showAddDestination():this._hideAddDestination()},_setWidgetProperties:function(){this._disconnectEvents();this.set("loaded",!1);this.set(this.defaults);this.set("stops",[]);this._defaultSR=new S(4326);this._updateCanModifyStops()},
_updateStops:function(b){var a=new p;b?this.get("loaded")?this._reset().then(d.hitch(this,function(){this._addStops(b).then(a.resolve,a.reject)}),a.reject):this._addStops(b).then(a.resolve,a.reject):a.reject();return a.promise},_removeStop:function(b){var a=new p;if(0>b||b>=this.stops.length)return a.reject(),a.promise;var c;if(this.stops.length>this.get("minStops")){"undefined"===typeof b&&(b=this.stops.length-1);c=this.stops.splice(b,1);this._setStops();var e=this._dnd.getAllNodes()[b],d=this.get("geocoders");
d[b].destroy();d.splice(b,1);this.set("geocoders",d);this._geocoderSelectEvents[e.id].remove();this._geocoderWatchEvents[e.id].value.unwatch();t.destroy(e);this._dnd.sync();this._stopsRemovable();this._optionsMenu();this._checkMaxStops();this.setListIcons();this._sortGeocoders()}else if(0<=b){c=this.stops.splice(b,1);for(e=b;e<this.get("minStops")-1;e++)this.geocoders[e].set("value",this.geocoders[e+1].get("value"));this.geocoders[e].set("value","")}this._solveAndZoom().always(function(){a.resolve(c,
b)});return a.promise},_removeTrafficLayer:function(){var b=this.get("trafficLayer"),a=this.get("map");b&&a&&a.removeLayer(b);this._trafficLayerAdded=!1},_addStops:function(b,a){var c=new p,e=[];this.autoSolve=!1;for(var h=0;h<Math.min(b.length,this.maxStops-this.stopGraphics.length);h++){var m=new p;this._addStop(b[h],void 0===a?h:a+h).always(m.resolve);e.push(m)}H(e).always(d.hitch(this,function(){this.autoSolve=!0;this._getDirections().always(function(){c.resolve(b)})}));return c.promise},_addStop:function(b,
a){var c=new p;this._checkMaxStops();this.maxStopsReached?(this._resultError(f.widgets.directions.error.maximumStops),c.reject(f.widgets.directions.error.maximumStops)):this._getCandidate(b).then(d.hitch(this,function(b){this._insertStop(b,a);this.autoSolve&&b!==this._emptyStop?this._getDirections().always(function(){c.resolve(b,a)}):c.resolve(b,a)}),d.hitch(this,function(a){c.reject(a)}));return c.promise},_removeEmptyStops:function(){if(this.stops.length>this.get("minStops"))for(var b=this.stops.length-
1;this.stops.length>this.get("minStops")&&-1<b;b--){var a=this.stops[b];(!a||!a.name)&&this._removeStop(b)}},_setReverseGeocode:function(b,a,c){if(b.feature.geometry&&-1<c){var e={address:b.name};this.stopGraphics[c]&&(this.stopGraphics[c].setAttributes(e),this.stopGraphics[c].setGeometry(a));this.textGraphics[c]&&(this.textGraphics[c].setAttributes(e),this.textGraphics[c].setGeometry(a));this.set("stopGraphics",this.stopGraphics);this.set("textGraphics",this.textGraphics);this._moveInProgress||this._unsetDraggableObject(this._dragGraphic);
this.get("geocoders")[c]&&this.get("geocoders")[c].set("value",b.name);this.stops[c]=b;this.stops[c].feature.setGeometry(a);this._setStops();this.autoSolve&&this._getDirections()}},_insertStop:function(b,a){var c,e;if(void 0===a)for(c=0;c<this.geocoders.length;c++){if(!this.geocoders[c].get("value")){e=this.geocoders[c];break}}else c=a,this.geocoders[c]&&!this.geocoders[c].get("value")&&(e=this.geocoders[c]);e&&(void 0===a||a===c)?(e.set("value",b.name),this.stops[c]=b,e[this._stopReference]=b):(void 0===
a&&(a=this.geocoders.length),this._createGeocoder(b,a))},_createGeocoder:function(b,a){var c=this._dnd.getAllNodes(),e=!1,h=!1,m=c.length;c[a]?(h=c[a],e=!0):e=h=!1;var g=d.hitch(this,function(a,b){var c=b?this._css.stopDnDHandleClass:this._css.stopDnDHandleClassHidden,e=b?this._css.stopDnDHandleClassHidden:this._css.stopDnDHandleClass;n.replace(a.children[0],c,e);2<this.geocoders.length&&(c=b?this._css.stopIconRemoveClass:this._css.stopIconRemoveClassHidden,e=b?this._css.stopIconRemoveClassHidden:
this._css.stopIconRemoveClass,n.replace(a.children[3].children[0],c,e))}),k=t.create("tr",{className:this._css.stopClass,onmouseover:function(){g(this,!0)},onmouseout:function(){g(this,!1)}});t.create("td",{className:this._css.stopDnDHandleClassHidden+" dojoDndHandle"},k);c=t.create("td",{className:this._css.stopIconColumnClass},k);t.create("div",{className:this._css.stopIconClass+" dojoDndHandle",innerHTML:this._getLetter(m),"data-center-at":"true"},c);m=t.create("td",{className:this._css.esriStopGeocoderColumnClass},
k);m=t.create("div",{},m);this.get("canModifyStops")&&(c=t.create("td",{className:this._css.stopIconRemoveColumnClass},k),t.create("div",{className:this._css.stopIconRemoveClassHidden,role:"button","data-remove":"true"},c));this._dnd.insertNodes(!1,[k],e,h);this.stops.splice(a,0,b);var e=d.mixin({},this.get("searchOptions"),{value:b.name,activeSourceIndex:this._globalGeocoder.activeSourceIndex}),A=new Q(e,m);A[this._sortId]=k.id;A[this._stopReference]=b;A.startup();this.geocoders[this.geocoders.length]=
A;e=A.on("select-result",d.hitch(this,function(a){if(a&&(a.results||a.result)){var b=this._dnd.getAllNodes(),b=s.indexOf(b,k),c=!0;a.results&&a.results.results&&a.results.results.length?(A.set("value",a.results.results[0].name),this.stops[b]=this._toPointGeometry(a.results.results[0]),this._setStops()):a.result?(A.set("value",a.result.name),this.stops[b]=this._toPointGeometry(a.result),this._setStops()):(this._removeStopButton(b),this.set("directions",null),this._resultError(f.widgets.directions.error.unknownStop.replace("\x3cname\x3e",
a.target.get("value"))),this._clearRouteGraphics(),c=!1);c&&this._solveAndZoom()}}));this._geocoderSelectEvents[k.id]=e;e=A.watch("value",d.hitch(this,function(a,b,c){c!==b&&(a=this._dnd.getAllNodes(),a=s.indexOf(a,k),this.stops[a]&&c!==this.stops[a].name&&(this.stops[a]={name:c},this._setStops()))}));this._geocoderWatchEvents[k.id]={value:e};this._checkMaxStops();this.setListIcons();this._stopsRemovable();this._optionsMenu();this._sortGeocoders()},_toPointGeometry:function(b){var a=b.feature.geometry;
if(a)if(a.getCentroid)b.feature.geometry=a.getCentroid();else if(a.getExtent&&(a=a.getExtent()))b.feature.geometry=a.getCenter();return b},_removeLocateButtonVisibilityEvents:function(){for(var b=0;b<this.geocoders.length;b++){var a=this.geocoders[b];a._onMouseEnter&&a._onMouseEnter.remove();a._onMouseOut&&a._onMouseOut.remove();a._onKeyPress&&a._onKeyPress.remove();a._locateButton&&(a._locateButton._onMouseEnter&&a._locateButton._onMouseEnter.remove(),a._locateButton._onMouseOut&&a._locateButton._onMouseOut.remove())}},
_setLocateButtonVisibilityEvents:function(){this._removeLocateButtonVisibilityEvents();for(var b=this,a=function(a){a instanceof FocusEvent?this._geocoder._lbShown_f=!0:this._geocoder._lbShown_g=!0;b._createLocateButton(this._geocoder,!0)},c=function(a){a instanceof FocusEvent?this._geocoder._lbShown_f=!1:this._geocoder._lbShown_g=!1;clearTimeout(this._destroyTimeout);this._destroyTimeout=setTimeout(d.hitch(this,function(){!this._geocoder._lbShown_lb&&!this._geocoder._lbShown_f&&b._destroyLocateButton(this._locateButton)}),
400)},e=function(){this._geocoder._lbShown_g=!0;clearTimeout(this._destroyTimeout);this._destroyTimeout=setTimeout(d.hitch(this,function(){""===this.value?b._createLocateButton(this._geocoder,!0):b._destroyLocateButton(this._locateButton)}),400)},h=function(){this._geocoder._lbShown_lb=!0;clearTimeout(this._geocoder._destroyTimeout)},m=function(){this._geocoder._lbShown_lb=!1;clearTimeout(this._geocoder._destroyTimeout);this._geocoder._destroyTimeout=setTimeout(d.hitch(this,function(){!this._geocoder._lbShown_g&&
!this._geocoder._lbShown_f&&b._destroyLocateButton(this._geocoder.inputNode._locateButton)}),400)},g=0;g<this.geocoders.length;g++){var k=this.geocoders[g];k.inputNode._geocoder=k;k._onMouseEnter=l(k.inputNode,D.enter,a);k._onMouseOut=l(k.inputNode,[D.leave,"blur"],c);k._onKeyPress=l(k.inputNode,"keydown",e);k.inputNode._locateButton&&(k=k.inputNode._locateButton,k._onMouseEnter=l(k.domNode,D.enter,h),k._onMouseOut=l(k.domNode,D.leave,m))}},_createLocateButton:function(b,a,c){var e=new p;b.inputNode._locateButton&&
b.inputNode._locateButton._locating?e.resolve():u(["./LocateButton"],d.hitch(this,function(h){this._destroyLocateButton(b.inputNode._locateButton);if(b){var m=t.create("div",{},b.domNode);n.add(b.domNode,this._css.stopsInnerGeocoderClass);var g=new h({map:this.map,highlightLocation:!1,centerAt:!1,setScale:!1,useTracking:!1},m);g.startup();b.inputNode._locateButton=g;g.domNode._geocoder=b;this._setLocateButtonVisibilityEvents();h=d.hitch(this,function(){g._locating=!0;b.set("value","");b.inputNode.placeholder=
f.widgets.directions.retrievingMyLocation.toUpperCase()});g._onBeforeLocate=l(g._locateNode,v,h);g._onLocate=l(g,"locate",d.hitch(this,function(c){g._locating=!1;c.graphic?(a&&this._destroyLocateButton(b.inputNode._locateButton),this._updateStop(new y(c.graphic.geometry),s.indexOf(this.geocoders,b)).then(d.hitch(this,function(){1<this.stopGraphics.length?this._solveAndZoom().always(function(){e.resolve(c)}):e.resolve(c)}))):(b.set("value",""),b.inputNode.placeholder=f.widgets.directions.myLocationError.toUpperCase(),
console.error(c.error),e.reject(c.error))}));c?(h(),g.locate()):e.resolve()}else e.reject()}));return e.promise},_destroyLocateButton:function(b){if(b){var a=b.domNode._geocoder;clearTimeout(a._destroyTimeout);b._locating?a._destroyTimeout=setTimeout(d.hitch(this,function(){!a._lbShown_lb&&!a._lbShown_f&&this._destroyLocateButton(b)}),100):(b.clear(),b._onBeforeLocate.remove(),b._onLocate.remove(),b._onMouseEnter&&b._onMouseEnter.remove(),b._onMouseOut&&b._onMouseOut.remove(),b.destroy(),a.inputNode&&
(a.inputNode._locateButton=null,a._setPlaceholder(a.activeSourceIndex)))}},_validateStops:function(b){if(b)for(var a=0;a<b.length;a++)if(!b[a]||!b[a].feature)return{error:!0,index:a};return{error:!1}},_sortStops:function(){this.stops.length&&(this.stops.sort(d.hitch(this,function(b,a){for(var c,e,d=0;d<this.get("geocoders").length;d++)this.geocoders[d][this._stopReference]===b?c=d:this.geocoders[d][this._stopReference]===a&&(e=d);return c>e?1:e>c?-1:0})),this._setStops())},_getCandidate:function(b){var a=
new p,c=typeof b;b?"object"===c&&b.hasOwnProperty("feature")&&b.hasOwnProperty("name")?(b.name=String(b.name),a.resolve(b)):"object"===c&&b.hasOwnProperty("address")&&b.hasOwnProperty("location")?(b=this._globalGeocoder._hydrateResult(b),a.resolve(b)):"object"===c&&b.hasOwnProperty("name")&&(null===b.name||""===b.name)?a.resolve(this._emptyStop):("object"===c&&b.hasOwnProperty("name")&&(b=String(b.name)),this._reverseGeocode(b).then(a.resolve,a.reject)):a.resolve(this._emptyStop);return a.promise},
_reverseGeocode:function(b){var a=new p,c,e=b.geometry?b.geometry:b;if(this._globalGeocoder){var h=d.hitch(this,function(a){var b=new p,c=500;if(this.map){var d=this.map.toScreen(e);d.x+=ea._calculateClickTolerance([a]);this.map.spatialReference.isWebMercator()?(c=Math.abs(this.map.toMap(d).x-e.x),b.resolve(c)):4326===this.map.spatialReference.wkid?(c=Math.abs(E.geographicToWebMercator(this.map.toMap(d)).x-E.geographicToWebMercator(e).x),b.resolve(c)):this._geometryService&&(a=new ma,a.distanceUnit=
N.UNIT_METER,a.geometry1=e,a.geometry2=this.map.toMap(d),this._geometryService.distance(a,function(a){c=a;b.resolve(c)},function(){b.resolve(c)}))}return b.promise}),m=[],g=this._globalGeocoder.sources,k=function(){g[c].featureLayer&&m.push(h(g[c].featureLayer).then(d.hitch(g[c],function(a){this.searchQueryParams=d.mixin(this.searchQueryParams,{distance:a})})))};if("all"===this._globalGeocoder.activeSourceIndex)for(c=0;c<g.length;c++)k();else c=this._globalGeocoder.activeSourceIndex,k();H(m).always(d.hitch(this,
function(){this._globalGeocoder.search(e).then(d.hitch(this,function(d){var k=!1;if(d){var g=null,h;for(c=0;c<this._globalGeocoder.sources.length;c++)if(d[c]&&d[c].length){h=d[c];break}if(h.length&&(k=!0,g=h[0],this._globalGeocoder.sources[c].featureLayer)){d=Number.POSITIVE_INFINITY;for(c=0;c<h.length;c++){h[c]=this._toPointGeometry(h[c]);var m=da.geodesicLengths([new M({paths:[[E.xyToLngLat(e.x,e.y),E.xyToLngLat(h[c].feature.geometry.x,h[c].feature.geometry.y)]],spatialReference:{wkid:this.map.spatialReference.wkid}})],
"esriMeters")[0];d>m&&(d=m,g=h[c])}}g&&""!==g.name&&null!==g.name&&void 0!==g.name?(g.name=String(g.name),!isNaN(e.x)&&!isNaN(e.y)&&this.map.spatialReference.wkid===e.spatialReference.wkid?(g.feature.geometry=e,a.resolve(g)):!g.feature.geometry||isNaN(g.feature.geometry.x)||isNaN(g.feature.geometry.y)?(this._resultError(f.widgets.directions.error.locator),a.reject(f.widgets.directions.error.locator)):a.resolve(g)):k=!1}k||(b instanceof L?b=new y(b):b instanceof Array&&(b=new y(new L(b[0],b[1]))),
b instanceof y?this._decorateUngeocodedStop(b).then(a.resolve,a.reject):(this._resultError(f.widgets.directions.error.unknownStop.replace("\x3cname\x3e",b.toString())),a.reject(f.widgets.directions.error.unknownStop.replace("\x3cname\x3e",b.toString()))))}))}))}else this._resultError(f.widgets.directions.error.locatorUndefined),a.reject(f.widgets.directions.error.locatorUndefined);return a.promise},_updateStopInsert:function(b,a){this.get("geocoders")[a]&&(this.get("geocoders")[a].set("value",b.name),
this.stops[a]=b,this._setStops())},_updateStop:function(b,a){var c=new p;this.stops?("undefined"===typeof a&&(a=this.stops.length-1),this._getCandidate(b).then(d.hitch(this,function(b){this._updateStopInsert(b,a);c.resolve(b)}),d.hitch(this,function(a){c.reject(a)}))):c.reject("could not update stop");return c.promise},_renderDirections:function(){var b=this.get("directions"),a="";if(this._resultsNode){a+='\x3cdiv class\x3d"'+this._css.resultsRouteNameClass+'"\x3e';a+=b.routeName;a+="\x3c/div\x3e";
a+='\x3cdiv class\x3d"'+this._css.clearClass+'"\x3e\x3c/div\x3e';if(b.totalLength||b.totalTime){var c=this._formatDistance(b.totalLength,!0),e=this._formatTime(b.totalTime),a=a+('\x3cdiv class\x3d"'+this._css.resultsSummaryClass+'"\x3e');c&&(a+=c);c&&e&&(a+=" \x26middot; ");e&&(a+=e);a+="\x3c/div\x3e"}a+='\x3cdiv class\x3d"'+this._css.clearClass+'"\x3e\x3c/div\x3e';a+='\x3cdiv class\x3d"'+this._css.resultsRouteButtonContainerClass+'"\x3e';a+='\x3cdiv tabindex\x3d"0" role\x3d"button" class\x3d"'+this._css.linkButtonClass+
" "+this._css.resultsViewFullRouteClass+'" data-full-route\x3d"true"\x3e'+f.widgets.directions.viewFullRoute+"\x3c/div\x3e";this.get("showPrintPage")&&(a+='\x3cdiv tabindex\x3d"0" role\x3d"button" title\x3d"'+f.widgets.directions.print+'" class\x3d"'+this._css.resultsPrintClass+'" data-print-directions\x3d"true"\x3e\x3c/div\x3e');var a=a+('\x3cdiv class\x3d"'+this._css.clearClass+'"\x3e\x3c/div\x3e'),a=a+"\x3c/div\x3e",a=a+('\x3cdiv class\x3d"'+this._css.routesClass+'"\x3e'),a=a+('\x3ctable summary\x3d"'+
b.routeName+'"\x3e'),a=a+'\x3ctbody role\x3d"menu"\x3e',h=function(a,b,c){for(var d=0;d<a.length;d++){var e=a[d].feature.attributes;if(e&&e.Sequence===b)return 0===e.Status||6===e.Status?b:h(a,b+1)}return c?1:h(a,1,!0)},m=h(this.stops,1);s.forEach(b.features,d.hitch(this,function(c,e){var d=this._css.routeClass;c.attributes&&(c.attributes.step=e+1);c.attributes.maneuverType&&(d+=" "+c.attributes.maneuverType);0===e&&1===m?d+=" "+this._css.routeOriginClass:e===b.features.length-1&&(d+=" "+this._css.routeDestinationClass);
e===b.features.length-1&&(d+=" "+this._css.routeLastClass);a+='\x3ctr tabindex\x3d"0" role\x3d"menuitem" class\x3d"'+d+" "+this._css.routeZoomClass+'" data-segment\x3d"'+e+'"\x3e';a+='\x3ctd class\x3d"'+this._css.routeIconColumnClass+'"\x3e';a+='\x3cdiv class\x3d"'+this._css.routeIconClass+'"\x3e';"esriDMTDepart"===c.attributes.maneuverType?(m=h(this.stops,m),a+=this._getLetter(m-1),m++):"esriDMTStop"===c.attributes.maneuverType&&(m=h(this.stops,m),a+=this._getLetter(m-1));a+="\x3c/div\x3e";a+="\x3c/td\x3e";
a+='\x3ctd class\x3d"'+this._css.routeTextColumnClass+'"\x3e';a+='\x3cdiv class\x3d"'+this._css.routeInfoClass+'"\x3e';a+='\x3cdiv class\x3d"'+this._css.routeTextClass+'"\x3e';var d=b.strings[e],f;if(d){var l=c.attributes.text;for(f=0;f<d.length;f++)l=this._boldText(l,d[f].string);c.attributes.formattedText=l}else c.attributes.formattedText=c.attributes.text;a+="\x3cstrong\x3e"+K.format(c.attributes.step)+".\x3c/strong\x3e "+c.attributes.formattedText;a+="\x3c/div\x3e";d=this._formatDistance(c.attributes.length,
!1);f=this._formatTime(c.attributes.time);d&&(a+='\x3cdiv class\x3d"'+this._css.routeLengthClass+'"\x3e',a+=d,f&&(a+=" "+f),a+="\x3c/div\x3e");a+="\x3c/div\x3e";a+="\x3c/td\x3e";a+="\x3c/tr\x3e"}));a+="\x3c/tbody\x3e";a+="\x3c/table\x3e";a+="\x3c/div\x3e";this._resultsNode&&(this._resultsNode.innerHTML=a);this._disconnectResults();(c=B("[data-segment]",this._resultsNode))&&c.length&&s.forEach(c,d.hitch(this,function(a){var c=l(a,D.enter,d.hitch(this,function(){var c=parseInt(x.get(a,"data-segment"),
10);this.highlightSegment(c);this.onSegmentHighlight(b.features[c])}));this._resultEvents.push(c);c=l(a,"focusin",d.hitch(this,function(){var c=parseInt(x.get(a,"data-segment"),10);this.highlightSegment(c);this.onSegmentHighlight(b.features[c])}));this._resultEvents.push(c);c=l(a,"focusout",d.hitch(this,function(){this.unhighlightSegment()}));this._resultEvents.push(c);c=l(a,D.leave,d.hitch(this,function(){this.unhighlightSegment()}));this._resultEvents.push(c);this.get("autoCenterAtSegmentStart")&&
(c=l(a,"click, keydown",d.hitch(this,function(c){if(c&&("click"===c.type||"keydown"===c.type&&c.keyCode===C.ENTER))c=parseInt(x.get(a,"data-segment"),10),this.centerAtSegmentStart(c),this.onSegmentSelect(b.features[c])})),this._resultEvents.push(c))}))}},_showRoute:function(b){if(!this._moveInProgress){this.editToolbar.deactivate();this._clearDisplayAfterSolve();this.set("solveResult",b);var a=b.routeResults[0].directions;this.set("directions",a);var c=b.routeResults[0].stops;if(c&&c.length){var e=
[],h,m=c.length;this._startReturn&&m--;for(h=0;h<m;h++){var g=c[h],g={extent:new fa({xmin:g.geometry.x-0.25,ymin:g.geometry.y-0.25,xmax:g.geometry.x+0.25,ymax:g.geometry.y+0.25,spatialReference:g.geometry.spatialReference}),feature:g,name:g.attributes.Name};e.push(g)}this.stops=e;for(h=0;h<this.stops.length;h++)this._updateStop(this.stops[h],h);this._setStops()}this.set("mergedRouteGraphic",new y(a.mergedGeometry,this.get("routeSymbol")));if(this.get("map")&&this.get("map").graphics){var k=[];s.forEach(a.features,
d.hitch(this,function(a){a.setSymbol(this.get("routeSymbol"));this.get("map").graphics.add(a);k.push(a);(a=a.getDojoShape())&&a.moveToBack()}));this.set("displayedRouteGraphics",k)}this.createRouteSymbols();this._renderDirections();this.onDirectionsFinish(b)}},_setGeocodersStopReference:function(){if(this.geocoders)for(var b=0;b<this.geocoders.length;b++)this.geocoders[b]&&this.stops[b]&&(this.geocoders[b][this._stopReference]=this.stops[b])},_setStops:function(){this._setGeocodersStopReference();
this.createRouteSymbols();this._set("stops",this.stops);this.onStopsUpdate(this.stops)},_getCandidates:function(b){var a=[];if(b&&b.length){for(var c=0;c<b.length;c++)a.push(this._getCandidate(b[c]));return H(a)}b=new p;b.resolve([]);return b.promise},_clearResultsHTML:function(){this._resultsNode&&(this._resultsNode.innerHTML="")},_showSegmentPopup:function(b){if(b&&this.get("showSegmentPopup")&&this.get("map")&&this.get("map").infoWindow){var a=b.geometry.getPoint(0,0);b=new y(a,null,b.attributes,
this.get("segmentInfoTemplate"));this.get("map").infoWindow.setFeatures([b]);this.get("map").infoWindow.show(a)}},_removeStopButton:function(b){this.stops.length>this.get("minStops")?this.removeStop(b):(this._setStops(),this._clearDisplayBeforeSolve(),this._clearDisplayAfterSolve())},_addStopButton:function(){var b=this.stops.length;this.addStop(void 0,b).then(d.hitch(this,function(){this.get("focusOnNewStop")&&this.geocoders[b]&&this.geocoders[b].focus()}))},_sortGeocoders:function(){var b=this._dnd.getAllNodes();
this.geocoders.sort(d.hitch(this,function(a,d){return this._sortGeocodersToNodes(a,d,b,this._sortId)}));this._sortStops();for(var a=0;a<this.geocoders.length;a++)this.geocoders[a].inputNode.title=f.widgets.directions.stopNoTitle+(a+1);this._setLocateButtonVisibilityEvents()},_disconnectResults:function(){if(this._resultEvents&&this._resultEvents.length)for(var b=0;b<this._resultEvents.length;b++)this._resultEvents[b]&&this._resultEvents[b].remove();this._resultEvents=[]},_formatTime:function(b){var a,
c="";a=Math.round(b);b=Math.floor(a/60);a=Math.floor(a%60);b&&(c+=b+" ",c=1<b?c+f.widgets.directions.time.hours:c+f.widgets.directions.time.hour);b&&a&&(c+=" ");a&&(c+=a+" ",c=1<a?c+f.widgets.directions.time.minutes:c+f.widgets.directions.time.minute);return c},_formatDistance:function(b,a){var c=this._getUnits(this.get("directionsLengthUnits")),d=f.widgets.directions.units[c],c=d?a?d.name:d.abbr:c.replace("esri","").toLowerCase(),d=Math.round(100*b)/100;return 0===d?"":K.format(d)+" "+c},_setMoveSymbol:function(b){this._moveSymbolSet=
!0;var a=this._setStopSymbol(b._index,this.stopGraphics.length,!0,b.attributes.Status);b.setSymbol(a)},_unsetMoveSymbol:function(b){var a=this._setStopSymbol(b._index,this.stopGraphics.length,!1,b.attributes.Status);b.setSymbol(a);this._moveSymbolSet=!1},_removeTextGraphic:function(b){b=this.textGraphics[b];this.get("map").graphics.remove(b)},_setDraggableObject:function(b){b._drag&&(this.get("map")&&this.get("map").graphics)&&(this.get("map")._directionsWidgetDragging=!0,this._removeTextGraphic(b._index),
this._dragGraphic=b,this._dragGeometry=b.geometry,this.editToolbar.activate(U.MOVE,b))},_setTextGraphic:function(b){if(b._drag&&this.get("map")&&this.get("map").graphics){var a=this.textGraphics[b._index];a.setGeometry(b.geometry);this.get("map").graphics.add(a);(b=a.getDojoShape())&&b.moveToFront()}},_unsetDraggableObject:function(b){b._drag&&(this.get("map")._directionsWidgetDragging=!1,this._moveSymbolSet&&this._unsetMoveSymbol(b),this._setTextGraphic(b),this.editToolbar.deactivate())},_isMyStopGraphic:function(b){return-1<
s.indexOf(this.get("stopGraphics"),b)||-1<s.indexOf(this.get("textGraphics"),b)},_editToolbar:function(){this.get("map")?this.set("editToolbar",new U(this.get("map"))):this.set("editToolbar",null)},_destroyGlobalGeocoder:function(){this._globalGeocoder&&(this._globalGeocoder.destroy(),this._globalGeocoder=null)},_createGlobalGeocoder:function(){var b=new p;this._globalGeocoder=new Q(this.get("searchOptions"));l.once(this._globalGeocoder,"load",d.hitch(this,function(){b.resolve()},function(a){b.reject(a)}));
this._globalGeocoder.startup();return b.promise},_init:function(){var b=new p;this.set("loaded",!1);this.clearErrors();if(this.get("map"))if(this.get("map").loaded)this._configure().always(b.resolve);else l.once(this.get("map"),"load",d.hitch(this,function(){this._configure().always(b.resolve)}));else this._configure().always(b.resolve);return b.promise},_setDefaultStops:function(){var b=new p;this.defaults.stops&&this.defaults.stops.length?this._updateStops(this.defaults.stops).then(d.hitch(this,
function(){this._removeEmptyStops();b.resolve()}),b.reject):b.resolve();return b.promise},_configure:function(){var b=new p;this._createDnD();this._setSearchOptions();this._createGlobalGeocoder().then(d.hitch(this,function(){this._editToolbar();this._usingAGOL()||(this.printTaskUrl=this.geometryTaskUrl=null);this._createGeometryTask();this._createPrintTask();this._showActivateButton();this._createTravelModesDDL();this._createSearchSourceDDL();var a=[this._createRouteTask(),this._setDefaultStops()];
H(a).then(d.hitch(this,function(){this._setDefaultUnits();this._setTrafficOptions();this._setMenuNodeValues();this._setupEvents();this._setDirectionsLanguageByLocale(!this.directionsLanguage?O.locale.toLowerCase():this.directionsLanguage);this._setupTravelModes().then(d.hitch(this,function(){this.set("loaded",!0);this.onLoad();b.resolve(!0)}),function(a){b.reject(a)})}),function(a){b.reject(a)})}),function(a){b.reject(a)});return b.promise},_setDirectionsLanguageByLocale:function(b){var a=this.serviceDescription.directionsSupportedLanguages,
c=function(b){if(a)for(var c=0;c<a.length;c++)if(a[c].toLowerCase().substr(0,2)===b)return a[c];return null},d=c(b);d||(b=b.substr(0,2),d=c(b));this.directionsLanguage=d;return this.routeParams.directionsLanguage=d},_calculateValidStops:function(){for(var b=0,a=this.stops,c=0;c<a.length;c++)a[c]&&a[c].name&&b++;return b},_setStopSymbol:function(b,a,c,d){return void 0===d||0===d||6===d?0===b?this.get(c?"fromSymbolDrag":"fromSymbol"):b===a-1?this.get(c?"toSymbolDrag":"toSymbol"):this.get(c?"stopSymbolDrag":
"stopSymbol"):this.get(c?"unreachedSymbolDrag":"unreachedSymbol")},_addTrafficLayer:function(){var b=this.get("trafficLayer"),a=this.get("map");a&&(b&&!this._trafficLayerAdded)&&(a.addLayer(b),b.show(),this._trafficLayerAdded=!0)},_toggleUnits:function(b){b.target===this._useMilesNode?this.setDirectionsLengthUnits(q.MILES):b.target===this._useKilometersNode&&this.setDirectionsLengthUnits(q.KILOMETERS)},_toggleCheckbox:function(b){var a=x.get(b.target,"checked");b.target===this._findOptimalOrderNode?
this.set("optimalRoute",a):b.target===this._useTrafficNode?this.set("traffic",a):b.target===this._returnToStartNode&&this.set("returnToStart",a)},_configureRouteOptions:function(){var b=this.get("routeParams");this.get("directionsLengthUnits")?b.directionsLengthUnits=this.get("directionsLengthUnits"):this.set("directionsLengthUnits",b.directionsLengthUnits);b.findBestSequence=this.get("optimalRoute");b.returnStops=!0;this._updateTrafficCheckbox();this.get("traffic")&&!this._useTrafficNode.disabled?
(b.startTime=new Date,b.startTimeIsUTC=!0,this._addTrafficLayer()):(b.startTime=null,b.startTimeIsUTC=null,this._removeTrafficLayer());if(this.get("returnToStart")&&this.stopGraphics.length){var a=new y(this.stopGraphics[0].geometry,null,this.stopGraphics[0].attributes),c=this.stopGraphics.slice(0);this._startReturn=a;c.push(a);b.stops.features=c}else this._startReturn=null,b.stops.features=this.stopGraphics;this.set("routeParams",b)},_configureRoute:function(){var b=new p;this.createRouteSymbols();
this._configureRouteOptions();this.routeTask.solve(this.routeParams,d.hitch(this,function(a){this._showRoute(a);b.resolve(a)}),d.hitch(this,function(a){for(var c=0;c<this.stops.length;c++)this.stops[c].feature.attributes=d.mixin(this.stops[c].feature.attributes,{Status:5});this.set("directions",null);this._clearDisplayAfterSolve();this.createRouteSymbols();this._routeTaskError(a);b.reject(a)}));return b.promise},_boldText:function(b,a){return b.replace(RegExp("(^|\\s)("+a+")(\\s|$)","ig"),"$1\x3cstrong\x3e$2\x3c/strong\x3e$3")},
_clearStopGraphics:function(){if(this.stopGraphics&&this.stopGraphics.length&&this.get("map")&&this.get("map").graphics)for(var b=0;b<this.stopGraphics.length;b++)this.get("map").graphics.remove(this.stopGraphics[b]),this.get("map").graphics.remove(this.textGraphics[b]);this.set("stopGraphics",[]);this.set("textGraphics",[])},_clearRouteGraphics:function(){var b=this.get("displayedRouteGraphics"),a=this.get("map");b&&(b.length&&a&&a.graphics)&&(s.forEach(b,function(b){a.graphics.remove(b)}),this.set("displayedRouteGraphics",
[]));this.unhighlightSegment()},_clearInfoWindow:function(){this.get("map")&&this.get("map").infoWindow&&(this.get("map").infoWindow.hide(),this.get("map").infoWindow.features&&this.get("map").infoWindow.clearFeatures())},_clearDisplayBeforeSolve:function(){this._clearInfoWindow();this._clearResultsHTML()},_clearDisplayAfterSolve:function(){this._clearStopGraphics();this._clearRouteGraphics();this.clearErrors()},_getLetter:function(b){var a=this.alphabet,c="";a&&a.length&&(a instanceof Array&&(a=
a.toString().replace(/,/g,"")),"0123456789"===a||"1234567890"===a?c=String(b+1):(b=b||0,b>=a.length&&(c=this._getLetter(Math.floor(b/a.length)-1),b%=a.length),c+=a[b]));return c},_solveAndZoom:function(){if(this.autoSolve)return this._getDirections().then(d.hitch(this,function(){this.zoomToFullRoute()}));var b=new p;b.resolve();return b.promise},_setupEvents:function(){var b=l(this._dndNode,"[data-reverse-stops]:click, [data-reverse-stops]:keydown",d.hitch(this,function(a){a&&("click"===a.type||"keydown"===
a.type&&a.keyCode===C.ENTER)&&this._reverseStops()}));this._onEvents.push(b);b=l(this._resultsNode,"[data-print-directions]:click, [data-print-directions]:keydown",d.hitch(this,function(a){a&&("click"===a.type||"keydown"===a.type&&a.keyCode===C.ENTER)&&this._printDirections()}));this._onEvents.push(b);b=l(this._resultsNode,"[data-full-route]:click, [data-full-route]:keydown",d.hitch(this,function(a){a&&("click"===a.type||"keydown"===a.type&&a.keyCode===C.ENTER)&&this.zoomToFullRoute()}));this._onEvents.push(b);
b=l(this._dndNode,"[data-remove]:click, [data-remove]:keydown",d.hitch(this,function(a){if(a&&("click"===a.type||"keydown"===a.type&&a.keyCode===C.ENTER)){var b=B("[data-remove]",this._dndNode);a=s.indexOf(b,a.target);this._removeStopButton(a)}}));this._onEvents.push(b);this._onEvents.push(l(this._dndNode,"[data-center-at]:click, [data-center-at]:keydown",d.hitch(this,function(a){if(a&&("click"===a.type||"keydown"===a.type&&a.keyCode===C.ENTER)){var b=B("[data-center-at]",this._dndNode);a=s.indexOf(b,
a.target);this.stops[a]&&(this.stops[a].feature&&this.stops[a].feature.geometry)&&this.map.centerAndZoom(this.stops[a].feature.geometry)}})));b=l(this._dnd,"Drop",d.hitch(this,function(){this._dnd.sync();this._sortGeocoders();this.setListIcons();this._calculateValidStops()===this.get("geocoders").length&&this.get("routeParams").stops.features.length&&this._solveAndZoom()}));this._onEvents.push(b);b=l(this._dnd,"DndStart",d.hitch(this,function(){var a=B("body")[0];n.add(a,this._css.dndDragBodyClass);
this._removeLocateButtonVisibilityEvents()}));this._onEvents.push(b);b=l(this._dnd,"DndDrop, DndCancel",d.hitch(this,function(){var a=B("body")[0];n.remove(a,this._css.dndDragBodyClass);this._setLocateButtonVisibilityEvents()}));this._onEvents.push(b);this.get("map")&&this.get("map").graphics&&(b=this.get("map").graphics.on("mouse-over",d.hitch(this,function(a){if(this.get("dragging")&&!this.get("map")._directionsWidgetDragging){var b;this._isMyStopGraphic(a.graphic)&&(a.graphic._drag?(b=this.editToolbar.getCurrentState(),
b.graphic||this._setDraggableObject(a.graphic),this._moveSymbolSet||this._setMoveSymbol(a.graphic)):a.graphic._textGraphic&&(b=this.editToolbar.getCurrentState(),this.stopGraphics[a.graphic._index]&&(b.graphic||this._setDraggableObject(this.stopGraphics[a.graphic._index]),this._moveSymbolSet||this._setMoveSymbol(this.stopGraphics[a.graphic._index]))))}})),this._onEvents.push(b),b=this.get("map").graphics.on("mouse-out",d.hitch(this,function(a){this.get("dragging")&&this._isMyStopGraphic(a.graphic)&&
!this._moveInProgress&&a.graphic._drag&&this._unsetDraggableObject(a.graphic)})),this._onEvents.push(b),this._editToolbarEvents());b=this.watch("theme",this._updateThemeWatch);this._watchEvents.push(b);b=this.watch("canModifyStops",this._updateCanModifyStops);this._watchEvents.push(b);b=this.watch("showReturnToStartOption",this._optionsMenu);this._watchEvents.push(b);b=this.watch("showOptimalRouteOption",this._optionsMenu);this._watchEvents.push(b);b=this.watch("returnToStart",this._setMenuNodeValues);
this._watchEvents.push(b);b=this.watch("optimalRoute",this._setMenuNodeValues);this._watchEvents.push(b);b=this.watch("routeTaskUrl",d.hitch(this,function(){this._createRouteTask();this._setTrafficOptions()}));this._watchEvents.push(b);this._watchEvents.push(this.watch("printTaskUrl",d.hitch(this,function(){this._createPrintTask()})));this._watchEvents.push(this.watch("geometryTaskUrl",d.hitch(this,function(){this._createGeometryTask()})));b=this.watch("routeParams",d.hitch(this,function(){this._createRouteParams();
this._setDefaultUnits()}));this._watchEvents.push(b);b=this.watch("searchOptions",d.hitch(this,function(){this._setSearchOptions();this._createGlobalGeocoder();var a=this.get("searchOptions").sources;if(a)for(var b=0;b<this.geocoders.length;b++)this.geocoders[b].set("sources",a)}));this._watchEvents.push(b);b=this.watch("showReverseStopsButton",this.setListIcons);this._watchEvents.push(b);b=this.watch("showPrintPage",this._renderDirections);this._watchEvents.push(b);b=this.watch("trafficLayer",this._trafficLayerUpdate);
this._watchEvents.push(b);b=this.watch("editToolbar",this._editToolbarEvents);this._watchEvents.push(b);b=this.watch("showTravelModesOption",this._showTravelModesOption);this._watchEvents.push(b);b=this.watch("showMilesKilometersOption",this._showMilesKilometersOption);this._watchEvents.push(b);b=this.watch("showClearButton",this._showClearButton);this._watchEvents.push(b);b=this.watch("directionsLengthUnits",this.setDirectionsLengthUnits);this._watchEvents.push(b);this._watchEvents.push(this.watch("directionsLanguage",
this.setDirectionsLanguage));this._watchEvents.push(this.watch("mapClickActive",this._activate));this._watchEvents.push(this.watch("showActivateButton",this._showActivateButton))},_editToolbarEvents:function(){var b=l(this.editToolbar,"graphic-click",d.hitch(this,function(a){this.get("map")&&this.get("map").infoWindow&&(this.get("map").infoWindow.setFeatures([a.graphic]),this.get("map").infoWindow.show(a.graphic.geometry))}));this._onEvents.push(b);b=l(this.editToolbar,"graphic-first-move",d.hitch(this,
function(){this._moveInProgress=!0}));this._onEvents.push(b);b=l(this.editToolbar,"graphic-move-stop",d.hitch(this,function(a){this._moveInProgress=!1;this._unsetDraggableObject(a.graphic);this._dragGeometry!==a.graphic.geometry&&this._reverseGeocode(a.graphic).then(d.hitch(this,function(b){this._setReverseGeocode(b,b.feature.geometry,s.indexOf(this.stopGraphics,a.graphic))}))}));this._onEvents.push(b)},_decorateUngeocodedStop:function(b){var a=new p,c=function(c,d){a.resolve({name:void 0===c?f.widgets.directions.unlocatedStop:
c.toFixed(6)+" "+d.toFixed(6),feature:b})};if(b.geometry)if(b.geometry.spatialReference&&4326!==b.geometry.spatialReference.wkid)if(this.map&&this.map.spatialReference&&this.map.spatialReference.isWebMercator()){var e=E.xyToLngLat(b.geometry.x,b.geometry.y);c(e[0],e[1])}else this._geometryService?(e=new ra,e.outSR=new S(4326),e.geometries=[b.geometry],this._geometryService.project(e).then(d.hitch(this,function(a){a&&a.length?c(a[0].x,a[0].y):c(b.geometry.x,b.geometry.y)}),d.hitch(this,function(){c()}))):
c(b.geometry.x,b.geometry.y);else c(b.geometry.x,b.geometry.y);else c();return a.promise},_trafficLayerUpdate:function(b,a,c){b=this.get("map");a&&(b&&this._trafficLayerAdded)&&(b.removeLayer(a),this._trafficLayerAdded=!1);c&&(b&&this.get("traffic")&&!this._trafficLayerAdded)&&(b.addLayer(c),c.show(),this._trafficLayerAdded=!0)},_routeTaskError:function(b){var a=f.widgets.directions.error.routeTask,c=b.details;c&&1===c.length&&("The distance between any inputs must be less than 50 miles (80 kilometers) when walking."===
c[0]?a=f.widgets.directions.error.maxWalkingDistance:"Driving a truck is currently not supported outside of North America and Central America."===c[0]&&(a=f.widgets.directions.error.nonNAmTruckingMode));this._resultError(a);this.onDirectionsFinish(b)},_resultError:function(b){var a="";this.errors.push(b);a+='\x3cdiv class\x3d"'+this._css.routesErrorClass+'"\x3e';if(this.errors.length){for(var a=a+"\x3cul\x3e",c=0;c<this.errors.length;c++)a+="\x3cli\x3e"+this.errors[c]+"\x3c/li\x3e";a+="\x3c/ul\x3e"}a+=
"\x3c/div\x3e";this._errorNode&&(this._errorNode.innerHTML=a);this.onError(b)},_getUnits:function(b){switch(b){case q.KILOMETERS:return"KILOMETERS";case q.METERS:return"METERS";case q.NAUTICAL_MILES:return"NAUTICAL_MILES";case q.MILES:return"MILES";default:return b}},_createRouteTask:function(){var b=new p;this.set("routeTask",new ka(this.get("routeTaskUrl")));this._createRouteParams();this.routeTask.getServiceDescription(this.travelModesServiceUrl,this.doNotFetchTravelModesFromOwningSystem).then(d.hitch(this,
function(a){a.networkDataset?(this.set("serviceDescription",a),a.serviceLimits&&a.serviceLimits.Route_MaxStops&&this.set("maxStops",a.serviceLimits.Route_MaxStops),b.resolve()):(this._resultError(f.widgets.directions.error.cantFindRouteServiceDescription),b.reject(f.widgets.directions.error.cantFindRouteServiceDescription))}),d.hitch(this,function(){this._resultError(f.widgets.directions.error.cantFindRouteServiceDescription);b.reject(f.widgets.directions.error.cantFindRouteServiceDescription)}));
return b.promise},_createSearchSourceDDL:function(){if(!this._searchSourceSelector&&this._globalGeocoder&&this._globalGeocoder.sources&&1<this._globalGeocoder.sources.length){for(var b=d.hitch(this,function(a){this._searchSourceSelector.domNode.blur();this._globalGeocoder.set("activeSourceIndex",a);for(var b=0;b<this.geocoders.length;b++)this.geocoders[b].set("activeSourceIndex",a)}),a=[{value:"all",label:f.widgets.Search.main.all,selected:!0}],c=0;c<this._globalGeocoder.sources.length;c++)a.push({value:String(c),
label:this._globalGeocoder.sources[c].name});this._searchSourceSelector=new P({className:"esriSearchSourcesDDL",style:"width:100%;",options:a},this._searchSourceSelectorContainer);this._searchSourceSelector.startup();this._searchSourceSelector.on("change",b);b("all");this._searchSourceSelector.domNode.style.width=""}},_createTravelModesDDL:function(){this._travelModeSelector||(this._travelModeSelector=new P({className:"esriTravelModesDDL",style:"width:100%;"},this._travelModeSelectorContainer),this._travelModeSelector.startup(),
this._travelModeSelector._interractive=!0,this._travelModeSelector.on("change",d.hitch(this,function(b){this._travelModeSelector._interractive&&this._enqueue(function(){this.clearErrors();return this._setTravelMode(b)})})))},_setupTravelModes:function(){var b=this.get("serviceDescription"),a=b.supportedTravelModes,c=new p;if(a&&a.length&&this._travelModeSelector){for(var e=a[0].name,h=[],f=0;f<a.length;f++){for(var g="AUTOMOBILE"===a[f].type?"Driving":"TRUCK"===a[f].type?"Trucking":"WALK"===a[f].type?
"Walking":"Other",k="",l=b.networkDataset.networkAttributes,n=0;n<l.length;n++){var r=l[n];if(r.name===a[f].impedanceAttributeName){if("esriNAUCentimeters"===r.units||"esriNAUDecimalDegrees"===r.units||"esriNAUDecimeters"===r.units||"esriNAUFeet"===r.units||"esriNAUInches"===r.units||"esriNAUKilometers"===r.units||"esriNAUMeters"===r.units||"esriNAUMiles"===r.units||"esriNAUMillimeters"===r.units||"esriNAUNauticalMiles"===r.units||"esriNAUYards"===r.units)k="Distance";else if("esriNAUDays"===r.units||
"esriNAUHours"===r.units||"esriNAUMinutes"===r.units||"esriNAUSeconds"===r.units)k="Time";break}}h.push({id:a[f].name,label:'\x3cdiv class\x3d"esriTravelModesDirectionsIcon esriTravelModesType'+g+k+'"\x3e\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"esriTravelModesTypeName"\x3e'+a[f].name+"\x3c/div\x3e"});if(b.defaultTravelMode&&(a[f].id===b.defaultTravelMode||a[f].itemId===b.defaultTravelMode))e=a[f].name}this._showTravelModesOption();this._travelModeSelector.setStore(new X({objectStore:new W({data:h})}));
this._travelModeSelector._interractive=!1;this._travelModeSelector.setValue(e);this._setTravelMode(e).always(d.hitch(this,function(){this._travelModeSelector._interractive=!0;c.resolve()}))}else this.set("showTravelModesOption",!1),c.resolve();return c.promise},_createPrintTask:function(){this._printService=(this.printTaskUrl=this._usingAGOL()?this.printTaskUrl:this.defaults.printTaskUrl)?new na(this.printTaskUrl,{async:!1}):null;var b=new pa;b.exportOptions={width:670,height:750,dpi:96};b.format=
"PNG32";b.layout="MAP_ONLY";b.preserveScale=!1;b.showAttribution=!1;var a=new oa;a.map=this.map;a.outSpatialReference=this.map.spatialReference;a.template=b;this._printParams=a},_createGeometryTask:function(){this._geometryService=null;this._usingAGOL()?this._geometryService=new N(this.geometryTaskUrl):this.geometryTaskUrl=(this._geometryService=this.defaults.geometryTaskUrl?new N(this.defaults.geometryTaskUrl):qa.defaults.geometryService)?this._geometryService.url:null},_showTravelModesOption:function(){var b=
this.get("serviceDescription");w.set(this._travelModeContainerNode,"display",this.showTravelModesOption&&b&&b.supportedTravelModes&&b.supportedTravelModes.length&&!this.doNotFetchTravelModesFromOwningSystem?"block":"none")},_showMilesKilometersOption:function(){w.set(this._agolDistanceUnitsNode,"display",this.showMilesKilometersOption?"block":"none")},_showClearButton:function(){w.set(this._clearDirectionsButtonNode,"display",this.showClearButton?"inline-block":"none")},_showActivateButton:function(){w.set(this._activateButtonNode,
"display",this.showActivateButton?"inline-block":"none");this.showActivateButton||this.deactivate()},_createRouteParams:function(){var b={directionsOutputType:"complete",stops:new ja,returnDirections:!0,outputLines:"esriNAOutputLineTrueShape",doNotLocateOnRestrictedElements:!0};this.get("map")?b.outSpatialReference=this.get("map").spatialReference:b.outSpatialReference=this._defaultSR;this.get("routeParams")||(this.routeParams={});var a=new la;this.routeParams=d.mixin(a,{returnRoutes:!1,preserveFirstStop:!0,
preserveLastStop:!0,ignoreInvalidLocations:!0},this.get("routeParams"),b)},_reverseStops:function(){var b=this._dnd.getAllNodes();b.length&&(this._removeLocateButtonVisibilityEvents(),b.reverse(),this._dnd.clearItems(),this._dnd.insertNodes(!1,b),this._dnd.sync(),this._stopsRemovable(),this._optionsMenu(),this._checkMaxStops(),this.setListIcons(),this._sortGeocoders(),this._solveAndZoom())},_sortGeocodersToNodes:function(b,a,c,d){a=a[d];b=G.byId(b[d]);d=G.byId(a);b=s.indexOf(c,b);d=s.indexOf(c,d);
for(a=0;a<c.length;a++){if(a===b)return-1;if(a===d)return 1}},_setMenuNodeValues:function(){var b=this.get("optimalRoute");this._findOptimalOrderNode&&x.set(this._findOptimalOrderNode,"checked",b);b=this.get("returnToStart");this._returnToStartNode&&x.set(this._returnToStartNode,"checked",b);b=this.get("traffic");this._useTrafficNode&&x.set(this._useTrafficNode,"checked",b);switch(this.get("directionsLengthUnits")){case q.KILOMETERS:x.set(this._useKilometersNode,"checked",!0);x.set(this._useMilesNode,
"checked",!1);break;case q.MILES:x.set(this._useKilometersNode,"checked",!1),x.set(this._useMilesNode,"checked",!0)}this._showMilesKilometersOption();this._showClearButton()},_optionsMenu:function(){this._useTrafficItemNode&&w.set(this._useTrafficItemNode,"display",this.get("showTrafficOption")?"block":"none");this._returnToStartItemNode&&w.set(this._returnToStartItemNode,"display",this.get("showReturnToStartOption")?"block":"none");this._findOptimalOrderItemNode&&w.set(this._findOptimalOrderItemNode,
"display",this.get("showOptimalRouteOption")&&4<=this.stops.length?"block":"none");this.stops.length>=this.get("minStops")?n.add(this._widgetContainer,this._css.stopsOptionsOptionsEnabledClass):(n.remove(this._widgetContainer,this._css.stopsOptionsOptionsEnabledClass),this._optionsMenuNode&&"block"===w.get(this._optionsMenuNode,"display")&&this._toggleOptionsMenu(),this._configureRouteOptions())},_stopsRemovable:function(){this.get("geocoders").length>this.get("minStops")?n.add(this._widgetContainer,
this._css.stopsRemovableClass):n.remove(this._widgetContainer,this._css.stopsRemovableClass)},_checkMaxStops:function(){this.stops.length<this.get("maxStops")?(this._showAddDestination(),this.set("maxStopsReached",!1)):(this._hideAddDestination(),this.set("maxStopsReached",!0))},_updateThemeWatch:function(b,a,c){n.remove(this.domNode,a);n.add(this.domNode,c)},_toggleOptionsMenu:function(){this._optionsMenuNode&&("block"===w.get(this._optionsMenuNode,"display")?(w.set(this._optionsMenuNode,"display",
"none"),this._optionsButtonNode.innerHTML=f.widgets.directions.showOptions):(w.set(this._optionsMenuNode,"display","block"),this._optionsButtonNode.innerHTML=f.widgets.directions.hideOptions))},_hideAddDestination:function(){n.remove(this._widgetContainer,this._css.addStopsClass)},_showAddDestination:function(){n.add(this._widgetContainer,this._css.addStopsClass)},_getAbsoluteUrl:function(b){b=u.toUrl(b);return/^https?\:/i.test(b)?b:/^\/\//i.test(b)?window.location.protocol+b:/^\//i.test(b)?window.location.protocol+
"//"+window.location.host+b:b},_getManeuverImage:function(b){return b?"esriDMTStop"===b||"esriDMTDepart"===b?"":this._getAbsoluteUrl("./images/Directions/maneuvers/"+b+".png"):""},_loadPrintDirections:function(b){var a=this.get("printTemplate");if(!a){var c=this._getAbsoluteUrl("./css/Directions.css"),e=this._getAbsoluteUrl("./css/DirectionsPrint.css"),h=this._getAbsoluteUrl("./images/Directions/print-logo.png"),l;l=Z.isBodyLtr()?"ltr":"rtl";a="";a+="\x3c!DOCTYPE HTML\x3e";a+='\x3chtml lang\x3d"en" class\x3d"'+
this.get("theme")+'" dir\x3d"'+l+'"\x3e';a+="\x3chead\x3e";a+='\x3cmeta charset\x3d"utf-8"\x3e';a+='\x3cmeta http-equiv\x3d"X-UA-Compatible" content\x3d"IE\x3dEdge,chrome\x3d1"\x3e';a+="\x3ctitle\x3e"+this.get("directions").routeName+"\x3c/title\x3e";a+='\x3clink rel\x3d"stylesheet" media\x3d"screen" type\x3d"text/css" href\x3d"'+c+'" /\x3e';a+='\x3clink rel\x3d"stylesheet" media\x3d"print" type\x3d"text/css" href\x3d"'+e+'" /\x3e';a+="\x3c/head\x3e";a+='\x3cbody class\x3d"'+this._css.esriPrintPageClass+
'"\x3e';a+='\x3cdiv class\x3d"'+this._css.esriPrintBarClass+'"\x3e';a+='\x3cdiv class\x3d"'+this._css.esriCloseButtonClass+'" title\x3d"'+f.common.close+'" onclick\x3d"window.close();"\x3e'+f.common.close+"\x3c/div\x3e";a+='\x3cdiv id\x3d"printButton" class\x3d"'+this._css.esriPrintButtonClass+'" title\x3d"'+f.widgets.directions.print+'" onclick\x3d"window.print();"\x3e'+f.widgets.directions.print+"\x3c/div\x3e";a+="\x3c/div\x3e";a+='\x3cdiv class\x3d"'+this._css.esriPrintMainClass+'"\x3e';a+='\x3cdiv class\x3d"'+
this._css.esriPrintHeaderClass+'"\x3e';a+='\x3cimg class\x3d"'+this._css.esriPrintLogoClass+'" src\x3d"'+h+'" /\x3e';a+='\x3cdiv class\x3d"'+this._css.esriPrintNameClass+'"\x3e'+this.get("directions").routeName+"\x3c/div\x3e";a+='\x3cdiv class\x3d"'+this._css.esriPrintLengthClass+'"\x3e'+this._formatDistance(this.get("directions").totalLength,!0)+". "+this._formatTime(this.get("directions").totalTime)+"\x3c/div\x3e";b&&(a+='\x3cdiv id\x3d"divMap" class\x3d"esriPrintMap esriPrintWait"\x3e\x3c/div\x3e',
a+='\x3chr class\x3d"esriNoPrint"/\x3e');var a=a+'\x3cdiv id\x3d"print_helper"\x3e\x3c/div\x3e',a=a+('\x3ctextarea onkeyup\x3d"document.getElementById(\'print_helper\').innerHTML\x3dthis.value;" id\x3d"print_area" class\x3d"'+this._css.esriPrintNotesClass+'" placeholder\x3d"'+f.widgets.directions.printNotes+'"\x3e\x3c/textarea\x3e'),a=a+('\x3cdiv class\x3d"'+this._css.clearClass+'"\x3e\x3c/div\x3e'),a=a+"\x3c/div\x3e",a=a+('\x3cdiv class\x3d"'+this._css.esriPrintDirectionsClass+'"\x3e'),a=a+"\x3ctable\x3e",
a=a+"\x3ctbody\x3e",g=0;s.forEach(this.get("directions").features,d.hitch(this,function(b,c){var d=this.get("directions").strings[c],e;if(d){var f=b.attributes.text;for(e=0;e<d.length;e++)f=this._boldText(f,d[e].string);b.attributes.formattedText=f}else b.attributes.formattedText=b.attributes.text;d="";this.get("directions").features.length===c+1&&(d=this._css.routeLastClass);b.attributes&&(b.attributes.step=c+1);a+='\x3ctr class\x3d"'+d+'"\x3e';a+='\x3ctd class\x3d"'+this._css.routeIconColumnClass+
'"\x3e';var d=this._getManeuverImage(b.attributes.maneuverType),h;0===c?(h=this._getLetter(g),g++):"esriDMTStop"===b.attributes.maneuverType?h=this._getLetter(g):"esriDMTDepart"===b.attributes.maneuverType&&(h=this._getLetter(g),g++);d?a+='\x3cimg src\x3d"'+d+'" /\x3e':h&&(a+='\x3cdiv class\x3d"'+this._css.esriPrintStopLabelClass+'"\x3e',a+=h,a+="\x3c/div\x3e");a+="\x3c/td\x3e";a+='\x3ctd class\x3d"'+this._css.routeTextColumnClass+'"\x3e';a+="\x3cdiv\x3e\x3cstrong\x3e"+K.format(b.attributes.step)+
".\x3c/strong\x3e "+b.attributes.formattedText+"\x3c/div\x3e";a+="\x3c/td\x3e";a+='\x3ctd class\x3d"'+this._css.routeTextColumnClass+'"\x3e';a+='\x3cdiv class\x3d"'+this._css.routeLengthClass+'"\x3e'+this._formatDistance(b.attributes.length,!1)+"\x3c/div\x3e";a+="\x3c/td\x3e";a+="\x3c/tr\x3e"}));a+="\x3c/tbody\x3e";a+="\x3c/table\x3e";a+="\x3c/div\x3e";a+='\x3cdiv class\x3d"'+this._css.esriPrintFooterClass+'"\x3e';a+="\x3cp\x3e"+f.widgets.directions.printDisclaimer+"\x3c/p\x3e";a+="\x3c/div\x3e";
a+="\x3c/div\x3e";a+="\x3c/body\x3e";a+="\x3c/html\x3e"}this._printWindow.document.open("text/html","replace");this._printWindow.document.write(a);this._printWindow.document.close()},_printDirections:function(){var b=screen.width/2,a=screen.height/1.5,b="toolbar\x3dno, location\x3dno, directories\x3dno, status\x3dyes, menubar\x3dno, scrollbars\x3dyes, resizable\x3dyes, width\x3d"+b+", height\x3d"+a+", top\x3d"+(screen.height/2-a/2)+", left\x3d"+(screen.width/2-b/2);this.get("printPage")?(window.directions=
this.get("directions"),window.open(this.get("printPage"),"directions_widget_print",b,!0)):(this._printWindow=window.open("","directions_widget_print",b,!0),this._loadPrintDirections(!!this._printService),this._printService&&u(["dojo/_base/window"],d.hitch(this,function(a){this.zoomToFullRoute().then(d.hitch(this,function(){this._printService.execute(this._printParams,d.hitch(this,function(b){a.withDoc(this._printWindow.document,function(){var a=G.byId("divMap");a&&(n.remove(a,"esriPrintWait"),n.add(a,
"esriPageBreak"),t.create("img",{src:b.url,"class":"esriPrintMapImg"},a))})}),d.hitch(this,function(b){a.withDoc(this._printWindow.document,function(){var a=G.byId("divMap");a&&n.remove(a,"esriPrintWait")})}))}))})))}});Y("extend-esri")&&d.setObject("dijit.Directions",F,ba);return F});