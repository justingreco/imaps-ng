"use strict";function spToDd(a,b){var c=34.33333333333334,d=36.16666666666666,e=33.75,f=-79,g=2000000.002616666,h=20925874.015664328,i=.08181922146,j=i*i,k=.01745329252,l=Math.PI/4;c=34.33333333333334*k,d=36.16666666666666*k,e=33.75*k,f=-79*k;var g=2000000.002616666,m=Math.cos(c)/Math.sqrt(1-j*Math.pow(Math.sin(c),2)),n=Math.cos(d)/Math.sqrt(1-j*Math.pow(Math.sin(d),2)),o=Math.tan(l-c/2)/Math.pow((1-i*Math.sin(c))/(1+i*Math.sin(c)),i/2),p=Math.tan(l-d/2)/Math.pow((1-i*Math.sin(d))/(1+i*Math.sin(d)),i/2),q=Math.tan(l-e/2)/Math.pow((1-i*Math.sin(e))/(1+i*Math.sin(e)),i/2),r=Math.log(m/n)/Math.log(o/p),s=m/(r*Math.pow(o,r)),t=h*s*Math.pow(q,r);a-=g;var u=Math.PI/2,v=Math.sqrt(Math.pow(a,2)+Math.pow(t-b,2)),w=Math.atan(a/(t-b)),x=Math.pow(v/(h*s),1/r),y=w/r+f;a+=g;for(var z=u-2*Math.atan(x),A=(1-i*Math.sin(z))/(1+i*Math.sin(z)),B=u-2*Math.atan(x*Math.pow(A,i/2));Math.abs(B-z)>2e-9;)z=B,A=(1-i*Math.sin(z))/(1+i*Math.sin(z)),B=u-2*Math.atan(x*Math.pow(A,i/2));var C=B/k,D=y/k;return[C,D]}angular.module("imapsNgApp",["ngTouch","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","pageslide-directive","ui.bootstrap","vr.directives.slider","LocalStorageModule","angular-loading-bar","cfp.loadingBar","ngCsv","ngReactGrid","angulartics","angulartics.google.analytics"]).config(["localStorageServiceProvider",function(a){a.setPrefix("imaps")}]).filter("titleCase",function(){return function(a){return a=a||"",a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})}}).directive("onlyDigits",function(){return{require:"ngModel",restrict:"A",link:function(a,b,c,d){function e(a){if(a){var b=a.toString().replace(/[^0-9]/g,"");return b!==a&&(d.$setViewValue(b),d.$render()),parseInt(b,10)}return void 0}d.$parsers.push(e)}}}),angular.module("imapsNgApp").controller("MainCtrl",["$rootScope","config",function(a,b){a.checked=!0,a.loading=!0,b.loadConfig("config/config.json").then(function(b){a.config=b})}]),angular.module("imapsNgApp").directive("appHeader",function(){return{templateUrl:"directives/appHeader/appHeader.html",restrict:"E",controller:["$scope","$rootScope",function(a,b){$("app-header").appendTo("body"),b.checked=!0,b.$watch("config",function(b){b&&(a.title=b.title)});var c=function(){$("feedback .modal").modal("show")},d=function(){$("about .modal").modal("show")},e=function(){$("disclaimer .modal").modal("show")};a.headerClick=function(a){switch(a){case"Feedback":c();break;case"About":d();break;case"Disclaimer":e()}},a.btnClick=function(){b.checked=!b.checked},a.titleClick=function(){this.title=this.$root.config.title}}]}}),angular.module("imapsNgApp").directive("feedback",function(){return{templateUrl:"directives/appHeader/feedback/feedback.html",restrict:"E",controller:["$scope","$rootScope","$http",function(a,b,c){a.feedbackText="";var d=function(){a.feedbackText="",a.feedbackEmail="",$("feedback .modal").modal("hide")};a.sendFeedback=function(a,b){c({url:"http://maps.raleighnc.gov/php/mail.php",method:"GET",type:"jsonp",params:{fromEmail:a,toEmail:"gis@raleighnc.gov",subject:"iMAPS 3.0 Beta Feedback",message:b,from:"",to:""}}).success(d).error(d)}}]}}),angular.module("imapsNgApp").directive("disclaimer",function(){return{templateUrl:"directives/appHeader/disclaimer/disclaimer.html",restrict:"E",controller:["$scope","$rootScope",function(a,b){}]}}),angular.module("imapsNgApp").directive("about",function(){return{templateUrl:"directives/appHeader/about/about.html",restrict:"E",controller:["$scope","$rootScope",function(a,b){}]}}),angular.module("imapsNgApp").directive("exportButton",function(){return{templateUrl:"directives/exportButton/exportButton.html",restrict:"E",scope:{array:"=",headers:"=",filename:"@",type:"@"},link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("mapPanel",["cfpLoadingBar",function(a){return{templateUrl:"directives/mapPanel/mapPanel.html",restrict:"E",controller:["$scope","$rootScope","property","localStorageService","$filter","mapUtils",function(b,c,d,e,f,g){b.property=d;var h=null,i=function(){a.start()},j=function(){a.complete()},k=function(){e.set("imaps_webmap",stringify(b.webmap))},l=function(a,d){require(["esri/geometry/Polygon"],function(e){a=new e(a);var f=a.contains(d);b.inRaleigh!=f&&(b.inRaleigh=a.contains(d),c.$broadcast("raleighChecked",f))})},m=function(a){var c=spToDd(a.extent.xmin,a.extent.ymin),d=spToDd(a.extent.xmax,a.extent.ymax);b.webmap.itemInfo.item.extent=[c.reverse(),d.reverse()],b.raleighBounds&&l(b.raleighBounds,a.extent.getCenter())},n=function(){g.loadRaleighBounds("data/raleigh.json").then(function(a){b.raleighBounds=a,l(a,b.map.extent.getCenter())})},o=function(){angular.forEach(b.map.layerIds,function(a){var c=null;if(h?c=h:e.get("imaps_webmap")&&(c=e.get("imaps_webmap").itemInfo),c){var d=b.map.getLayer(a);if(d.visibleLayers){var g=f("filter")(c.itemData.operationalLayers,function(a){return d.id===a.id});g.length>0&&(g=g[0],d.setVisibleLayers(g.layerObject.visibleLayers))}}})},p=function(a,b){return angular.forEach(a.itemInfo.itemData.operationalLayers,function(a){var c=f("filter")(b.itemData.operationalLayers,function(b){return a.id===b.id});c.length>0&&(c=c[0],angular.forEach(a.resourceInfo.layers,function(a){c.layerObject.visibleLayers.indexOf(a.id)>-1?a.defaultVisibility=!0:a.defaultVisibility=!1}))}),a},q=function(a){require(["esri/layers/GraphicsLayer","esri/basemaps","esri/geometry/Extent","esri/dijit/HomeButton","esri/dijit/LocateButton","dojo/on"],function(c,d,g,l,q,r){h&&(a=p(a,h)),e.get("imaps_webmap")?(b.webmap=e.get("imaps_webmap"),b.webmap.clickEventHandle=a.clickEventHandle,b.webmap.clickEventListener=a.clickEventListener):b.webmap=a,b.map=a.map,n(),b.selectionMultiple=new c,b.selectionSingle=new c,b.map.addLayer(b.selectionMultiple),b.map.addLayer(b.selectionSingle),b.$digest(),r(b.map,"update-start",i),r(b.map,"update-end",j),r(b.map,"extent-change",m),r(b.map,"unload",k),o();var s=b.config.map.basemaps.streets.layers.concat(b.config.map.basemaps.images.layers);angular.forEach(s,function(a){var c=[{url:a.url}];a.labels||c.push({url:b.config.map.labels});var e={baseMapLayers:c,title:a.name};d[a.id]=e});var t=b.webmap.itemInfo.itemData.baseMap.title,s=f("filter")(b.config.map.basemaps.streets.layers,function(a){return t===a.name});s.length>0?(b.basemap=s[0],b.basemapType="streets"):(s=f("filter")(b.config.map.basemaps.images.layers,function(a){return t===a.name}),s.length>0&&(b.basemap=s[0],b.basemapType="images")),$("#loading").remove(),$("#loadingBackground").remove();new l({map:b.map},"homeButton").startup()})},r=function(a,b){var c=null;angular.forEach(a.itemData.operationalLayers,function(a){c=f("filter")(b.itemData.operationalLayers,function(b){return a.id===b.id}),c.length>0&&(c=c[0],a.opacity=c.opacity,a.visibility=c.visibility)})};c.$watch("config",function(a){a&&(b.config=a,require(["esri/map","esri/arcgis/utils","esri/config","dojo/domReady!"],function(b,c,d){d.defaults.io.proxyUrl="http://maps.raleighnc.gov/parklocator/proxy.ashx",d.defaults.io.alwaysUseProxy=!1;var f=(a.map.id,c.getItem(a.map.id));f.addCallback(function(a){var b=a;if(e.get("imaps_webmap"))if(a.item.modified===e.get("imaps_webmap").itemInfo.item.modified){var d={};d.item=e.get("imaps_webmap").itemInfo.item,d.itemData=e.get("imaps_webmap").itemInfo.itemData,b=d}else a.item.extent=e.get("imaps_webmap").itemInfo.item.extent,a.itemData.baseMap=e.get("imaps_webmap").itemInfo.itemData.baseMap,a=r(a,e.get("imaps_webmap").itemInfo),h=e.get("imaps_webmap").itemInfo,e.remove("imaps_webmap");c.createMap(b,"map",{geometryServiceURL:"http://maps.raleighnc.gov/arcgis/rest/services/Utilities/Geometry/GeometryServer",mapOptions:{fadeOnZoom:!0,logo:!1,showAttribution:!1,sliderPosition:"bottom-left",sliderOrientation:"horizontal",sliderStyle:"small"}}).then(q,function(a){console.log(a)})})}))});var s=function(a,c,d){require(["esri/graphic","esri/graphicsUtils","esri/SpatialReference"],function(e,f,g){var h=null;c.clear(),b.selectionSingle.clear(),1===a.length&&(b.geometry=a[0].geometry),angular.forEach(a,function(a){a.geometry.spatialReference={wkid:b.config.map.wkid},h=new e({geometry:a.geometry,symbol:{color:[0,0,0,0],outline:{color:d,width:3,type:"esriSLS",style:"esriSLSSolid"},type:"esriSFS",style:"esriSFSSolid"}}),c.add(h)}),b.map.setExtent(f.graphicsExtent(c.graphics),!0)})};b.$on("accountUpdate",function(a,c){var d=[];c&&(angular.forEach(c,function(a){d.push("'"+a.pin+"'")}),b.property.getGeometryByPins("PIN_NUM in ("+d.toString()+")",b.config.map.wkid).then(function(a){s(a.features,b.selectionMultiple,[255,255,0])}))}),b.$on("pinUpdate",function(a,c){b.property.getGeometryByPins("PIN_NUM = '"+c+"'",b.config.map.wkid).then(function(a){s(a.features,b.selectionSingle,[255,0,0])})})}],link:function(a,b,c){}}}]),angular.module("imapsNgApp").directive("sidePanel",["$timeout","$window",function(a,b){return{templateUrl:"directives/sidePanel/sidePanel.html",restrict:"E",controller:["$scope","$rootScope",function(a,b){a.checked=!0,a.searchDir={open:!0,overflow:"none",padding:30},a.layersDir={open:!1,overflow:"auto",padding:15},a.searchTypeStatus={isopen:!1},b.$watch("checked",function(b){a.checked=b}),a.propertySearchSelected=function(c){c.preventDefault(),c.stopPropagation(),"For Property"===c.target.text?b.selectedSearch=b.searches[0]:"For Location"===c.target.text&&(b.selectedSearch=b.searches[1]),a.searchTypeStatus.isopen=!1},a.$watch("searchDir.open",function(b){b&&(a.layersDir.open=!1,a.resetPanel())}),a.$watch("layersDir.open",function(b){b&&(a.searchDir.open=!1,a.resetPanel())})}],link:function(c,d,e){c.resetPanel=function(){var a=document.getElementsByClassName("panel-heading");document.getElementsByClassName("panel-body");if(a.length>0){var d=b.innerHeight;d-=a.length*a[0].offsetHeight;var e=null;c.searchDir.open?e=c.searchDir:c.layersDir.open&&(e=c.layersDir),e&&(c.accordionHeight={height:d-$("pageslide").position().top-e.padding+"px",overflow:e.overflow})}},a(c.resetPanel.bind(d),500);var f=angular.element(b);c.getWindowDimensions=function(){return{h:f.height(),w:f.width()}},c.$watch(c.getWindowDimensions,function(a,b){c.resetPanel()},!0),f.bind("resize",function(){c.$apply()})}}}]),angular.module("imapsNgApp").directive("toggleButton",["$window",function(a){return{templateUrl:"directives/sidePanel/toggleButton/toggleButton.html",restrict:"E",controller:["$scope","$rootScope",function(a,b){a.toggleSidePanel=function(){b.checked=!b.checked}}],link:function(b,c,d){var e=angular.element(a),f=function(a){b.toggleTop=a.h/2};b.getWindowDimensions=function(){return{h:e.height(),w:e.width()}},b.$watch(b.getWindowDimensions,function(a,b){f(a)},!0),e.bind("resize",function(){b.$apply()})}}}]),angular.module("imapsNgApp").directive("toolPanel",["$timeout",function(a){return{templateUrl:"directives/toolPanel/toolPanel.html",restrict:"E",controller:["$scope","$rootScope",function(b,c){c.toolsChecked=!1,c.$watch("toolsChecked",function(c){b.toolsChecked=c,a(function(){$("tool-panel").overlaps($("base-map-panel")).length>0?$("base-map-panel").hide():$("base-map-panel").show()},500)}),b.toolHeaderClick=function(a){c.toolsChecked=!a},b.toolChanged=function(a){require(["dojo/on"],function(c){angular.forEach(b.tools,function(a,b){a.highlighted=!1}),a.highlighted=!0,b.tool=a,"Identify"===a.title?b.webmap.clickEventHandle=c(b.map,"click",b.webmap.clickEventListener):b.webmap.clickEventHandle.remove()})}}],link:function(a,b,c){a.tools=[{icon:"info-sign",title:"Identify",highlighted:!0,height:60,width:300},{icon:"hand-up",title:"Property Select",highlighted:!1,height:180,width:280},{icon:"road",title:"Streetview",highlighted:!1,height:300,width:320},{icon:"picture",title:"Oblique",highlighted:!1,height:300,width:320},{icon:"resize-horizontal",title:"Measure",highlighted:!1,height:200,width:300},{icon:"bookmark",title:"Bookmarks",highlighted:!1,height:240,width:300},{icon:"pencil",title:"Draw",highlighted:!1,height:200,width:300},{icon:"print",title:"Print",highlighted:!1,height:270,width:300},{icon:"trash",title:"Clear Map",highlighted:!1,height:34,width:300}],a.tool=a.tools[0]}}}]),angular.module("imapsNgApp").directive("baseMapPanel",["$timeout",function(a){return{templateUrl:"directives/baseMapPanel/baseMapPanel.html",restrict:"E",controller:["$scope","$rootScope","$filter","$analytics",function(a,b,c,d){var e=!1;a.insideRaleigh=!0,b.mapsChecked=!1,a.basemapType="streets",b.$watch("config",function(b){b&&(a.basemap=b.map.basemaps.streets.layers[0],a.streetMap=a.basemap)}),b.$watch("mapsChecked",function(b){a.mapsChecked=b}),a.showAerial=function(b){return b.county&&!a.insideRaleigh||a.insideRaleigh},a.mapsHeaderClick=function(a){b.mapsChecked=!a},a.$on("raleighChecked",function(b,d){if(a.insideRaleigh=d,"images"===a.basemapType)if(d)a.lastRaleighYear?(a.basemap=a.lastRaleighYear,a.basemapChanged(a.lastRaleighYear,"images")):(a.basemap=a.config.map.basemaps.images.layers[0],a.basemapChanged(a.basemap,"images")),a.lastRaleighYear=a.basemap;else{if(a.lastWakeYear)a.basemap=a.lastWakeYear,a.basemapChanged(a.lastWakeYear,"images");else{var e=c("filter")(a.config.map.basemaps.images.layers,function(a){return a.county===!0});a.basemap=e[0],a.basemapChanged(a.basemap,"images")}a.lastWakeYear=a.basemap}}),a.basemapTypeClicked=function(b){if(a.basemapType!=b)if("streets"===b)a.basemap=a.streetMap;else if("images"===b)if(a.imageMap)a.basemap=a.imageMap;else if(a.inRaleigh)a.basemap=a.config.map.basemaps.images.layers[0],a.imageMap=a.basemap;else{var d=c("filter")(a.config.map.basemaps.images.layers,function(a){return a.county===!0});a.basemap=d[0],a.imageMap=a.basemap}a.basemapChanged(a.basemap,b),a.basemapType=b},a.basemapChanged=function(b,c){d.eventTrack("Changed",{category:"Basemaps",label:b.id}),require(["esri/basemaps"],function(d){e||(a.map.getLayer("base0")&&a.map.getLayer("base0").setVisibility(!1),a.map.getLayer("base1")&&a.map.getLayer("base1").setVisibility(!1),a.map.getLayer("BaseMapMobile_48")&&a.map.getLayer("BaseMapMobile_48").setVisibility(!1)),a.map.setBasemap(b.id),"streets"===c?a.streetMap=b:"images"===c&&(a.imageMap=b),a.webmap.itemInfo.itemData.baseMap=d[b.id],b.county?a.lastWakeYear=b:a.lastRaleighYear=b})}}],link:function(a,b,c){}}}]),angular.module("imapsNgApp").directive("overviewPanel",["$timeout",function(a){return{templateUrl:"directives/overviewPanel/overviewPanel.html",restrict:"E",controller:["$scope","$rootScope",function(a,b){b.overviewChecked=!1,b.$watch("overviewChecked",function(b){a.overviewChecked=b}),a.overviewHeaderClick=function(c){b.overviewChecked=!c,c?a.overview.hide():a.overview.show()},a.$watch("map",function(b){b&&require(["esri/dijit/OverviewMap","esri/layers/ArcGISTiledMapServiceLayer"],function(c,d){a.overview=new c({map:b,baseLayer:new d(a.config.map.basemaps.streets.layers[0].url),visible:!0,width:180,height:180},"overview"),a.overview.startup(),a.overview.hide()})})}],link:function(a,b,c){}}}]),angular.module("imapsNgApp").directive("search",function(){return{templateUrl:"directives/sidePanel/search/search.html",restrict:"EA",controller:["$scope","$rootScope",function(a,b){b.searches=[{label:"For Property",value:"property"},{label:"For Location",value:"location"}],b.selectedSearch=b.searches[0]}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("propertySearch",function(){return{templateUrl:"directives/sidePanel/propertySearch/propertySearch.html",restrict:"E",controller:["$scope","$rootScope","$timeout","property","$analytics",function(a,b,c,d,e){a.hiddenOverflow=!1,a.property=d;var f="https://maps.raleighnc.gov/arcgis/rest/services/Parcels/MapServer/exts/PropertySOE/AutoComplete",g=function(a){var b=[];return a.Results.length>0&&angular.forEach(a.Results,function(a){b.push({value:a})}),b};a.tabChanged=function(b){angular.forEach(a.tabs,function(a,c){c>0&&(a.disabled=b),a.highlighted=!1}),a.tab.highlighted=!0},a.$on("accountSelected",function(b,c){a.tabChanged(!1)}),b.$on("accountUpdate",function(d,e){1===e.length?(a.tab=a.tabs[1],a.pin=e[0].pin,a.reid=e[0].reid,a.account=e[0],b.$broadcast("pinUpdate",a.pin),c(function(){a.$broadcast("accountSelected",e[0])})):(a.tab=a.tabs[0],a.tabChanged(!0))});var h=function(c,d,e){e="streetname"===e?"street name":e,a.property.getRealEstate(e,[d.value]).then(function(c){a.account=null,a.fields=c.Fields,a.accounts=c.Accounts,a.accountsSrc=c.Accounts,b.$broadcast("accountUpdate",a.accounts)})},i=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.value)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:f+"?type=address&f=json",filter:g,replace:function(a,b){b=b.replace(/\'/g,"''").toUpperCase();var c=a+"&input="+b;return c}}}),j=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.value)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:f+"?type=owner&f=json",filter:g,replace:function(a,b){b=b.replace(/\'/g,"''").toUpperCase();var c=a+"&input="+b;return c}}}),k=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.value)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:f+"?type=pin&f=json&limit=5",filter:g,replace:function(a,b){b=b.replace(/\'/g,"''").toUpperCase();var c=a+"&input="+b;return c}}}),l=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.value)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:f+"?type=reid&f=json&limit=5",filter:g,replace:function(a,b){b=b.replace(/\'/g,"''").toUpperCase();var c=a+"&input="+b;return c}}}),m=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.value)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:f+"?type=street name&f=json&limit=5",filter:g,replace:function(a,b){b=b.replace(/\'/g,"''").toUpperCase();var c=a+"&input="+b;return c}}});i.initialize(),j.initialize(),k.initialize(),l.initialize(),m.initialize(),a.autocomplete={displayKey:"value",source:i.ttAdapter()},a.searchValue=null,$("#searchInput").typeahead({hint:!0,highlight:!0,minLength:3},{name:"address",displayKey:"value",source:i.ttAdapter(),templates:{header:"<h5>Addresses</h5>"}},{name:"owner",displayKey:"value",source:j.ttAdapter(),templates:{header:"<h5>Owners</h5>"}},{name:"pin",displayKey:"value",source:k.ttAdapter(),templates:{header:"<h5>PIN</h5>"}},{name:"reid",displayKey:"value",source:l.ttAdapter(),templates:{header:"<h5>Real Estate ID</h5>"}},{name:"streetname",displayKey:"value",source:m.ttAdapter(),templates:{header:"<h5>Street</h5>"}}).on("typeahead:selected",h);var n=function(b){angular.forEach(a.tabs,function(a){a.highlighted=!1}),b.highlighted=!0},o=function(b){switch(b.title){case"Results":break;case"Info":break;case"Photos":a.property.getPhotos(a.account.reid).then(function(b){a.photos=b.Photos});break;case"Deeds":a.property.getDeeds(a.account.reid).then(function(b){a.deeds=b.Deeds,a.plats=[],angular.forEach(a.deeds,function(b){b.bomDocNum&&a.plats.push(b)})});break;case"Tax Info":window.open("http://services.wakegov.com/realestate/Account.asp?id="+a.account.reid,"_blank");break;case"Services":a.$broadcast("servicesClicked",a.geometry);break;case"Addresses":a.property.getAddresses(a.account.pin,a.account.reid).then(function(b){a.addresses=b.Addresses})}};a.tabClicked=function(b){b.disabled||(a.tab=b,n(b),o(b))},a.clearTypeahead=function(){$("#searchInput").typeahead("val","")}}],link:function(a,b,c){a.tabs=[{icon:"list",title:"Results",highlighted:!0,disabled:!1,table:!0},{icon:"info-sign",title:"Info",highlighted:!1,disabled:!0,table:!0},{icon:"camera",title:"Photos",highlighted:!1,disabled:!0,table:!1},{icon:"file",title:"Deeds",highlighted:!1,disabled:!0,table:!1},{icon:"usd",title:"Tax Info",highlighted:!1,disabled:!0,table:!1},{icon:"flag",title:"Services",highlighted:!1,disabled:!0,table:!1},{icon:"home",title:"Addresses",highlighted:!1,disabled:!0,table:!0}],a.tab=a.tabs[0]}}}),angular.module("imapsNgApp").directive("propertyResults",function(){return{templateUrl:"directives/sidePanel/propertySearch/propertyResults/propertyResults.html",restrict:"E",controller:["$scope","$timeout","$window",function(a,b,c){a.resultHeader=[],a.accounts=[],a.$on("accountUpdate",function(b,c){a.accounts=c,a.resultGrid.data=c,a.resultHeader=[],angular.forEach(a.fields,function(b){a.resultHeader.push(b.alias)})}),a.resultGrid={data:a.accounts,showGridShowPerPage:!1,showGridSearch:!1,pageSize:1e4,pageSizes:[1e4],height:$(".tabcontainer").height()-62,columnDefs:[{field:"siteAddress",displayName:"Address"},{field:"owner",displayName:"Owner"},{field:"pin",displayName:"PIN"}],rowClick:function(b){a.resultClicked(b)}},a.$watch("accounts",function(a){}),a.resultClicked=function(b){a.account=b,a.tab=a.tabs[1],a.$broadcast("accountSelected",b)};var d=angular.element(c);a.getWindowDimensions=function(){return{h:d.height(),w:d.width()}},a.$watch(a.getWindowDimensions,function(a,b){$(".ngReactGridViewPort").css("max-height",$(".tabcontainer").height()-70),$(".ngReactGridViewPort").css("min-height",$(".tabcontainer").height()-70)},!0),d.bind("resize",function(){a.$apply()})}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("propertyInfo",function(){return{templateUrl:"directives/sidePanel/propertySearch/propertyInfo/propertyInfo.html",restrict:"E",controller:["$scope","$filter","$timeout","$rootScope","property",function(a,b,c,d,e){a.accountInfo=[];var f=function(b){a.accountInfo=[],a.tabChanged(!1),a.pin=b.pin,a.reid=b.reid,d.$broadcast("pinUpdate",b.pin),angular.forEach(a.fields,function(c){a.accountInfo.push({field:c.alias,value:b[c.field]})}),d.accountInfo=a.accountInfo},g=function(b){e.getSepticPermits(b).then(function(c){c.SepticPermits.length>0&&angular.forEach(c.SepticPermits,function(b){a.accountInfo.push({field:"Septic Permit",value:b.permitNumber})}),h(b)})},h=function(b){e.getWellResults(b).then(function(d){d.WellResults.length>0&&a.accountInfo.push({field:"Well Samples",value:b}),c(function(){a.infoGrid.data=a.accountInfo})})};a.account&&!a.accountInfo&&f(a.account),a.$on("accountSelected",function(b,c){d.account=c,f(c),"RALEIGH"===c.city&&a.accountInfo.push({field:"Crime",value:"http://www.crimemapping.com/Map/Find/"+c.siteAddress+","+c.city+",NC"}),g(c.pin)}),a.infoGrid={data:a.accountInfo,showGridShowPerPage:!1,showGridSearch:!1,pageSize:100,pageSizes:[100],height:$(".tabcontainer").height()-62,columnDefs:[{field:"field",displayName:"Field",sort:!1},{field:"value",displayName:"Value",sort:!1,render:function(a){return"Septic Permit"===a.field?React.DOM.a({className:"ps-link",href:"http://gisasp2.wakegov.com/imaps/RequestedPermit.aspx?permit="+a.value,target:"_blank"},a.value+" ",React.DOM.span({className:"glyphicon glyphicon-new-window"})):"Well Samples"===a.field?React.DOM.a({className:"ps-link",href:"http://justingreco.github.io/water-analysis/app/index.html#/?pin="+a.value,target:"_blank"},"View ",React.DOM.span({className:"glyphicon glyphicon-new-window"})):"Crime"===a.field?React.DOM.a({className:"ps-link",href:a.value,target:"_blank"},"View ",React.DOM.span({className:"glyphicon glyphicon-new-window"})):void 0}}]},a.toggleProperty=function(b){var c=a.accounts.indexOf(a.account),d=b?c+1:c-1;-1===d?d=a.accounts.length-1:d===a.accounts.length&&(d=0),a.account=a.accounts[d],a.$broadcast("accountSelected",a.account)}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("propertyPhotos",function(){return{templateUrl:"directives/sidePanel/propertySearch/propertyPhotos/propertyPhotos.html",restrict:"E",controller:["$scope",function(a){}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("propertyDeeds",function(){return{templateUrl:"directives/sidePanel/propertySearch/propertyDeeds/propertyDeeds.html",restrict:"E",controller:["$scope",function(a){}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("propertyTaxes",function(){return{templateUrl:"directives/sidePanel/propertySearch/propertyTaxes/propertyTaxes.html",restrict:"E",controller:["$scope",function(a){}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("propertyServices",function(){return{templateUrl:"directives/sidePanel/propertySearch/propertyServices/propertyServices.html",restrict:"E",controller:["$scope","property","$filter","mapUtils",function(a,b,c,d){var e=function(a,b){for(var d=a.split("[").length-1,e=/\[(.*?)\]/,f=null,g=0;d>g;g++)f=e.exec(a),f[0].indexOf(":proper")>-1?(f[1]=f[1].replace(/:proper/g,""),a=a.replace(f[0],c("titleCase")(b[f[1]]).replace("Nc","NC"))):a=a.replace(f[0],b[f[1]]);return a},f=function(a,b){return c("filter")(a,function(a){return a.layerId===b})},g=function(b){angular.forEach(a.config.services.categories,function(c){var d={title:c.title,services:[]};angular.forEach(c.services,function(a){var c=f(b.results,a.layerId);if(c.length>0){var g={title:e(a.title,c[0].attributes),items:[]};angular.forEach(c,function(b){var c=a.labels.split(";");angular.forEach(c,function(a){var c=e(a,b.attributes)+"<br/>";-1===g.items.indexOf(c)&&g.items.push(c)})}),g.items.length>0&&d.services.push(g)}}),d.services.length>0&&a.propertyServices.categories.push(d)})};a.$on("servicesClicked",function(c,d){a.propertyServices={categories:[]},require(["esri/geometry/geometryEngine","esri/geometry/Polygon"],function(c,e){d.type||(d=new e(d));var f=c.buffer(d,-5,9002,!0);b.getServices(f,a.map.extent,a.map.width,a.map.height).then(function(a){g(a)})})})}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("propertyAddresses",function(){return{templateUrl:"directives/sidePanel/propertySearch/propertyAddresses/propertyAddresses.html",restrict:"E",controller:["$scope",function(a){a.rpid=null,a.raleighCols=[{field:"address",displayName:"Address"},{field:"type",displayName:"Type"},{field:"status",displayName:"Status"}],a.wakeCols=[{field:"address",displayName:"Address"}],a.addrGrid={data:[],showGridShowPerPage:!1,showGridSearch:!1,pageSize:1e4,pageSizes:[1e4],height:$(".tabcontainer").height()-62,columnDefs:a.raleighCols},a.$watch("addresses",function(b){b&&b.length>0&&(a.addrGrid.data=b,b[0].rpidMap?(a.addrGrid.columnDefs=a.raleighCols,a.rpid=b[0].rpidMap+" "+b[0].rpidLot,angular.forEach(b,function(a){a.suite.trim().length>0&&(a.address+=", STE "+a.suite)})):(a.addrGrid.columnDefs=a.wakeCols,a.rpid=null))})}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("locationSearch",function(){return{templateUrl:"directives/sidePanel/locationSearch/locationSearch.html",restrict:"E",controller:["$scope",function(a){}],link:function(a,b,c){a.locationSearchTypes=[{label:"Address",value:"address"},{label:"Intersection",value:"intersection"},{label:"Place of Interest",value:"poi"},{label:"Subdivision",value:"subdivision"},{label:"Coordinate",value:"coordinate"}],a.locationSearchType=a.locationSearchTypes[0]}}}),angular.module("imapsNgApp").directive("addressSearch",function(){return{templateUrl:"directives/sidePanel/locationSearch/addressSearch/addressSearch.html",restrict:"EA",controller:["$scope","locationFactory",function(a,b){a.geocodeAddress=function(){b.geocodeAddress(a.streetAddress).then(function(b){b.candidates.length>0&&a.map.centerAndZoom(b.candidates[0].location,10)})}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("intersectionSearch",function(){return{templateUrl:"directives/sidePanel/locationSearch/intersectionSearch/intersectionSearch.html",restrict:"EA",controller:["$scope","$http","locationFactory",function(a,b,c){a.primaryStreet=null,a.primaryStreets=function(a){return c.getStreets(a).then(function(a){return a.features})},a.primaryStreetSelected=function(b,d,e){c.getIntersectingStreets(b.geometry).then(function(b){a.intersectingStreets=b.features})},a.intersectionSelected=function(){c.geocodeAddress(a.primaryStreet.attributes.CARTONAME+" & "+a.intersectingStreet.attributes.CARTONAME).then(function(b){b.candidates.length>0&&a.map.centerAndZoom(b.candidates[0].location,10)})}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("poiSearch",function(){return{templateUrl:"directives/sidePanel/locationSearch/poiSearch/poiSearch.html",restrict:"EA",controller:["$scope","locationFactory",function(a,b){a.places=[],a.placeTypes=[],b.getPlaceTypes().then(function(b){a.placeTypes=[],angular.forEach(b.features,function(b){a.placeTypes.push(b.attributes.ICON)})}),a.placeTypeSelected=function(c){b.getPlacesByType(c).then(function(b){a.places=b.features})},a.placeSelected=function(b){a.map.centerAndZoom(b.geometry,11)}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("subdivisionSearch",function(){return{templateUrl:"directives/sidePanel/locationSearch/subdivisionSearch/subdivisionSearch.html",restrict:"EA",controller:["$scope","$http","locationFactory",function(a,b,c){a.subdivisions=function(a){return c.getSubdivision(a).then(function(a){return a.features})},a.subdivisionSelected=function(b,c,d){require(["esri/geometry/Polygon"],function(c){var d=new c(b.geometry);d.spatialReference=a.map.spatialReference,a.map.setExtent(d.getExtent(),!0)})}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("coordinateSearch",function(){return{templateUrl:"directives/sidePanel/locationSearch/coordinateSearch/coordinateSearch.html",restrict:"EA",controller:["$scope","mapUtils",function(a,b){a.coordinateTypes=[{label:"Decimal Degrees",xLabel:"Longitude",yLabel:"Latitude",wkid:4326,xmin:-79,xmax:-78.2,ymin:35.5,ymax:36.1,xPrompt:-78.643,yPrompt:35.778},{label:"Stateplane Feet",xLabel:"Easting",yLabel:"Northing",wkid:2264,xmin:1998e3,xmax:2222e3,ymin:644e3,ymax:848e3,xPrompt:2105888,yPrompt:738558}],a.coordinateType=a.coordinateTypes[0],a.zoomToCoordinate=function(){require(["esri/geometry/Point"],function(c){var d=null;a.coordinateType.wkid===a.map.spatialReference.wkid?(d=new c({x:a.coordinate.x,y:a.coordinate.y,spatialReference:{wkid:a.coordinateType.wkid}}),a.map.centerAndZoom(d,11)):b.project(a.config.map.geometryServiceUrl,{geometryType:"esriGeometryPoint",geometries:[{x:a.coordinate.x,y:a.coordinate.y}]},a.coordinateType.wkid,a.map.spatialReference.wkid).then(function(b){b.geometries.length>0&&(d=b.geometries[0],a.map.centerAndZoom(d,11))}),a.map.centerAndZoom(d,11)})}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("layerList",["$timeout","$window","$filter","legend","localStorageService",function(a,b,c,d,e){return{templateUrl:"directives/sidePanel/layerList/layerList.html",restrict:"EA",controller:["$scope",function(a){var b=function(b){d.getLegend(b.url,b.id).then(function(b){var d=c("filter")(a.layers,function(a){return a.id===b.id})[0];angular.forEach(d.resourceInfo.layers,function(a,c){b.layers[c]&&(a.legend=b.layers[c].legend)})})};a.$watch("webmap",function(c){c&&(a.layers=c.itemInfo.itemData.operationalLayers,angular.forEach(a.layers,function(a){a.visibility&&b(a)}))}),a.layerToggle=function(c,d){c.visibility=!c.visibility,a.map.getLayer(c.id).setVisibility(c.visibility),c.visibility&&!c.resourceInfo.layers[0].legend&&b(c)},a.subLayerToggle=function(b,c,d){var e=[];c.defaultVisibility=!c.defaultVisibility,e=a.map.getLayer(b.id).visibleLayers,c.defaultVisibility?e.push(c.id):e.splice(e.indexOf(c.id),1),0===e.length&&(e=[-1]),b.layerObject.visibleLayers=e,b.layerObject._defaultVisibleLayers=e,a.webmap.itemInfo.itemData.operationalLayers=a.layers,a.map.getLayer(b.id).setVisibleLayers(e)},a.opacityChanged=function(b,c){a.map.getLayer(b.id).setOpacity(b.opacity)},a.translate=function(a){return(100*a).toFixed(0)+"%"}}],link:function(a,b,c){}}}]).factory("legend",["$http","$q",function(a,b){function c(c,d){var e=b.defer();return a({method:"GET",url:c+"/legend",params:{f:"json"}}).success(function(a){a.id=d,e.resolve(a)}),e.promise}var d={getLegend:c};return d}]),angular.module("imapsNgApp").directive("bookmarkTool",function(){return{templateUrl:"directives/toolPanel/bookmarkTool/bookmarkTool.html",restrict:"E",controller:["$scope","localStorageService",function(a,b){a.bookmarkName="";var c=function(){b.set("bookmarks",a.config.tools.bookmarks)};b.get("bookmarks")?a.config.tools.bookmarks=b.get("bookmarks"):c(),
a.bookmarkDisabled=function(){return a.bookmarkName.length<1},a.goToBookmark=function(b){require(["esri/geometry/Extent"],function(c){var d=new c(b.extent);a.map.setExtent(d,!0)})},a.addBookmark=function(b){var d={name:b,extent:{xmin:a.map.extent.xmin,ymin:a.map.extent.ymin,xmax:a.map.extent.xmax,ymax:a.map.extent.ymax,spatialReference:{wkid:a.map.spatialReference.wkid}}};a.config.tools.bookmarks.push(d),a.bookmarkName="",c()},a.deleteBookmark=function(b){a.config.tools.bookmarks.splice(b,1),c()}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("clearTool",function(){return{templateUrl:"directives/toolPanel/clearTool/clearTool.html",restrict:"E",controller:["$scope",function(a){a.$watch("tool",function(b){if("Clear Map"===b.title){var c=null;a.map.graphics.clear(),angular.forEach(a.map.graphicsLayerIds,function(b){c=a.map.getLayer(b).clear()})}})}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("drawTool",function(){return{templateUrl:"directives/toolPanel/drawTool/drawTool.html",restrict:"E",controller:["$scope",function(a){var b,c,d,e,f,g;a.drawText="";var h=function(b){require(["esri/units","esri/graphic"],function(h,i){var j=new i(b.geometry);j.setAttributes({GraphicsLayer:"Drawing Graphics Layer"}),"polygon"===b.geometry.type?j.setSymbol(c):"polyline"===b.geometry.type?j.setSymbol(d):"point"===b.geometry.type&&("Point"===a.drawType.name?j.setSymbol(e):"Text"===a.drawType.name&&(console.log(a.drawText),f.setText(a.drawText),j.setSymbol(f),j.setAttributes({GraphicsLayer:"Drawing Graphics Layer",label:a.drawText}))),g.add(j)})},i=function(){require(["esri/toolbars/draw","esri/layers/GraphicsLayer","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/TextSymbol","dojo/on"],function(i,j,k,l,m,n,o){g=new j({id:"drawGraphics"}),a.map.addLayer(g),c=new l({type:"esriSFS",style:"esriSFSNull",color:[31,117,254,40],outline:{type:"esriSLS",style:"esriSLSSolid",color:[255,0,0,200],width:3}}),d=new m({type:"esriSLS",style:"esriSLSSolid",color:[255,0,0,200],width:3}),e=new k({color:[255,0,0,200],size:12,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[0,0,0,255],width:1,type:"esriSLS",style:"esriSLSSolid"}}),f=new n({type:"esriTS",color:[255,0,0,255],backgroundColor:null,borderLineColor:null,verticalAlignment:"middle",horizontalAlignment:"center",rightToLeft:!1,angle:0,xoffset:0,yoffset:0,font:{family:"Arial",size:12,style:"normal",weight:"bold",decoration:"none"}}),b=new i(a.map),b.setFillSymbol(c),b.setLineSymbol(d),b.setMarkerSymbol(e),o(b,"draw-end",h)})};a.undo=function(){g.remove(g.graphics[g.graphics.length-1])},a.$watch("map",function(a){a&&i()}),a.$watch("drawType",function(c){c&&(b.activate(c.shape),a.tool.height="Text"===c.name?246:136)}),a.$watch("tool",function(c){"Draw"===c.title?(b||(b=new Draw(a.map)),a.drawType?c.height="Text"===a.drawType.name?246:136:c.height=136):b&&(b.deactivate(),a.drawType=null)})}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("identifyTool",function(){return{templateUrl:"directives/toolPanel/identifyTool/identifyTool.html",restrict:"E",controller:["$scope",function(a){}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("measureTool",function(){return{templateUrl:"directives/toolPanel/measureTool/measureTool.html",restrict:"E",controller:["$scope","$filter","$timeout",function(a,b,c){var d,e,f,g,h,i,j=0,k=0,l=0,m=null,n=null,o=null,p=null,q=null;a.measurement="--",a.currentCoords="";var r=function(a,b,c){var d=spToDd(a,b),e="";if("FEET"===c)e=b.toFixed(4)+" N "+a.toFixed(4)+" E";else if("DECIMAL_DEGREES"===c)e="Lat: "+d[0].toFixed(6)+" Lng: "+d[1].toFixed(6);else if("DEGREE_MINUTE_SECONDS"===c){var f=new GeoPoint(d[1],d[0]);e=f.getLatDeg()+" "+f.getLonDeg()}return e},s=function(b,d){require(["esri/geometry/geometryEngine"],function(e){var f=null;i=b,"polygon"===b.type?f=e.planarArea(b,d).toFixed(2):"polyline"===b.type?(f=e.planarLength(b,d).toFixed(2),u()):"point"===b.type&&(f=r(b.x,b.y,d)),c(function(){a.measurement=f})})},t=function(b){var c=a.unit.wkid;require(["esri/units","esri/graphic"],function(a,h){var i=new h(b.geometry);"polygon"===b.geometry.type?(s(b.geometry,c),i.setSymbol(d)):"polyline"===b.geometry.type?(s(b.geometry,c),i.setSymbol(e)):"point"===b.geometry.type&&(s(b.geometry,c),i.setSymbol(f)),g.clear(),g.add(i)})},u=function(){o&&(o.remove(),o=null),m=null,j=0,k=0,l=0},v=function(b){require(["dojo/on"],function(c){m=b.mapPoint,l+=k,o||(o=c(a.map,"mouse-move",y))})},w=function(b){require(["esri/geometry/Polyline","esri/geometry/geometryEngine"],function(d,e){var f=new d(a.map.spatialReference);f.addPath([m,b]),k=e.planarLength(f,a.unit.wkid),j=l+k,c(function(){a.measurement=j.toFixed(2)})})},x=function(a,b){var c=new Qty(j+b.abbr);j=c.to(a.abbr).scalar,c=new Qty(k+b.abbr),k=c.to(a.abbr).scalar,c=new Qty(l+b.abbr),l=c.to(a.abbr).scalar},y=function(a){w(a.mapPoint)},z=function(){require(["dojo/on"],function(b){n=b(a.map,"click",v)})},A=function(b,d){var e=r(b.x,b.y,d);c(function(){a.currentCoords=e})},B=function(){p&&(p.remove(),p=null,q=null)},C=function(){require(["dojo/on"],function(b){p=b(a.map,"mouse-move",function(b){q=b.mapPoint,A(b.mapPoint,a.unit.wkid)})})},D=function(){require(["esri/toolbars/draw","esri/layers/GraphicsLayer","esri/symbols/PictureMarkerSymbol","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","dojo/on"],function(b,c,i,j,k,l){g=new c,a.map.addLayer(g),d=new j({type:"esriSFS",style:"esriSFSSolid",color:[31,117,254,40],outline:{type:"esriSLS",style:"esriSLSSolid",color:[31,117,254,200],width:3}}),e=new k({type:"esriSLS",style:"esriSLSSolid",color:[31,117,254,255],width:3}),f=new i({url:"images/esriGreenPin16x26.af30506b.png",height:26,width:16,type:"esriPMS"}),h=new b(a.map),h.setFillSymbol(d),h.setLineSymbol(e),h.setMarkerSymbol(f),l(h,"draw-end",t)})};a.$watch("map",function(a){a&&D()}),a.units=[{label:"Feet",name:"FEET",wkid:9002,type:"length",active:!0,multiplier:3.28084,abbr:"ft"},{label:"Miles",name:"MILES",wkid:9035,type:"length",active:!1,multiplier:621371e-9,abbr:"mi"},{label:"Meters",name:"METERS",wkid:9001,type:"length",active:!1,multiplier:1,abbr:"m"},{label:"Kilometers",name:"KILOMETERS",wkid:9036,type:"length",active:!1,multiplier:.001,abbr:"km"},{label:"Yards",name:"YARDS",wkid:109002,type:"length",active:!1,multiplier:1.09361,abbr:"yd"},{label:"Square Feet",name:"SQUARE_FEET",wkid:109405,type:"area",active:!0,multiplier:10.7639,abbr:"ft²"},{label:"Acres",name:"ACRES",wkid:109403,type:"area",active:!1,multiplier:247105e-9,abbr:"acre"},{label:"Square Miles",name:"SQUARE_MILES",wkid:109413,type:"area",active:!1,multiplier:3.86102e-7,abbr:"mi²"},{label:"Square Meters",name:"SQUARE_METERS",wkid:109404,type:"area",active:!1,multiplier:1,abbr:"m²"},{label:"Square Kilometers",name:"KILOMETERS",wkid:109414,type:"area",active:!1,multiplier:1e-6,abbr:"km²"},{label:"Square Yards",name:"SQUARE_YARDS",wkid:109443,type:"area",active:!1,abbr:"yd²"},{label:"Decimal Degrees",wkid:"DECIMAL_DEGREES",type:"coordinates",active:!0},{label:"Degrees Minutes Seconds",wkid:"DEGREE_MINUTE_SECONDS",type:"coordinates",active:!1},{label:"Feet",wkid:"FEET",type:"coordinates",active:!1}],a.filterUnits=function(b){return a.measureType?b.type===a.measureType.type:void 0},a.$watch("measureType",function(c){if("Measure"===a.tool.title)if(c){a.tool.height=250;var d=b("filter")(a.units,function(a){return a.type===c.type&&a.active});d.length>0&&(a.unit=d[0]),h.activate(c.shape),"polyline"===c.shape?z():(u(),n&&(n.remove(),n=null)),"coordinates"===c.type?C():B(),i=null,a.measurement="--",g.clear()}else a.tool.height=88}),a.$watch("unit",function(c,d){if(a.measureType){var e=b("filter")(a.units,function(b){return a.measureType.type===b.type});angular.forEach(e,function(a){a.active=!1}),c.active=!0,i&&s(i,a.unit.wkid),"polyline"===a.measureType.shape&&d&&x(c,d),"coordinates"===a.measureType.type&&q&&A(q,a.unit.wkid)}}),a.$watch("tool",function(b){"Measure"===b.title?(h||(h=new Draw(a.map)),a.measureType?b.height=250:b.height=88):h&&(h.deactivate(),a.measureType=null,u(),B(),n&&(n.remove(),n=null))})}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("printTool",["cfpLoadingBar",function(a){return{templateUrl:"directives/toolPanel/printTool/printTool.html",restrict:"E",controller:["$scope","$rootScope","$filter","$http",function(b,c,d,e){b.printAtts=!1,b.printTitle="",b.printSizes=[{value:"8.5x11",label:'8.5"x11"'},{value:"11x17",label:'11"x17"'},{value:"24x36",label:'24"x36"'},{value:"36x48",label:'36"x48"'}],b.printSize=b.printSizes[0],b.printOrients=[{value:"landscape",label:"Landscape"},{value:"portait",label:"Portait"}],b.printOrient=b.printOrients[0],b.printScales=[{label:"Current Scale",value:0,current:!0},{label:"1\" = 50'",value:600},{label:"1\" = 100'",value:1200},{label:"1\" = 200'",value:2400},{label:"1\" = 400'",value:4800},{label:"1\" = 800'",value:9600},{label:"1\" = 1,600'",value:17200},{label:"1\" = 3,200'",value:38400},{label:"1\" = 6,400'",value:76800},{label:"1\" = 12,800'",value:153600},{label:"1\" = 25,600'",value:307200},{label:"Custom",value:void 0,custom:!0}],b.printScale=b.printScales[0];var f=function(a){var c=b.map.getLayer("drawGraphics"),d=0,e=0,f=0,g=0,h={geometryType:"esriGeometryPoint",features:[]},i={geometryType:"esriGeometryPolyline",features:[]},j={geometryType:"esriGeometryPolygon",features:[]},k={geometryType:"esriGeometryPoint",features:[]};return c&&angular.forEach(c.graphics,function(a){switch(a.symbol.type){case"simplemarkersymbol":h.features.push({geometry:a.geometry,attributes:a.attributes}),d+=1;break;case"simplelinesymbol":i.features.push({geometry:a.geometry,attributes:a.attributes}),e+=1;break;case"simplefillsymbol":j.features.push({geometry:a.geometry,attributes:a.attributes}),f+=1;break;case"textsymbol":k.features.push({geometry:a.geometry,attributes:a.attributes}),g+=1}}),a.Graphic_Points=stringify(h),a.Graphic_Lines=stringify(i),a.Graphic_Polygons=stringify(j),a.Graphic_Labels=stringify(k),a.Graphics_Count=d+";"+e+";"+f+";"+g+";",a},g=function(){var a="";return b.$parent.accountInfo&&b.printAtts&&angular.forEach(b.$parent.accountInfo,function(b){a+=b.field+": "+b.value+";"}),a},h=function(){var a="";return b.$parent.account&&(a+=b.$parent.account.pin+";"),b.accounts&&angular.forEach(b.accounts,function(c,d){a+=d<b.accounts.length-1?c.pin+",":c.pin}),a},i=function(a){var c=b.printScale.value;return b.printScale.current?c=parseInt(a.getScale(b.map)):b.printScale.custom&&(c=12*c),c};b.printPDF=function(c,e){$("#printBtn").button("loading"),a.start();var e="",j="",k="",l="",m="";angular.forEach(b.webmap.itemInfo.itemData.baseMap.baseMapLayers,function(a){var b=a.url.split("/"),c=b[b.length-2];console.log(c),e+=c+";",j+=";",k+="1;",l+="tiled;",m+=";"});var n=d("filter")(b.webmap.itemInfo.itemData.operationalLayers,function(a){return a.visibility===!0});console.log(n),angular.forEach(n,function(a){e+=a.id.split("_")[0]+";",k+=100-100*a.opacity+";",l+="dynamic;",m+=";";for(var b=d("filter")(a.resourceInfo.layers,function(a){return a.defaultVisibility===!0}),c=0;c<b.length;c++)j+=c===b.length-1?b[c].id+";":b[c].id+",";0===b.length&&(j+=";")}),require(["esri/geometry/scaleUtils","esri/tasks/Geoprocessor"],function(c,d){var n=new d(b.config.tools.print.url),o={Title:b.printTitle,Size:b.printSize.value,Orientation:b.printOrient.value,Services:e,Types:l,Visible_Layers:j,Definition_Expressions:m,Transparency_Values:k,Extent:b.map.extent.xmin+";"+b.map.extent.ymin+";"+b.map.extent.xmax+";"+b.map.extent.ymax+";",Scale:i(c),PIN:h(),Attributes:g()};o=f(o),console.log(o),n.submitJob(o,function(b){console.log(b),n.getResultData(b.jobId,"Output_URL",function(b){$("#printBtn").button("reset"),a.complete(),window.open(b.value)})})})}}],link:function(a,b,c){}}}]),angular.module("imapsNgApp").directive("selectTool",function(){return{templateUrl:"directives/toolPanel/selectTool/selectTool.html",restrict:"E",controller:["$scope","$rootScope","property","mapUtils",function(a,b,c,d){a.selectBufferDist=0,a.bufferProperty=function(){e(a.geometry,"esriGeometryPolygon")};var e=function(b,c){require(["esri/geometry/geometryEngine","esri/geometry/Polygon"],function(c,d){b.type||(b=new d(b));var e=c.buffer(b,parseInt(a.selectBufferDist),9002,!0);f(e,"esriGeometryPolygon",a.map.spatialReference.wkid)})},f=function(d,e,f){c.getPropertiesByGeometry(d,e,f).then(function(d){var e=[];angular.forEach(d.features,function(a){e.push(a.attributes.PIN_NUM)}),c.getRealEstate("pin",e).then(function(c){a.account=null,a.geometry=null,a.fields=c.Fields,a.accounts=c.Accounts,b.$broadcast("accountUpdate",c.Accounts)})})};require(["esri/toolbars/draw","dojo/on"],function(b,c){var d=null,g=function(b){d.deactivate(),a.selectType="",a.map.enableMapNavigation();var c="";switch(b.geometry.type){case"point":c="esriGeometryPoint";break;case"polygon":c="esriGeometryPolygon";break;case"polyline":c="esriGeometryPolyline";break;case"multipoint":c="esriGeometryMultipoint"}a.selectBufferDist>0?e(b.geometry,c):f(b.geometry,c,a.map.wkid)};a.selectTypeChanged=function(b){a.freehand&&-1===b.indexOf("point")&&(b="freehand"+b,a.map.disableMapNavigation()),d.activate(b)},a.$watch("geometry",function(b){"Property Select"===a.tool.title&&(a.tool.height=b?270:220)}),a.$watch("tool",function(e){"Property Select"===e.title?(e.height=a.geometry?270:220,d||(d=new b(a.map),c(d,"draw-end",g))):d&&(d.deactivate(),a.selectType="")})})}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("streetviewTool",function(){return{templateUrl:"directives/toolPanel/streetviewTool/streetviewTool.html",restrict:"E",controller:["$scope","$rootScope","$timeout",function(a,b,c){var d=null;a.streetviewFull=!1;var e=b.checked,f=function(a,b){var e=new google.maps.LatLng(a,b),f=new google.maps.StreetViewService;f.getPanoramaByLocation(e,50,function(a,b){if(b==google.maps.StreetViewStatus.OK){var e=(a.location.latLng,{position:a.location.latLng,imageDateControl:!0});d=new google.maps.StreetViewPanorama(document.getElementById("streetview")),d.setOptions(e),c(function(){google.maps.event.trigger(streetview,"resize")})}})},g=function(a){var b=spToDd(a.mapPoint.x,a.mapPoint.y);f(b[0],b[1])},h=null;a.$watch("tool",function(b){require(["dojo/on"],function(c){if("Streetview"===b.title){h=c(a.map,"click",g);var d=spToDd(a.map.extent.getCenter().x,a.map.extent.getCenter().y);f(d[0],d[1])}else h&&h.remove()})}),a.goFull=function(){$("app-header").hide(),a.streetviewFull=!0,$("#streetview").css("position","fixed").css("top",0).css("bottom",0).css("left",0).css("right",0).css("z-index",1e4).css("height","auto"),e=b.checked,b.checked=!1,google.maps.event.trigger(d,"resize")},a.minimizeStreetview=function(){$("app-header").show(),a.streetviewFull=!1,$("#streetview").css("position","relative").css("top",0).css("bottom",0).css("left",0).css("right",0).css("z-index",1e4).css("height","240px"),b.checked=e,google.maps.event.trigger(d,"resize")}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("obliqueTool",function(){return{templateUrl:"directives/toolPanel/obliqueTool/obliqueTool.html",restrict:"E",controller:["$scope","$rootScope","$timeout",function(a,b,c){var d=null;a.obliqueFull=!1;var e=b.checked,f=function(a,b){var e=new google.maps.LatLng(a,b),f={center:e,zoom:18,mapTypeId:google.maps.MapTypeId.SATELLITE,heading:0,tilt:45,overviewMapControl:!1,streetViewControl:!1,mapTypeControl:!1};d=new google.maps.Map(document.getElementById("obliqueMap"),f),c(function(){google.maps.event.trigger(d,"resize")})},g=function(a){var b=spToDd(a.mapPoint.x,a.mapPoint.y);f(b[0],b[1])},h=null;a.$watch("tool",function(b){require(["dojo/on"],function(c){if("Oblique"===b.title){h=c(a.map,"click",g);var d=spToDd(a.map.extent.getCenter().x,a.map.extent.getCenter().y);f(d[0],d[1])}else h&&h.remove()})}),a.goFullOblique=function(){$("app-header").hide(),a.obliqueFull=!0,$("#obliqueMap").css("position","fixed").css("top",0).css("bottom",0).css("left",0).css("right",0).css("z-index",1e4).css("height","auto"),e=b.checked,b.checked=!1,google.maps.event.trigger(d,"resize")},a.minimizeOblique=function(){$("app-header").show(),a.obliqueFull=!1,$("#obliqueMap").css("position","relative").css("top",0).css("bottom",0).css("left",0).css("right",0).css("z-index",1e4).css("height","240px"),b.checked=e,google.maps.event.trigger(d,"resize")}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").factory("config",["$http","$q",function(a,b){function c(c){var d=b.defer();return a({method:"GET",url:c}).success(d.resolve),d.promise}var d={loadConfig:c};return d}]),angular.module("imapsNgApp").factory("property",["$http","$q",function(a,b){function c(c,d){var e=b.defer();return a({method:"POST",url:m+"RealEstateSearch",data:$.param({type:c,values:JSON.stringify(d),f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(e.resolve),e.promise}function d(c){var d=b.defer();return a({method:"GET",url:m+"PhotoSearch",params:{reid:c,f:"json"}}).success(d.resolve),d.promise}function e(c){var d=b.defer();return a({method:"GET",url:m+"DeedSearch",params:{reid:c,f:"json"}}).success(d.resolve),d.promise}function f(c,d){var e=b.defer();return a({method:"GET",url:m+"AddressSearch",params:{pin:c,reid:d,f:"json"}}).success(e.resolve),e.promise}function g(c,d,e,f){var g=b.defer();return a({method:"POST",url:n+"/identify",data:$.param({f:"json",geometry:stringify(c),geometryType:"esriGeometryPolygon",layers:"all",tolerance:1,mapExtent:stringify(d),imageDisplay:e+","+f+",96",returnGeometry:!1}),headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"}}).success(g.resolve),g.promise}function h(c){var d=b.defer();return a({method:"GET",url:m+"SepticPermits",params:{pin:c,f:"json"}}).success(d.resolve),d.promise}function i(c){var d=b.defer();return a({method:"GET",url:m+"WellResults",params:{pin:c,f:"json"}}).success(d.resolve),d.promise}function j(c,d){var e=b.defer();return a({method:"POST",url:o+"/0/query",data:$.param({where:c,returnGeometry:!0,outSR:d,f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(e.resolve),e.promise}function k(c,d,e){var f=b.defer();return a({method:"POST",url:o+"/0/query",data:$.param({where:"1=1",geometry:stringify(c),returnGeometry:!1,outFields:"PIN_NUM",geometryType:d,outSR:e,f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(f.resolve),f.promise}var l={getRealEstate:c,getPhotos:d,getDeeds:e,getAddresses:f,getGeometryByPins:j,getPropertiesByGeometry:k,getSepticPermits:h,getWellResults:i,getServices:g},m="http://maps.raleighnc.gov/arcgis/rest/services/Parcels/MapServer/exts/PropertySOE/",n="http://maps.raleighnc.gov/arcgis/rest/services/Services/ServicesIMaps/MapServer",o="http://maps.raleighnc.gov/arcgis/rest/services/Parcels/MapServer";return l}]),angular.module("imapsNgApp").factory("mapUtils",["$http","$q",function(a,b){function c(c){var d=b.defer();return a({method:"GET",url:c}).success(d.resolve),d.promise}function d(c,d,e,f,g,h){var i=b.defer();return a({method:"POST",url:c+"/buffer",data:{geometries:stringify(d),inSR:e,outSR:e,bufferSR:e,distances:f,unit:g,unionResults:!0,f:"json"},headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(i.resolve),i.promise}function e(c,d,e,f){var g=b.defer();return a({method:"POST",url:c+"/project",data:$.param({geometries:stringify(d),inSR:e,outSR:f,f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(g.resolve),g.promise}var f={loadRaleighBounds:c,buffer:d,project:e};return f}]),angular.module("imapsNgApp").factory("locationFactory",["$http","$q",function(a,b){function c(c){var d=b.defer();return a({method:"GET",url:"https://maps.raleighnc.gov/arcgis/rest/services/Planning/Subdivisions/MapServer/0/query",params:{where:"NAME LIKE '"+c.toUpperCase()+"%'",orderByFields:"NAME",outFields:"NAME",returnGeometry:!0,f:"json"}}).success(d.resolve),d.promise}function d(c){var d=b.defer();return a({method:"GET",url:"https://maps.raleighnc.gov/arcgis/rest/services/StreetsDissolved/MapServer/0/query",params:{where:"CARTONAME LIKE '"+c.toUpperCase()+"%'",orderByFields:"CARTONAME",outFields:"CARTONAME",returnGeometry:!0,f:"json"}}).success(d.resolve),d.promise}function e(c){var d=b.defer();return a({method:"POST",url:"https://maps.raleighnc.gov/arcgis/rest/services/StreetsDissolved/MapServer/0/query",data:$.param({geometry:JSON.stringify(c),geometryType:"esriGeometryPolyline",returnGeometry:!1,outFields:"CARTONAME",orderByFields:"CARTONAME",f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(d.resolve),d.promise}function f(c){var d=b.defer();return a({method:"GET",url:"https://maps.raleighnc.gov/arcgis/rest/services/Locators/Locator/GeocodeServer/findAddressCandidates",params:{"Single Line Input":c,returnGeometry:!0,f:"json"}}).success(d.resolve),d.promise}function g(){var c=b.defer();return a({method:"GET",url:"https://maps.raleighnc.gov/arcgis/rest/services/POI1/MapServer/0/query",params:{where:"1=1",outFields:"ICON",returnDistinctValues:!0,orderByFields:"ICON",returnGeometry:!1,f:"json"}}).success(c.resolve),c.promise}function h(c){var d=b.defer();return a({method:"GET",url:"https://maps.raleighnc.gov/arcgis/rest/services/POI1/MapServer/0/query",params:{where:"ICON = '"+c+"'",outFields:"*",orderByFields:"NAME",returnGeometry:!0,f:"json"}}).success(d.resolve),d.promise}var i={getSubdivision:c,getStreets:d,getIntersectingStreets:e,geocodeAddress:f,getPlaceTypes:g,getPlacesByType:h};return i}]),require(["esri/layers/LabelLayer"],function(a){"function"==typeof esri.layers.LabelLayer.prototype._addLabel&&(esri.layers.LabelLayer.prototype._addLabel2=esri.layers.LabelLayer.prototype._addLabel,esri.layers.LabelLayer.prototype._addLabel=function(a,b,c,d,e,f,g){a=a.replace(/\n/g,"<br />"),this._addLabel2(a,b,c,d,e,f,g)})}),require(["esri/symbols/TextSymbol","dojox/gfx/svg"],function(a,b){"function"==typeof dojox.gfx.svg.Text.prototype.setShape&&(dojox.gfx.svg.Text.prototype.setShape=function(a){this.shape=dojox.gfx.makeParameters(this.shape,a),this.bbox=null;var b=this.rawNode,c=this.shape;for(b.setAttribute("x",c.x),b.setAttribute("y",c.y),b.setAttribute("text-anchor",c.align),b.setAttribute("text-decoration",c.decoration),b.setAttribute("rotate",c.rotated?90:0),b.setAttribute("kerning",c.kerning?"auto":0),b.setAttribute("text-rendering","optimizeLegibility");b.firstChild;)b.removeChild(b.firstChild);if(c.text){var d=c.text.replace(/<br\s*\/?>/gi,"\n").split("\n"),e=1.1*parseInt(document.defaultView.getComputedStyle(b,"").getPropertyValue("font-size"),10);(isNaN(e)||!isFinite(e))&&(e=15);for(var f=0,g=d.length;g>f;f++){var h=document.createElementNS?document.createElementNS(dojox.gfx.svg.xmlns.svg,"tspan"):document.createElement("tspan");h.setAttribute("dy",f?e:-(d.length-1)*e/2),h.setAttribute("x",c.x),h.appendChild(dojox.gfx.useSvgWeb?document.createTextNode(d[f],!0):document.createTextNode(d[f])),b.appendChild(h)}}return this})});