"use strict";function spToDd(a,b){var c=34.33333333333334,d=36.16666666666666,e=33.75,f=-79,g=2000000.002616666,h=20925874.015664328,i=.08181922146,j=i*i,k=.01745329252,l=Math.PI/4;c=34.33333333333334*k,d=36.16666666666666*k,e=33.75*k,f=-79*k;var g=2000000.002616666,m=Math.cos(c)/Math.sqrt(1-j*Math.pow(Math.sin(c),2)),n=Math.cos(d)/Math.sqrt(1-j*Math.pow(Math.sin(d),2)),o=Math.tan(l-c/2)/Math.pow((1-i*Math.sin(c))/(1+i*Math.sin(c)),i/2),p=Math.tan(l-d/2)/Math.pow((1-i*Math.sin(d))/(1+i*Math.sin(d)),i/2),q=Math.tan(l-e/2)/Math.pow((1-i*Math.sin(e))/(1+i*Math.sin(e)),i/2),r=Math.log(m/n)/Math.log(o/p),s=m/(r*Math.pow(o,r)),t=h*s*Math.pow(q,r);a-=g;var u=Math.PI/2,v=Math.sqrt(Math.pow(a,2)+Math.pow(t-b,2)),w=Math.atan(a/(t-b)),x=Math.pow(v/(h*s),1/r),y=w/r+f;a+=g;for(var z=u-2*Math.atan(x),A=(1-i*Math.sin(z))/(1+i*Math.sin(z)),B=u-2*Math.atan(x*Math.pow(A,i/2));Math.abs(B-z)>2e-9;)z=B,A=(1-i*Math.sin(z))/(1+i*Math.sin(z)),B=u-2*Math.atan(x*Math.pow(A,i/2));var C=B/k,D=y/k;return[C,D]}angular.module("imapsNgApp",["ngTouch","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","pageslide-directive","ui.bootstrap","vr.directives.slider","LocalStorageModule","angular-loading-bar","cfp.loadingBar","ngCsv","ngReactGrid","angulartics","angulartics.google.analytics","colorpicker.module"]).config(["localStorageServiceProvider","$locationProvider",function(a,b){a.setPrefix("imaps"),b.html5Mode({enabled:!0,requireBase:!1})}]).filter("titleCase",function(){return function(a){return a=a||"",a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})}}).directive("onlyDigits",function(){return{require:"ngModel",restrict:"A",link:function(a,b,c,d){function e(a){if(a){var b=a.toString().replace(/[^0-9]/g,"");return b!==a&&(d.$setViewValue(b),d.$render()),parseInt(b,10)}return void 0}d.$parsers.push(e)}}}),angular.module("imapsNgApp").controller("MainCtrl",["$rootScope","$location","$timeout","config",function(a,b,c,d){a.checked=!0,a.loading=!0,c(function(){$("#loading").remove(),$("#loadingBackground").remove(),a.loading=!1},1e4);var e=function(){var a=navigator.userAgent.toLowerCase(),b=/chrome/.test(a),c=/webkit/.test(a),d=/opera/.test(a),e=/mozilla/.test(a)&&!/(compatible|webkit)/.test(a)||/firefox/.test(a),f=(/msie/.test(a)||/mozilla/.test(a))&&!/firefox/.test(a)&&!/opera/.test(a);return b?"chrome":c?"safari":f?"ie":e?"mozilla":d?"opera":void 0};"mozilla"==e()?$("body").addClass("mozilla"):"ie"==e()?$("body").addClass("ie"):"opera"==e()?$("body").addClass("opera"):"safari"==e()?$("body").addClass("safari"):"chrome"==e()&&$("body").addClass("chrome");var f=navigator.userAgent.toLowerCase(),g=f.indexOf("android")>-1;g&&c(function(){$("pageslide").addClass("android"),$("toggle-button").addClass("android"),$("tool-panel").addClass("android")});var h="config/config.json";b.search().config&&(h="config/"+b.search().config+".json",a.configName=b.search().config),d.loadConfig(h).then(function(b){a.config=b}),a.touch="ontouchstart"in window||navigator.MaxTouchPoints>0||navigator.msMaxTouchPoints>0}]),angular.module("imapsNgApp").directive("appHeader",function(){return{templateUrl:"directives/appHeader/appHeader.html",restrict:"E",controller:["$scope","$rootScope",function(a,b){$("app-header").appendTo("body"),b.checked=!0,b.$watch("config",function(b){b&&(a.title=b.title)});var c=function(){$("feedback .modal").modal("show")},d=function(){$("about .modal").modal("show")},e=function(){$("disclaimer .modal").modal("show")};a.headerClick=function(a){if(a.click)switch(a.label){case"Feedback":c();break;case"About":d();break;case"Disclaimer":e()}},a.btnClick=function(){b.checked=!b.checked},a.titleClick=function(){this.title=this.$root.config.title}}]}}),angular.module("imapsNgApp").directive("feedback",function(){return{templateUrl:"directives/appHeader/feedback/feedback.html",restrict:"E",controller:["$scope","$rootScope","$http",function(a,b,c){a.feedbackText="";var d=function(){a.feedbackText="",a.feedbackEmail="",$("feedback .modal").modal("hide")};a.sendFeedback=function(a,b){c({url:"http://maps.raleighnc.gov/php/mail.php",method:"GET",type:"jsonp",params:{fromEmail:a,toEmail:"gis@raleighnc.gov,iMAPSHelpdesk@wakegov.com",subject:"iMAPS 3.0 Beta Feedback",message:b,from:"",to:""}}).success(d).error(d)}}]}}),angular.module("imapsNgApp").directive("disclaimer",function(){return{templateUrl:"directives/appHeader/disclaimer/disclaimer.html",restrict:"E",controller:["$scope","$rootScope",function(a,b){}]}}),angular.module("imapsNgApp").directive("about",function(){return{templateUrl:"directives/appHeader/about/about.html",restrict:"E",controller:["$scope","$rootScope",function(a,b){}]}}),angular.module("imapsNgApp").directive("exportButton",function(){return{templateUrl:"directives/exportButton/exportButton.html",restrict:"E",scope:{array:"=",headers:"=",filename:"@",type:"@"},link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("mapPanel",["cfpLoadingBar",function(a){return{templateUrl:"directives/mapPanel/mapPanel.html",restrict:"E",controller:["$scope","$rootScope","$timeout","property","localStorageService","$filter","mapUtils",function(b,c,d,e,f,g,h){b.property=e;var i=null,j=function(){a.start()},k=function(){a.complete()},l=function(){var a=c.configName?c.configName+"_webmap":"imaps_webmap";f.set(a,stringify(b.webmap))};b.checkInsideRaleigh=function(a,d){require(["esri/geometry/Polygon"],function(e){a=new e(a);var f=a.contains(d);b.inRaleigh!=f&&(b.inRaleigh=a.contains(d),c.$broadcast("raleighChecked",f))})};var m=function(a){var c=spToDd(a.extent.xmin,a.extent.ymin),d=spToDd(a.extent.xmax,a.extent.ymax);b.webmap.itemInfo.item.extent=[c.reverse(),d.reverse()],b.raleighBounds&&b.checkInsideRaleigh(b.raleighBounds,a.extent.getCenter()),b.scale=b.map.getScale()},n=function(){h.loadRaleighBounds("data/raleigh.json").then(function(a){b.raleighBounds=a,b.checkInsideRaleigh(a,b.map.extent.getCenter())})},o=function(){angular.forEach(b.map.layerIds,function(a){var d=null,e=c.configName?c.configName+"_webmap":"imaps_webmap";if(i?d=i:f.get(e)&&(d=f.get(e).itemInfo),d){var h=b.map.getLayer(a);if(h.visibleLayers){var j=g("filter")(d.itemData.operationalLayers,function(a){return h.id===a.id});j.length>0&&(j=j[0],j.layerObject&&h.setVisibleLayers(j.layerObject.visibleLayers))}}})},p=function(a,b){return angular.forEach(a.itemInfo.itemData.operationalLayers,function(a){var c=g("filter")(b.itemData.operationalLayers,function(b){return a.id===b.id});c.length>0&&(c=c[0],angular.forEach(a.resourceInfo.layers,function(a){c.layerObject.visibleLayers.indexOf(a.id)>-1?a.defaultVisibility=!0:a.defaultVisibility=!1}))}),a},q=function(a){b.bufferGraphics=new a({id:"bufferGraphics"}),b.selectionMultiple=new a({id:"selectedProperties"}),b.map.graphics.enableMouseEvents(),b.selectionMultiple.on("graphic-node-add",function(a){$(a.node).attr("title",a.graphic.attributes.SITE_ADDRESS+"<br/>"+a.graphic.attributes.OWNER),$(a.node).attr("data-toggle","tooltip"),$(a.node).tooltip({container:"map-panel",html:!0,placement:"mouse",trigger:"hover"})}),b.selectionMultiple.on("graphic-node-remove",function(a){$(a.node).tooltip("destroy")}),b.map.on("pan",function(a){$(".tooltip").hide()}),b.selectionMultiple.on("mouse-move",function(a){$(".tooltip").css("top",a.clientY+10+"px"),$(".tooltip").css("left",a.clientX+10+"px")}),b.selectionMultiple.on("mouse-out",function(a){$(".tooltip").hide()}),b.selectionSingle=new a({id:"selectedProperty"}),b.map.addLayer(b.bufferGraphics),b.map.addLayer(b.selectionMultiple),b.map.addLayer(b.selectionSingle)},r=function(a){require(["esri/layers/GraphicsLayer","esri/basemaps","esri/geometry/Extent","esri/dijit/HomeButton","esri/SpatialReference","esri/dijit/LocateButton","dojo/on"],function(d,e,h,r,s,t,u){i&&(a=p(a,i));var v=c.configName?c.configName+"_webmap":"imaps_webmap";f.get(v)?(b.webmap=f.get(v),b.webmap.clickEventHandle=a.clickEventHandle,b.webmap.clickEventListener=a.clickEventListener):b.webmap=a,b.map=a.map,u(b.map.infoWindow,"set-features",function(){var a=(b.map.infoWindow.location.y<b.map.extent.getCenter().y?"top":"bottom")+"-"+(b.map.infoWindow.location.x<b.map.extent.getCenter().x?"right":"left");b.map.infoWindow.anchor=a,b.map.infoWindow.offsetX=10,b.map.infoWindow.reposition()}),n(),q(d),b.$digest(),u(b.map,"update-start",j),u(b.map,"update-end",k),u(b.map,"extent-change",m),u(b.map,"unload",l),o();var w=b.config.map.basemaps.streets.layers.concat(b.config.map.basemaps.images.layers);angular.forEach(w,function(a){var c=[{url:a.url}];a.labels||c.push({url:b.config.map.labels});var d={baseMapLayers:c,title:a.name};e[a.id]=d});var x=b.webmap.itemInfo.itemData.baseMap.title,w=g("filter")(b.config.map.basemaps.streets.layers,function(a){return x===a.name});w.length>0?(b.basemap=w[0],b.basemapType="streets"):(w=g("filter")(b.config.map.basemaps.images.layers,function(a){return x===a.name}),w.length>0&&(b.basemap=w[0],b.basemapType="images")),u(b.map,"basemap-change",function(a){for(var b=0;b<a.current.layers.length;b++)a.current.layers[b].setMaxScale(0)}),b.map.setBasemap(b.basemap.id),$("#loading").remove(),$("#loadingBackground").remove(),b.scale=b.map.getScale(),c.$broadcast("mapLoaded");new r({map:b.map,extent:new h(1948652,608444,2249012,862044,new s({wkid:2264}))},"homeButton").startup(),new t({map:b.map,scale:2400,highlightLocation:!0},"locateButton").startup()})},s=function(a,b){var c=null;angular.forEach(a.itemData.operationalLayers,function(a){c=g("filter")(b.itemData.operationalLayers,function(b){return a.id===b.id}),c.length>0&&(c=c[0],a.opacity=c.opacity,a.visibility=c.visibility)})};c.$watch("config",function(a){a&&(b.config=a,require(["esri/map","esri/arcgis/utils","esri/config","esri/tasks/GeometryService","esri/dijit/Popup","dojo/dom-construct","dojo/on","dojo/domReady!"],function(d,e,g,h,j,k,l){g.defaults.io.proxyUrl="http://maps.raleighnc.gov/parklocator/proxy.ashx",g.defaults.io.alwaysUseProxy=!1,g.defaults.geometryService=new h("https://maps.raleighnc.gov/arcgis/rest/services/Utilities/Geometry/GeometryServer");var m=(a.map.id,e.getItem(a.map.id));m.addCallback(function(a){var d=a,g=c.configName?c.configName+"_webmap":"imaps_webmap";if(f.get(g))if(a.item.modified===f.get(g).itemInfo.item.modified){var h={};h.item=f.get(g).itemInfo.item,h.itemData=f.get(g).itemInfo.itemData,d=h}else a.item.extent=f.get(g).itemInfo.item.extent,a.itemData.baseMap=f.get(g).itemInfo.itemData.baseMap,a=s(a,f.get(g).itemInfo),i=f.get(g).itemInfo,f.remove(g);var m=new j({},k.create("div"));l(m,"show",function(a){console.log(b.map.infoWindow.anchor),console.log(a)}),e.createMap(d,"map",{geometryServiceURL:"https://maps.raleighnc.gov/arcgis/rest/services/Utilities/Geometry/GeometryServer",mapOptions:{fadeOnZoom:!0,logo:!1,showAttribution:!1,sliderPosition:"bottom-left",sliderOrientation:"horizontal",sliderStyle:"small"},usePopupManager:!0}).then(r,function(a){console.log(a)})})}))});var t=function(a,d,e){require(["esri/graphic","esri/graphicsUtils","esri/SpatialReference"],function(f,g,h){$(".tooltip").hide(),b.map.reorderLayer(b.bufferGraphics,b.map.layerIds.length-4),b.map.reorderLayer(b.selectionMultiple,b.map.layerIds.length-3),b.map.reorderLayer(b.selectionSingle,b.map.layerIds.length-2);var i=null;d.clear(),1===a.length&&(b.geometry=a[0].geometry),angular.forEach(a,function(a){a.geometry.spatialReference={wkid:b.config.map.wkid},i=new f({geometry:a.geometry,symbol:{color:[0,0,0,0],outline:{color:e,width:3,type:"esriSLS",style:"esriSLSSolid"},type:"esriSFS",style:"esriSFSSolid"},attributes:a.attributes}),d.add(i)}),d.graphics.length>0&&c.zoomTo&&b.map.setExtent(g.graphicsExtent(d.graphics),!0)})};b.$on("accountUpdate",function(a,c){var d=[];c||(c=[]),c.length>1&&(angular.forEach(c,function(a){d.push("PIN_NUM = '"+a.pin+"'")}),b.property.getGeometryByPins(d.toString().replace(/,/g," OR "),0,b.config.map.wkid).then(function(a){b.property.getGeometryByPins(d.toString().replace(/,/g," OR "),1,b.config.map.wkid).then(function(c){t(a.features.concat(c.features),b.selectionMultiple,[255,255,0])})}))}),b.$on("pinUpdate",function(a,c){b.property.getGeometryByPins("PIN_NUM = '"+c+"'",0,b.config.map.wkid).then(function(a){b.property.getGeometryByPins("PIN_NUM = '"+c+"'",1,b.config.map.wkid).then(function(c){d(function(){t(a.features.concat(c.features),b.selectionSingle,[255,0,0])})})})})}],link:function(a,b,c){}}}]),angular.module("imapsNgApp").directive("mapCoordinates",function(){return{templateUrl:"directives/mapPanel/mapCoordinates/mapCoordinates.html",restrict:"E",controller:["$scope","$rootScope","$timeout",function(a,b,c){var d=null;a.coordUnits=[{value:"DECIMAL_DEGREES",label:"Decimal Degrees"},{value:"DEGREE_MINUTE_SECONDS",label:"Degrees Minutes Seconds"},{value:"FEET",label:"State Plane Feet"}],a.coordUnit=a.coordUnits[0];var e=function(b,d){var e=f(b.x,b.y,a.coordUnit.value);c(function(){a.currentCoords=e})},f=function(a,b,c){var d=spToDd(a,b),e="";if("FEET"===c)e=b.toFixed(4)+" N "+a.toFixed(4)+" E";else if("DECIMAL_DEGREES"===c)e="Lat: "+d[0].toFixed(6)+" Lng: "+d[1].toFixed(6);else if("DEGREE_MINUTE_SECONDS"===c){var f=new GeoPoint(d[1],d[0]);e=f.getLatDeg()+" "+f.getLonDeg()}return e},g=function(){require(["dojo/on"],function(b){coordHandle=b(a.map,"mouse-move",function(b){d=b.mapPoint,e(b.mapPoint,a.coordUnit.value)})})};a.coordUnitSelected=function(b){a.coordUnit=a.coordUnits[b],e(d,a.coordUnit.value)},b.$on("mapLoaded",function(){g()})}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("sidePanel",["$timeout","$window","$rootScope",function(a,b,c){return{templateUrl:"directives/sidePanel/sidePanel.html",restrict:"E",controller:["$scope","$rootScope","$window",function(a,b,c){a.psWidth="300px",c.innerWidth<321&&(a.psWidth="280px"),a.checked=!0,a.searchDir={open:!0,overflow:"none",padding:30},a.layersDir={open:!1,overflow:"auto",padding:15},a.searchTypeStatus={isopen:!1},b.$watch("checked",function(b){a.checked=b}),a.propertySearchSelected=function(c){c.preventDefault(),c.stopPropagation(),"For Property"===c.target.text?b.selectedSearch=b.searches[0]:"For Location"===c.target.text?b.selectedSearch=b.searches[1]:"For Utilities"===c.target.text&&(b.selectedSearch=b.searches[2]),a.searchTypeStatus.isopen=!1,a.searchDir.open=!0,a.layersDir.open=!1},a.$watch("searchDir.open",function(b){b&&(a.layersDir.open=!1,a.resetPanel())}),a.$watch("layersDir.open",function(b){b&&(a.searchDir.open=!1,a.resetPanel(),a.$broadcast("refreshSlider"))})}],link:function(d,e,f){d.resetPanel=function(){var a=document.getElementsByClassName("panel-heading");document.getElementsByClassName("panel-body");if(a.length>0){var c=b.innerHeight;c-=a.length*a[0].offsetHeight;var e=null;d.searchDir.open?e=d.searchDir:d.layersDir.open&&(e=d.layersDir),e&&(d.accordionHeight={height:c-$("pageslide").position().top-e.padding+"px",overflow:e.overflow})}},c.$on("mapLoaded",function(){d.resetPanel()}),a(d.resetPanel.bind(e),500);var g=angular.element(b);d.getWindowDimensions=function(){return{h:g.height(),w:g.width()}},d.$watch(d.getWindowDimensions,function(a,b){d.resetPanel()},!0),g.bind("resize",function(){d.$apply()})}}}]),angular.module("imapsNgApp").directive("toggleButton",["$window",function(a){return{templateUrl:"directives/sidePanel/toggleButton/toggleButton.html",restrict:"E",controller:["$scope","$rootScope",function(a,b){a.toggleSidePanel=function(){b.checked=!b.checked}}],link:function(b,c,d){var e=angular.element(a),f=function(a){b.toggleTop=a.h/2};b.getWindowDimensions=function(){return{h:e.height(),w:e.width()}},b.$watch(b.getWindowDimensions,function(a,b){f(a)},!0),e.bind("resize",function(){b.$apply()})}}}]),angular.module("imapsNgApp").directive("toolPanel",["$timeout",function(a){return{templateUrl:"directives/toolPanel/toolPanel.html",restrict:"E",controller:["$scope","$rootScope",function(b,c){c.toolsChecked=!1,c.$watch("toolsChecked",function(c){b.toolsChecked=c,a(function(){$("tool-panel").overlaps($("base-map-panel")).length>0?$("base-map-panel").hide():$("base-map-panel").show()},500)}),b.toolHeaderClick=function(a){c.toolsChecked=!a},b.toolChanged=function(a){require(["dojo/on"],function(c){angular.forEach(b.tools,function(a,b){a.highlighted=!1}),a.highlighted=!0,b.tool=a,"Identify"===a.title&&a.title!=b.lastTool.title?b.map.setInfoWindowOnClick(!0):a.title!=b.lastTool.title&&b.map.setInfoWindowOnClick(!1),b.lastTool=a})}}],link:function(a,b,c){a.tools=[{icon:"info-sign",title:"Identify",highlighted:!0,height:60,width:300},{icon:"hand-up",title:"Property Select",highlighted:!1,height:180,width:280},{icon:"road",title:"Streetview",highlighted:!1,height:300,width:320},{icon:"picture",title:"Oblique",highlighted:!1,height:300,width:320},{icon:"resize-horizontal",title:"Measure",highlighted:!1,height:250,width:300},{icon:"bookmark",title:"Bookmarks",highlighted:!1,height:260,width:300},{icon:"pencil",title:"Draw",highlighted:!1,height:250,width:300},{icon:"print",title:"Print",highlighted:!1,height:325,width:300},{icon:"trash",title:"Clear Map",highlighted:!1,height:104,width:300}],a.tool=a.tools[0],a.lastTool=a.tool}}}]),angular.module("imapsNgApp").directive("baseMapPanel",["$timeout",function(a){return{templateUrl:"directives/baseMapPanel/baseMapPanel.html",restrict:"E",controller:["$scope","$rootScope","$filter","$analytics",function(b,c,d,e){b.baseMapPanel={height:180};b.blend={opacity:1,checked:!1},b.insideRaleigh=!0,c.mapsChecked=!1,b.basemapType="streets",c.$watch("config",function(a){a&&(b.basemap=a.map.basemaps.streets.layers[0],b.streetMap=b.basemap)}),c.$watch("mapsChecked",function(a){b.mapsChecked=a}),b.showAerial=function(a){return a.county&&!b.insideRaleigh||b.insideRaleigh},b.mapsHeaderClick=function(a){c.mapsChecked=!a},b.$on("raleighChecked",function(a,c){if(b.insideRaleigh=c,"images"===b.basemapType)if(c)b.lastRaleighYear?(b.basemap=b.lastRaleighYear,b.basemapChanged(b.lastRaleighYear,"images")):(b.basemap=b.config.map.basemaps.images.layers[0],b.basemapChanged(b.basemap,"images")),b.lastRaleighYear=b.basemap;else{if(b.lastWakeYear)b.basemap=b.lastWakeYear,b.basemapChanged(b.lastWakeYear,"images");else{var e=d("filter")(b.config.map.basemaps.images.layers,function(a){return a.county===!0});b.basemap=e[0],b.basemapChanged(b.basemap,"images")}b.lastWakeYear=b.basemap}}),b.basemapTypeClicked=function(a){if(b.basemapType!=a)if("streets"===a)b.basemap=b.streetMap;else if("images"===a)if(b.imageMap)b.basemap=b.imageMap;else if(b.inRaleigh)b.basemap=b.config.map.basemaps.images.layers[0],b.imageMap=b.basemap;else{var c=d("filter")(b.config.map.basemaps.images.layers,function(a){return a.county===!0});b.basemap=c[0],b.imageMap=b.basemap}b.basemapChanged(b.basemap,a),b.basemapType=a},b.basemapChanged=function(a,c,d){e.eventTrack("Changed",{category:"Basemaps",label:a.id}),require(["esri/basemaps"],function(e){angular.forEach(b.map.layerIds,function(a){(0===a.indexOf("Base")||0===a.indexOf("base"))&&b.map.removeLayer(b.map.getLayer(a))}),angular.forEach(b.map.basemapLayerIds,function(a){b.map.removeLayer(b.map.getLayer(a))}),b.checkInsideRaleigh(b.raleighBounds,b.map.extent.getCenter()),b.map.setBasemap(a.id),"streets"===c?(b.streetMap=a,b.baseMapPanel.height=180,f&&b.map.removeLayer(f)):"images"===c&&(b.imageMap=a,b.baseMapPanel.height=b.blend.checked?245:200,b.blend.checked&&(f&&b.map.removeLayer(f),g())),b.webmap.itemInfo.itemData.baseMap=e[a.id],"images"===c&&(a.county?(b.lastWakeYear=a,d&&(b.lastRaleighYear=a)):b.lastRaleighYear=a)})};var f=null;b.baseOpacityChanged=function(){f.setOpacity(1-b.blend.opacity)};var g=function(){require(["esri/layers/ArcGISTiledMapServiceLayer"],function(a){f=a(b.streetMap.url,{opacity:1-b.blend.opacity}),b.map.addLayer(f,b.map.basemapLayerIds.length)})};b.blendChecked=function(){b.blend.checked?(g(),b.baseMapPanel.height=245):f&&(b.map.removeLayer(f),b.baseMapPanel.height=200),a(function(){b.$broadcast("refreshSlider")})}}],link:function(a,b,c){}}}]),angular.module("imapsNgApp").directive("overviewPanel",["$timeout",function(a){return{templateUrl:"directives/overviewPanel/overviewPanel.html",restrict:"E",controller:["$scope","$rootScope",function(a,b){b.overviewChecked=!1,b.$watch("overviewChecked",function(b){a.overviewChecked=b}),a.overviewHeaderClick=function(c){b.overviewChecked=!c,c?a.overview.hide():a.overview.show()},a.$watch("map",function(b){b&&require(["esri/dijit/OverviewMap","esri/layers/ArcGISTiledMapServiceLayer"],function(c,d){a.overview=new c({map:b,baseLayer:new d(a.config.map.basemaps.streets.layers[0].url),visible:!0,width:180,height:180},"overview"),a.overview.startup(),a.overview.hide()})})}],link:function(a,b,c){}}}]),angular.module("imapsNgApp").directive("search",function(){return{templateUrl:"directives/sidePanel/search/search.html",restrict:"EA",controller:["$scope","$rootScope",function(a,b){b.searches=[{label:"For Property",value:"property"},{label:"For Location",value:"location"}],"puma"===b.configName&&b.searches.push({label:"For Utilities",value:"utilities"}),b.selectedSearch=b.searches[0]}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("propertySearch",function(){return{templateUrl:"directives/sidePanel/propertySearch/propertySearch.html",restrict:"E",controller:["$scope","$rootScope","$timeout","property","$analytics","$location",function(a,b,c,d,e,f){a.hiddenOverflow=!1,a.property=d,a.searchValue="";var g="https://maps.raleighnc.gov/arcgis/rest/services/Parcels/MapServer/exts/PropertySOE/AutoComplete",h=function(a){var b=[];return a.Results.length>0&&angular.forEach(a.Results,function(a){b.push({value:a})}),b};a.tabChanged=function(b){angular.forEach(a.tabs,function(a,c){c>0&&(a.disabled=b),a.highlighted=!1}),a.tab.highlighted=!0},a.$on("tabUpdated",function(b,c){a.tab=a.tabs[c],a.tabChanged(!0)});var i=function(a){for(var b=a[0],c=null,d="",e=[],f=0;f<b.length;f++)if(b[f].toUpperCase().indexOf("PIN")>-1){c=f;break}if(c)alert("CSV must have a field named PIN");else{for(var f=1;f<a.length;f++)d=a[f][c],e.push(d);m("pin",e)}},j=function(a){for(var b=a.split(/\r\n|\n/),c=[],d=0;d<b.length;d++){for(var e=b[d].split(","),f=[],g=0;g<e.length;g++)f.push(e[g]);c.push(f)}0===c.length&&alert("Invalid file, please verify that document is a comma separated file."),i(c)},k=function(a){if(a.stopPropagation(),a.preventDefault(),window.FileReader){var b=(a.dataTransfer.files,a.dataTransfer.files.item(0)),c=new FileReader;c.onload=function(a){return function(a){j(a.target.result)}}(b),"text/csv"===b.type||"text/plain"===b.type?c.readAsText(b):alert("Invalid file type, must use a CSV file.")}else alert("FileReader are not supported in this browser.")},l=function(a){a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"};b.$on("mapLoaded",function(a){f.search().pin&&m("pin",f.search().pin.split(","));var b=document.getElementById("body");"draggable"in b?(b.addEventListener("dragover",l,!1),b.addEventListener("drop",k,!1)):alert("Drag and drop not supported in this browser")}),a.$on("accountSelected",function(c,d){f.search("pin",d.pin),a.tabChanged(!1),b.checked=!0,a.searchDir.open=!0,a.layersDir.open=!1,b.selectedSearch=b.searches[0]}),b.$on("accountUpdate",function(d,e){b.checked=!0,e||(e=[]),1===e.length?(a.tab=a.tabs[1],a.pin=e[0].pin,f.search("pin",a.pin),a.reid=e[0].reid,a.account=e[0],c(function(){a.$broadcast("accountSelected",e[0])})):0===e.length?(a.pin=null,f.search("pin",a.pin)):(b.account=null,b.accountInfo=[],a.tab=a.tabs[0],a.tabChanged(!0))});var m=function(c,d){a.property.getRealEstate(c,d).then(function(c){a.account=null,a.selectionSingle.clear(),a.selectionMultiple.clear(),a.fields=c.Fields,a.accounts=c.Accounts,a.$parent.account=null,a.accountsSrc=c.Accounts,b.zoomTo=!0,b.$broadcast("accountUpdate",a.accounts)})},n=function(a,b,c){$(".twitter-typeahead>input").blur(),c="streetname"===c?"street name":c,m(c,[b.value])},o=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.value)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:g+"?type=address&f=json",filter:h,replace:function(a,b){b=b.replace(/\'/g,"''").toUpperCase();var c=a+"&input="+b;return c}}}),p=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.value)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:g+"?type=owner&f=json",filter:h,replace:function(a,b){b=b.replace(/\'/g,"''").toUpperCase();var c=a+"&input="+b;return c}}}),q=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.value)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:g+"?type=pin&f=json&limit=5",filter:h,replace:function(a,b){b=b.replace(/\'/g,"''").toUpperCase();var c=a+"&input="+b;return c}}}),r=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.value)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:g+"?type=reid&f=json&limit=5",filter:h,replace:function(a,b){b=b.replace(/\'/g,"''").toUpperCase();var c=a+"&input="+b;return c}}}),s=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.value)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:g+"?type=street name&f=json&limit=5",filter:h,replace:function(a,b){b=b.replace(/\'/g,"''").toUpperCase();var c=a+"&input="+b;return c}}});o.initialize(),p.initialize(),q.initialize(),r.initialize(),s.initialize(),a.autocomplete={displayKey:"value",source:o.ttAdapter()},$("#searchInput").on("keyup",function(a){13==a.which&&$(".tt-highlight").trigger("click")}),$("#searchInput").typeahead({hint:!0,highlight:!0,minLength:3},{name:"address",displayKey:"value",source:o.ttAdapter(),templates:{header:"<h5>Addresses</h5>"}},{name:"owner",displayKey:"value",source:p.ttAdapter(),templates:{header:"<h5>Owners</h5>"}},{name:"pin",displayKey:"value",source:q.ttAdapter(),templates:{header:"<h5>PIN</h5>"}},{name:"reid",displayKey:"value",source:r.ttAdapter(),templates:{header:"<h5>Real Estate ID</h5>"}},{name:"streetname",displayKey:"value",source:s.ttAdapter(),templates:{header:"<h5>Street</h5>"}}).on("typeahead:selected",n),c(function(){$(".tt-input").keyup(function(){a.searchValue=$(".tt-input").val(),a.$apply()}),$(".tt-input").on("paste",function(a){c(function(){var a=$(".tt-input").val();if(19===a.length&&"."===a.charAt(4)&&" "===a.charAt(7)&" "===a.charAt(10)&&" "===a.charAt(15)){console.log("YES");var b=a.split("."),c=b[0].toString(),d=b[1].split(" ");c+=d[1].toString()+d[2].toString(),$(".tt-input").val(c),$(".twitterTypeahead").val(c),m("pin",[c]),console.log(c)}else console.log(a)})})});var t=function(b){angular.forEach(a.tabs,function(a){a.highlighted=!1}),b.highlighted=!0},u=function(b){switch(b.title){case"Results":break;case"Info":break;case"Photos":a.property.getPhotos(a.account.reid).then(function(b){a.photos=b.Photos});break;case"Deeds":a.property.getDeeds(a.account.reid).then(function(b){a.deeds=b.Deeds,a.plats=[],angular.forEach(a.deeds,function(b){b.bomDocNum&&"0"!=b.bomDocNum&&a.plats.push(b)})});break;case"Tax Info":window.open("http://services.wakegov.com/realestate/Account.asp?id="+a.account.reid,"_blank");break;case"Services":a.$broadcast("servicesClicked",a.geometry);break;case"Addresses":a.property.getAddresses(a.account.pin,a.account.reid).then(function(b){a.addresses=b.Addresses})}};a.tabClicked=function(b){b.disabled||(a.tab=b,t(b),u(b))},a.clearTypeahead=function(){$("#searchInput").typeahead("val",""),a.searchValue=""}}],link:function(a,b,c){a.tabs=[{icon:"list",title:"Results",highlighted:!0,disabled:!1,table:!0},{icon:"info-sign",title:"Info",highlighted:!1,disabled:!0,table:!0},{icon:"camera",title:"Photos",highlighted:!1,disabled:!0,table:!1},{icon:"file",title:"Deeds",highlighted:!1,disabled:!0,table:!1},{icon:"usd",title:"Tax Info",highlighted:!1,disabled:!0,table:!1},{icon:"flag",title:"Services",highlighted:!1,disabled:!0,table:!1},{icon:"home",title:"Addresses",highlighted:!1,disabled:!0,table:!0}],a.tab=a.tabs[0]}}}),angular.module("imapsNgApp").directive("propertyResults",function(){return{templateUrl:"directives/sidePanel/propertySearch/propertyResults/propertyResults.html",restrict:"E",controller:["$scope","$timeout","$window","$rootScope",function(a,b,c,d){a.resultHeader=[],a.accounts=[],a.$on("accountUpdate",function(b,c){c||(c=[]),a.accounts=c,a.resultGrid.data=c,a.resultHeader=[],angular.forEach(a.fields,function(b){a.resultHeader.push(b.alias)}),$("#resultGrid .ngReactGridViewPort").css({"min-height":$(".tabcontainer").height()-50+"px","max-height":$(".tabcontainer").height()-50+"px"})}),a.resultGrid={data:a.accounts,showGridShowPerPage:!1,showGridSearch:!1,pageSize:1e4,pageSizes:[1e4],height:$(".tabcontainer").height(),columnDefs:[{field:"siteAddress",displayName:"Address"},{field:"owner",displayName:"Owner"},{field:"pin",displayName:"PIN"}],rowClick:function(b){a.resultClicked(b)}},a.resultClicked=function(b){d.zoomTo=!0,a.account=b,a.tab=a.tabs[1],a.$broadcast("accountSelected",b)};var e=angular.element(c);a.getWindowDimensions=function(){return{h:e.height(),w:e.width()}},a.$watch(a.getWindowDimensions,function(a,b){$(".ngReactGridViewPort").css("max-height",$(".tabcontainer").height()-50),$(".ngReactGridViewPort").css("min-height",$(".tabcontainer").height()-50)},!0),e.bind("resize",function(){a.$apply()})}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("propertyInfo",function(){return{templateUrl:"directives/sidePanel/propertySearch/propertyInfo/propertyInfo.html",restrict:"E",controller:["$scope","$filter","$timeout","$rootScope","property",function(a,b,c,d,e){a.accountInfo=[];var f=function(c){a.accountInfo=[],a.tabChanged(!1),a.pin=c.pin,a.reid=c.reid,d.$broadcast("pinUpdate",c.pin),angular.forEach(a.fields,function(d){"currency"===d.type&&(c[d.field]=b("currency")(c[d.field],"$",0)),a.accountInfo.push({field:d.alias,value:c[d.field]})}),d.accountInfo=a.accountInfo},g=function(b){e.getSepticPermits(b).then(function(c){c.SepticPermits.length>0&&angular.forEach(c.SepticPermits,function(b){a.accountInfo.push({field:"Septic Permit",value:b.permitNumber})}),h(b)})},h=function(b){e.getWellResults(b).then(function(d){d.WellResults.length>0&&a.accountInfo.push({field:"Well Samples",value:b}),c(function(){a.infoGrid.data=a.accountInfo})})};a.account&&!a.accountInfo&&f(a.account),a.$on("accountSelected",function(b,c){d.account=c,f(c),"RALEIGH"===c.city&&a.accountInfo.push({field:"Crime",value:"https://maps.raleighnc.gov/crime?pin="+c.pin}),c.pin&&g(c.pin),$("#infoGrid .ngReactGridViewPort").css({"min-height":$(".tabcontainer").height()-30+"px","max-height":$(".tabcontainer").height()-30+"px"})});var i=function(){a.infoGrid={data:a.accountInfo,showGridShowPerPage:!1,showGridSearch:!1,pageSize:100,pageSizes:[100],height:$(".tabcontainer").height()-30,columnDefs:[{field:"field",displayName:"Field",sort:!1},{field:"value",displayName:"Value",sort:!1,render:function(a){return"Septic Permit"===a.field?React.DOM.a({className:"ps-link",href:"http://gisasp2.wakegov.com/imaps/RequestedPermit.aspx?permit="+a.value,target:"_blank"},a.value+" ",React.DOM.span({className:"glyphicon glyphicon-new-window"})):"Well Samples"===a.field?React.DOM.a({className:"ps-link",href:"http://justingreco.github.io/water-analysis/app/index.html#/?pin="+a.value,target:"_blank"},"View ",React.DOM.span({className:"glyphicon glyphicon-new-window"})):"Crime"===a.field?React.DOM.a({className:"ps-link",href:a.value,target:"_blank"},"View ",React.DOM.span({className:"glyphicon glyphicon-new-window"})):void 0}}]}};i(),a.toggleProperty=function(b){var c=a.accounts.indexOf(a.account),d=b?c+1:c-1;-1===d?d=a.accounts.length-1:d===a.accounts.length&&(d=0),a.account=a.accounts[d],a.$broadcast("accountSelected",a.account)}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("propertyPhotos",function(){return{templateUrl:"directives/sidePanel/propertySearch/propertyPhotos/propertyPhotos.html",restrict:"E",controller:["$scope",function(a){}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("propertyDeeds",function(){
return{templateUrl:"directives/sidePanel/propertySearch/propertyDeeds/propertyDeeds.html",restrict:"E",controller:["$scope",function(a){}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("propertyTaxes",function(){return{templateUrl:"directives/sidePanel/propertySearch/propertyTaxes/propertyTaxes.html",restrict:"E",controller:["$scope",function(a){}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("propertyServices",function(){return{templateUrl:"directives/sidePanel/propertySearch/propertyServices/propertyServices.html",restrict:"E",controller:["$scope","property","$filter","mapUtils",function(a,b,c,d){var e=function(a,b){for(var d=a.split("[").length-1,e=/\[(.*?)\]/,f=null,g=0;d>g;g++)f=e.exec(a),f[0].indexOf(":proper")>-1?(f[1]=f[1].replace(/:proper/g,""),a=a.replace(f[0],c("titleCase")(b[f[1]]).replace("Nc","NC"))):a=a.replace(f[0],b[f[1]]);return a},f=function(a,b){return c("filter")(a,function(a){return a.layerId===b})},g=function(b){angular.forEach(a.config.services.categories,function(c){var d={title:c.title,services:[]};angular.forEach(c.services,function(a){var c=f(b.results,a.layerId);if(c.length>0){var g={title:e(a.title,c[0].attributes),items:[]};angular.forEach(c,function(b){var c=a.labels.split(";");angular.forEach(c,function(a){var c=e(a,b.attributes)+"<br/>";-1===g.items.indexOf(c)&&g.items.push(c)})}),g.items.length>0&&d.services.push(g)}}),d.services.length>0&&a.propertyServices.categories.push(d)})};a.$on("servicesClicked",function(c,d){a.propertyServices={categories:[]},require(["esri/geometry/geometryEngine","esri/geometry/Polygon"],function(c,e){d.type||(d=new e(d));var f=c.buffer(d,-5,9002,!0);b.getServices(f,a.map.extent,a.map.width,a.map.height).then(function(a){g(a)})})})}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("propertyAddresses",function(){return{templateUrl:"directives/sidePanel/propertySearch/propertyAddresses/propertyAddresses.html",restrict:"E",controller:["$scope",function(a){a.rpid=null,a.raleighCols=[{field:"address",displayName:"Address"},{field:"type",displayName:"Type"},{field:"status",displayName:"Status"}],a.wakeCols=[{field:"address",displayName:"Address"}],a.addrGrid={data:[],showGridShowPerPage:!1,showGridSearch:!1,pageSize:1e4,pageSizes:[1e4],height:$(".tabcontainer").height()-62,columnDefs:a.raleighCols},a.$watch("addresses",function(b){b&&b.length>0&&(a.addrGrid.data=b,b[0].rpidMap?(a.addrGrid.columnDefs=a.raleighCols,a.rpid=b[0].rpidMap+" "+b[0].rpidLot,angular.forEach(b,function(a){a.suite.trim().length>0&&(a.address+=", STE "+a.suite)})):(a.addrGrid.columnDefs=a.wakeCols,a.rpid=null),$("#addrGrid .ngReactGridViewPort").css({"min-height":$(".tabcontainer").height()-30+"px","max-height":$(".tabcontainer").height()-62+"px"}))})}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("locationSearch",function(){return{templateUrl:"directives/sidePanel/locationSearch/locationSearch.html",restrict:"E",controller:["$scope",function(a){}],link:function(a,b,c){a.locationSearchTypes=[{label:"Address",value:"address"},{label:"Intersection",value:"intersection"},{label:"Place of Interest",value:"poi"},{label:"Subdivision",value:"subdivision"},{label:"Coordinate",value:"coordinate"}],a.locationSearchType=a.locationSearchTypes[0]}}}),angular.module("imapsNgApp").directive("utilitySearch",function(){return{templateUrl:"directives/sidePanel/utilitySearch/utilitySearch.html",restrict:"E",controller:["$scope","puma",function(a,b){a.utilityLayers=[],a.utilityServices=[{title:"Water Distribution",url:"http://gis.raleighnc.gov/arcgis/rest/services/PublicUtility/WaterDistribution/MapServer",searchFields:"FACILITYID",displayField:"Facility Identifier"},{title:"Sewer Collection",url:"http://gis.raleighnc.gov/arcgis/rest/services/PublicUtility/SewerCollection/MapServer",searchFields:"FACILITYID",displayField:"Facility Identifier"},{title:"Reclaimed Distribution",url:"http://gis.raleighnc.gov/arcgis/rest/services/PublicUtility/ReclaimedDistribution/MapServer",searchFields:"FACILITYID",displayField:"Facility Identifier"},{title:"CIP Projects",url:"http://gis.raleighnc.gov/arcgis/rest/services/PublicUtility/RPUD_Projects/MapServer",searchFields:"PROJECT_NUMBER,PROJECT_NAME",displayField:"Project Name"}],a.utilityServiceSelected=function(c){b.getUtilityLayers(c.url).then(function(b){a.utilityLayers=b.layers})},a.searchUtilities=function(d){b.findUtilitiesById(a.utilityService.url+"/find",a.utilityLayer.id,d,a.utilityService.searchFields).then(function(b){a.utilityResults=[];for(var d=0;d<b.results.length;d++)a.utilityResults.push({geometry:b.results[d].geometry,display:b.results[d].attributes[a.utilityService.displayField]});b.results.length>0&&c(b.results[0].geometry)})},a.utilityResultClicked=function(a){c(a)};var c=function(b){require(["esri/geometry/Point","esri/geometry/Polyline","esri/geometry/Polygon","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleFillSymbol","esri/layers/GraphicsLayer","esri/graphic"],function(c,d,e,f,g,h,i,j){var k=a.map.getLayer("pumaGraphics"),l=null;k||(k=new i({id:"pumaGraphics"}),a.map.addLayer(k)),k.clear(),b.x?(a.map.centerAndZoom(new c(b),13),l=new j(new c(b),new f({color:[0,230,255,200],size:12,angle:-30,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,255,200],width:1,type:"esriSLS",style:"esriSLSSolid"}})),k.add(l)):b.paths?(a.map.setExtent(new d(b).getExtent(),!0),l=new j(new d(b),new g({type:"esriSLS",style:"esriSLSSolid",color:[0,230,255,200],width:5})),k.add(l)):b.rings&&(a.map.setExtent(new e(b).getExtent(),!0),l=new j(b,new h({type:"esriSFS",style:"esriSFSNull",color:[0,90,100,40],outline:{type:"esriSLS",style:"esriSLSSolid",color:[0,90,100,40],width:5}})))})}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("addressSearch",function(){return{templateUrl:"directives/sidePanel/locationSearch/addressSearch/addressSearch.html",restrict:"EA",controller:["$scope","locationFactory",function(a,b){a.geocodeAddress=function(){require(["esri/geometry/Point","esri/layers/GraphicsLayer","esri/graphic","esri/symbols/PictureMarkerSymbol"],function(c,d,e,f){b.geocodeAddress(a.streetAddress).then(function(b){if(b.candidates.length>0){var g=a.map.getLayer("locationGraphics");g||(g=new d({id:"locationGraphics"}),a.map.addLayer(g)),g.clear();var h=new f({url:"images/esriGreenPin16x26.af30506b.png",height:26,width:16,type:"esriPMS"}),i=new c({x:b.candidates[0].location.x,y:b.candidates[0].location.y,spatialReference:{wkid:a.map.spatialReference.latestWkid}});g.add(new e(i,h)),a.map.centerAndZoom(i,11)}})})}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("intersectionSearch",function(){return{templateUrl:"directives/sidePanel/locationSearch/intersectionSearch/intersectionSearch.html",restrict:"EA",controller:["$scope","$http","locationFactory",function(a,b,c){a.primaryStreet=null,a.primaryStreets=function(a){return c.getStreets(a).then(function(a){return a.features})},a.primaryStreetSelected=function(b,d,e){c.getIntersectingStreets(b.geometry).then(function(b){a.intersectingStreets=b.features})},a.intersectionSelected=function(){require(["esri/geometry/Point","esri/layers/GraphicsLayer","esri/graphic","esri/symbols/PictureMarkerSymbol"],function(b,d,e,f){c.geocodeAddress(a.primaryStreet.attributes.CARTONAME+" & "+a.intersectingStreet.attributes.CARTONAME).then(function(c){if(c.candidates.length>0){var g=a.map.getLayer("locationGraphics");g||(g=new d({id:"locationGraphics"}),a.map.addLayer(g)),g.clear();var h=new f({url:"images/esriGreenPin16x26.af30506b.png",height:26,width:16,type:"esriPMS"}),i=new b({x:c.candidates[0].location.x,y:c.candidates[0].location.y,spatialReference:{wkid:a.map.spatialReference.latestWkid}});g.add(new e(i,h)),a.map.centerAndZoom(i,10)}})})}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("poiSearch",function(){return{templateUrl:"directives/sidePanel/locationSearch/poiSearch/poiSearch.html",restrict:"EA",controller:["$scope","locationFactory",function(a,b){a.places=[],a.placeTypes=[],b.getPlaceTypes().then(function(b){a.placeTypes=[],angular.forEach(b.features,function(b){a.placeTypes.push(b.attributes.ICON)})}),a.placeTypeSelected=function(c){b.getPlacesByType(c).then(function(b){a.places=b.features})},a.placeSelected=function(b){require(["esri/geometry/Point","esri/layers/GraphicsLayer","esri/graphic","esri/symbols/PictureMarkerSymbol"],function(c,d,e,f){var g=a.map.getLayer("locationGraphics");g||(g=new d({id:"locationGraphics"}),a.map.addLayer(g)),g.clear();var h=new f({url:"images/esriGreenPin16x26.af30506b.png",height:26,width:16,type:"esriPMS"}),i=new c({x:b.geometry.x,y:b.geometry.y,spatialReference:{wkid:a.map.spatialReference.latestWkid}});g.add(new e(i,h)),a.map.centerAndZoom(i,11)})}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("subdivisionSearch",function(){return{templateUrl:"directives/sidePanel/locationSearch/subdivisionSearch/subdivisionSearch.html",restrict:"EA",controller:["$scope","$http","locationFactory",function(a,b,c){a.subdivisions=function(a){return c.getSubdivision(a).then(function(a){return a.features})},a.subdivisionSelected=function(b,c,d){require(["esri/geometry/Polygon","esri/graphic","esri/layers/GraphicsLayer","esri/symbols/SimpleFillSymbol"],function(c,d,e,f){var g=new c(b.geometry);g.spatialReference=a.map.spatialReference,a.map.setExtent(g.getExtent(),!0);var h=a.map.getLayer("subdivisionGraphics"),i=null;h||(h=new e({id:"subdivisionGraphics"}),a.map.addLayer(h)),h.clear();var j=new f({type:"esriSFS",style:"esriSFSNull",color:[31,117,254,40],outline:{type:"esriSLS",style:"esriSLSSolid",color:[255,140,0,255],width:5}});i=new d(g,j),h.add(i)})}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("coordinateSearch",function(){return{templateUrl:"directives/sidePanel/locationSearch/coordinateSearch/coordinateSearch.html",restrict:"EA",controller:["$scope","mapUtils",function(a,b){a.coordinateTypes=[{label:"Decimal Degrees",xLabel:"Longitude",yLabel:"Latitude",wkid:4326,xmin:-79,xmax:-78.2,ymin:35.5,ymax:36.1,xPrompt:-78.643,yPrompt:35.778},{label:"Stateplane Feet",xLabel:"Easting",yLabel:"Northing",wkid:2264,xmin:1998e3,xmax:2222e3,ymin:644e3,ymax:848e3,xPrompt:2105888,yPrompt:738558}],a.coordinateType=a.coordinateTypes[0],a.zoomToCoordinate=function(){require(["esri/geometry/Point","esri/layers/GraphicsLayer","esri/graphic","esri/symbols/PictureMarkerSymbol"],function(c,d,e,f){var g=null,h=a.map.getLayer("locationGraphics"),i=null;h||(h=new d({id:"locationGraphics"}),a.map.addLayer(h)),h.clear();var j=new f({url:"images/esriGreenPin16x26.af30506b.png",height:26,width:16,type:"esriPMS"});a.coordinateType.wkid===a.map.spatialReference.latestWkid?(g=new c({x:a.coordinate.x,y:a.coordinate.y,spatialReference:{wkid:a.coordinateType.wkid}}),a.map.centerAndZoom(g,11),i=(new e).setGeometry(g).setSymbol(j),h.add(i)):b.project(a.config.map.geometryServiceUrl,{geometryType:"esriGeometryPoint",geometries:[{x:a.coordinate.x,y:a.coordinate.y}]},a.coordinateType.wkid,a.map.spatialReference.wkid).then(function(b){b.geometries.length>0&&(g=new c({x:b.geometries[0].x,y:b.geometries[0].y,spatialReference:{wkid:a.coordinateType.wkid}}),a.map.centerAndZoom(g,11),i=(new e).setGeometry(g).setSymbol(j).setAttributes({}),h.add(i))})})}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("layerList",["$timeout","$window","$filter","legend","localStorageService",function(a,b,c,d,e){return{templateUrl:"directives/sidePanel/layerList/layerList.html",restrict:"EA",controller:["$scope",function(a){a.layerFilterValue="",a.$parent.$broadcast("refreshSlider");var b=function(b){d.getLegend(b.url,b.id).then(function(b){var d=c("filter")(a.layers,function(a){return a.id===b.id})[0];angular.forEach(d.resourceInfo.layers,function(a,c){b.layers[c]&&(a.legend=b.layers[c].legend)})})};a.$watch("webmap",function(c){c&&(a.layers=c.itemInfo.itemData.operationalLayers,angular.forEach(a.layers,function(a){a.visibility&&b(a)}))}),a.filterLayers=function(b){var c=!1;if(0===a.layerFilterValue.length)c=!0;else if(c=b.title.toLowerCase().indexOf(a.layerFilterValue.toLowerCase())>-1,!c&&b.resourceInfo.layers)for(var d=0;d<b.resourceInfo.layers.length;d++)b.resourceInfo.layers[d].name.toLowerCase().indexOf(a.layerFilterValue.toLowerCase())>-1&&(c=!0);return c},a.clearLayers=function(b){for(var c=0;c<b.length;c++)"Parcels"!=b[c].title&&-1===b[c].title.indexOf("[hidden]")&&(a.map.getLayer(b[c].id).setVisibility(!1),b[c].visibility=!1)},a.layerToggle=function(c,d){c.visibility=!c.visibility,a.map.getLayer(c.id).setVisibility(c.visibility),c.visibility&&!c.resourceInfo.layers[0].legend&&b(c)},a.subLayerToggle=function(b,c,d){var e=[];c.defaultVisibility=!c.defaultVisibility,e=a.map.getLayer(b.id).visibleLayers,c.defaultVisibility?e.push(c.id):e.splice(e.indexOf(c.id),1),0===e.length&&(e=[-1]),b.layerObject.visibleLayers=e,b.layerObject._defaultVisibleLayers=e,a.webmap.itemInfo.itemData.operationalLayers=a.layers,a.map.getLayer(b.id).setVisibleLayers(e)},a.opacityChanged=function(b,c){a.map.getLayer(b.id).setOpacity(b.opacity)},a.translate=function(a){return(100*a).toFixed(0)+"%"},a.zoomToLayer=function(b){a.map.getScale()>b.resourceInfo.minScale&&a.map.setScale(b.resourceInfo.minScale)},a.zoomToSubLayer=function(b){a.map.getScale()>b.minScale&&a.map.setScale(b.minScale)}}],link:function(a,b,c){}}}]).factory("legend",["$http","$q",function(a,b){function c(c,d){var e=b.defer();return a({method:"GET",url:c+"/legend",params:{f:"json"}}).success(function(a){a.id=d,e.resolve(a)}),e.promise}var d={getLegend:c};return d}]),angular.module("imapsNgApp").directive("bookmarkTool",function(){return{templateUrl:"directives/toolPanel/bookmarkTool/bookmarkTool.html",restrict:"E",controller:["$scope","localStorageService",function(a,b){a.bookmarkName="";var c=function(){b.set("bookmarks",a.config.tools.bookmarks)};b.get("bookmarks")?a.config.tools.bookmarks=b.get("bookmarks"):c(),a.bookmarkDisabled=function(){return a.bookmarkName.length<1},a.goToBookmark=function(b){require(["esri/geometry/Extent"],function(c){var d=new c(b.extent);a.map.setExtent(d,!0)})},a.addBookmark=function(b){var d={name:b,extent:{xmin:a.map.extent.xmin,ymin:a.map.extent.ymin,xmax:a.map.extent.xmax,ymax:a.map.extent.ymax,spatialReference:{wkid:a.map.spatialReference.wkid}}};a.config.tools.bookmarks.push(d),a.bookmarkName="",c()},a.deleteBookmark=function(b){a.config.tools.bookmarks.splice(b,1),c()}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("clearTool",function(){return{templateUrl:"directives/toolPanel/clearTool/clearTool.html",restrict:"E",controller:["$scope","$rootScope","$timeout",function(a,b,c){a.$watch("tool",function(b){"Clear Map"===b.title&&a.clearMap()}),a.clearMap=function(){var c=null;a.map.graphics.clear(),angular.forEach(a.map.graphicsLayerIds,function(b){c=a.map.getLayer(b),c.type||c.clear()}),b.$broadcast("accountUpdate",[],!1),a.$broadcast("accountSelected",{}),$("#searchInput").typeahead("val",""),b.account=null,a.accounts=[],a.geometry=null,a.$broadcast("tabUpdated",0)}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("drawTool",function(){return{templateUrl:"directives/toolPanel/drawTool/drawTool.html",restrict:"E",controller:["$scope",function(a){var b,c,d,e,f,g,h,i;a.drawText="",a.drawColor="#FF0000",a.drawFontSize=12;var j=function(b){require(["esri/units","esri/graphic","esri/symbols/TextSymbol"],function(h,i,j){var k=new i(b.geometry);if(k.setAttributes({GraphicsLayer:"Drawing Graphics Layer"}),l(),"polygon"===b.geometry.type)k.setSymbol(c);else if("polyline"===b.geometry.type)k.setSymbol(d);else if("point"===b.geometry.type)if("Point"===a.drawType.name)k.setSymbol(e);else if("Text"===a.drawType.name){console.log(a.drawText);var m=$("#drawText").val();f.setText(m),k.setSymbol(f),k.setAttributes({GraphicsLayer:"Drawing Graphics Layer",label:m})}g.add(k),a.map.reorderLayer(g,a.map.layerIds.length-1)})},k=function(){require(["esri/toolbars/draw","esri/layers/GraphicsLayer","dojo/on"],function(c,d,e){g=new d({id:"drawGraphics"}),a.map.addLayer(g),b=new c(a.map),l(),e(b,"draw-end",j)})};a.undo=function(){g.remove(g.graphics[g.graphics.length-1])},a.$watch("map",function(a){a&&k()}),a.$watch("drawType",function(c){c&&("polyline"===c.shape||"polygon"===c.shape?b.activate((a.freehandDraw?"freehand":"")+c.shape):b.activate(c.shape),a.tool.height="Text"===c.name?250:165)}),a.drawFreehand=function(c){"polyline"===c.shape||"polygon"===c.shape?b.activate((a.freehandDraw?"freehand":"")+c.shape):b.activate(c.shape)},a.$watch("tool",function(c){"Draw"===c.title?(b||(b=new Draw(a.map)),a.drawType?c.height="Text"===a.drawType.name?250:165:c.height=165):b&&(b.deactivate(),a.drawType=null)});var l=function(){require(["esri/Color","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/TextSymbol"],function(g,j,k,l,m){h=g.fromHex(a.drawColor),i=.299*h.r+.587*h.g+.114*h.b>186?[0,0,0]:[255,255,255],h=h.toRgb(),c=new k({type:"esriSFS",style:"esriSFSNull",color:h,outline:{type:"esriSLS",style:"esriSLSSolid",color:h,width:3}}),d=new l({type:"esriSLS",style:"esriSLSSolid",color:h,width:3}),e=new j({color:h,size:a.drawFontSize,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:i,width:1,type:"esriSLS",style:"esriSLSSolid"}}),f=new m({type:"esriTS",color:h,backgroundColor:null,borderLineColor:null,verticalAlignment:"bottom",horizontalAlignment:"left",rightToLeft:!1,angle:0,xoffset:0,yoffset:0,font:{family:"Arial",size:a.drawFontSize,style:"normal",weight:"bold",decoration:"none"},haloColor:i,haloSize:1}),b.setFillSymbol(c),b.setLineSymbol(d),b.setMarkerSymbol(e)})};a.$on("colorpicker-closed",function(a,b){l()})}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("identifyTool",function(){return{templateUrl:"directives/toolPanel/identifyTool/identifyTool.html",restrict:"E",controller:["$scope",function(a){}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("measureTool",function(){return{templateUrl:"directives/toolPanel/measureTool/measureTool.html",restrict:"E",controller:["$scope","$filter","$timeout",function(a,b,c){var d,e,f,g,h,i,j=0,k=0,l=0,m=null,n=null,o=null,p=null,q=null;a.measurement="--",a.currentCoords="";var r=function(a,b,c){var d=spToDd(a,b),e="";if("FEET"===c)e=b.toFixed(4)+" N "+a.toFixed(4)+" E";else if("DECIMAL_DEGREES"===c)e="Lat: "+d[0].toFixed(6)+" Lng: "+d[1].toFixed(6);else if("DEGREE_MINUTE_SECONDS"===c){var f=new GeoPoint(d[1],d[0]);e=f.getLatDeg()+" "+f.getLonDeg()}return e},s=function(b,d){require(["esri/geometry/geometryEngine"],function(e){var f=null;i=b,"polygon"===b.type?f=e.planarArea(b,d).toFixed(2):"polyline"===b.type?(f=e.planarLength(b,d).toFixed(2),u()):"point"===b.type&&(f=r(b.x,b.y,d)),c(function(){a.measurement=f})})},t=function(b){var c=a.unit.wkid;require(["esri/units","esri/graphic"],function(a,h){var i=new h(b.geometry);"polygon"===b.geometry.type?(s(b.geometry,c),i.setSymbol(d)):"polyline"===b.geometry.type?(s(b.geometry,c),i.setSymbol(e)):"point"===b.geometry.type&&(s(b.geometry,c),i.setSymbol(f)),g.clear(),g.add(i)})},u=function(){o&&(o.remove(),o=null),m=null,j=0,k=0,l=0},v=function(b){require(["dojo/on"],function(c){m=b.mapPoint,l+=k,o||(o=c(a.map,"mouse-move",y))})},w=function(b){require(["esri/geometry/Polyline","esri/geometry/geometryEngine"],function(d,e){var f=new d(a.map.spatialReference);f.addPath([m,b]),k=e.planarLength(f,a.unit.wkid),j=l+k,c(function(){a.measurement=j.toFixed(2)})})},x=function(a,b){try{var c=new Qty(j+b.abbr);j=c.to(a.abbr).scalar,c=new Qty(k+b.abbr),k=c.to(a.abbr).scalar,c=new Qty(l+b.abbr),l=c.to(a.abbr).scalar}catch(d){}},y=function(a){w(a.mapPoint)},z=function(){require(["dojo/on"],function(b){n=b(a.map,"click",v)})},A=function(b,d){var e=r(b.x,b.y,d);c(function(){a.currentCoords=e})},B=function(){p&&(p.remove(),p=null,q=null)},C=function(){require(["dojo/on"],function(b){p=b(a.map,"mouse-move",function(b){q=b.mapPoint,A(b.mapPoint,a.unit.wkid)})})},D=function(){require(["esri/toolbars/draw","esri/layers/GraphicsLayer","esri/symbols/PictureMarkerSymbol","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","dojo/on"],function(b,c,i,j,k,l){g=new c,a.map.addLayer(g),d=new j({type:"esriSFS",style:"esriSFSSolid",color:[31,117,254,40],outline:{type:"esriSLS",style:"esriSLSSolid",color:[31,117,254,200],width:3}}),e=new k({type:"esriSLS",style:"esriSLSSolid",color:[31,117,254,255],width:3}),f=new i({url:"images/esriGreenPin16x26.af30506b.png",height:26,width:16,type:"esriPMS"}),h=new b(a.map),h.setFillSymbol(d),h.setLineSymbol(e),h.setMarkerSymbol(f),l(h,"draw-end",t)})};a.$watch("map",function(a){a&&D()}),a.units=[{label:"Feet",name:"FEET",wkid:9002,type:"length",active:!0,multiplier:3.28084,abbr:"ft"},{label:"Miles",name:"MILES",wkid:9035,type:"length",active:!1,multiplier:621371e-9,abbr:"mi"},{label:"Meters",name:"METERS",wkid:9001,type:"length",active:!1,multiplier:1,abbr:"m"},{label:"Kilometers",name:"KILOMETERS",wkid:9036,type:"length",active:!1,multiplier:.001,abbr:"km"},{label:"Yards",name:"YARDS",wkid:109002,type:"length",active:!1,multiplier:1.09361,abbr:"yd"},{label:"Square Feet",name:"SQUARE_FEET",wkid:109405,type:"area",active:!0,multiplier:10.7639,abbr:"ft²"},{label:"Acres",name:"ACRES",wkid:109403,type:"area",active:!1,multiplier:247105e-9,abbr:"acre"},{label:"Square Miles",name:"SQUARE_MILES",wkid:109413,type:"area",active:!1,multiplier:3.86102e-7,abbr:"mi²"},{label:"Square Meters",name:"SQUARE_METERS",wkid:109404,type:"area",active:!1,multiplier:1,abbr:"m²"},{label:"Square Kilometers",name:"KILOMETERS",wkid:109414,type:"area",active:!1,multiplier:1e-6,abbr:"km²"},{label:"Square Yards",name:"SQUARE_YARDS",wkid:109443,type:"area",active:!1,abbr:"yd²"},{label:"Decimal Degrees",wkid:"DECIMAL_DEGREES",type:"coordinates",active:!0},{label:"Degrees Minutes Seconds",wkid:"DEGREE_MINUTE_SECONDS",type:"coordinates",active:!1},{label:"Feet",wkid:"FEET",type:"coordinates",active:!1}],a.filterUnits=function(b){return a.measureType?b.type===a.measureType.type:void 0},a.$watch("measureType",function(c){if("Measure"===a.tool.title)if(c){a.tool.height=270;var d=b("filter")(a.units,function(a){return a.type===c.type&&a.active});d.length>0&&(a.unit=d[0]),"polygon"===c.shape||"polyline"===c.shape?h.activate((a.freehandMeasure?"freehand":"")+c.shape):h.activate(c.shape),"polyline"===c.shape?z():(u(),n&&(n.remove(),n=null)),"coordinates"===c.type?C():B(),i=null,a.measurement="--",g.clear()}else a.tool.height=130}),a.$watch("unit",function(c,d){if(a.measureType){var e=b("filter")(a.units,function(b){return a.measureType.type===b.type});angular.forEach(e,function(a){a.active=!1}),c.active=!0,i&&s(i,a.unit.wkid),"polyline"===a.measureType.shape&&d&&x(c,d),"coordinates"===a.measureType.type&&q&&A(q,a.unit.wkid)}}),a.measureFreehand=function(b){h.activate((a.freehandMeasure?"freehand":"")+b.shape)},a.$watch("tool",function(b){"Measure"===b.title?(h||(h=new Draw(a.map)),a.measureType?b.height=270:b.height=130):h&&(h.deactivate(),a.measureType=null,u(),B(),n&&(n.remove(),n=null))})}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("printTool",["cfpLoadingBar",function(a){return{templateUrl:"directives/toolPanel/printTool/printTool.html",restrict:"E",controller:["$scope","$rootScope","$filter","$http","$analytics","$timeout",function(b,c,d,e,f,g){var h=null;b.printing=!1,b.printAtts=!1,b.printTitle="",b.printFormats=[{value:"PDF",label:"PDF"},{value:"JPG",label:"Image"}],b.printFormat=b.printFormats[0],b.printSizes=[{value:"85x11",label:'8.5"x11"',dpi:200,mapframe:{landscape:{attributes:{width:7.5,height:7.5},width:10,height:6.7},portrait:{attributes:{width:7.5,height:7.5},width:7.5,height:7.5}}},{value:"11x17",label:'11"x17"',dpi:200,mapframe:{landscape:{attributes:{width:13,height:10},width:16,height:9},portrait:{attributes:{width:10,height:13},width:10,height:13}}},{value:"24x36",label:'24"x36"',dpi:96,mapframe:{landscape:{attributes:{width:28,height:23},width:35,height:21},portrait:{attributes:{width:23,height:29},width:23,height:29}}},{value:"36x48",label:'36"x48"',dpi:96,mapframe:{landscape:{attributes:{width:38,height:35},width:47,height:32.5},portrait:{attributes:{width:35,height:39},width:35,height:39}}}],b.printSize=b.printSizes[0],b.printOrients=[{value:"landscape",label:"Landscape"},{value:"portrait",label:"Portrait"}],b.printOrient=b.printOrients[0],b.printScales=[{label:"Current Scale",value:0,current:!0},{label:"1\" = 50'",value:600},{label:"1\" = 100'",value:1200},{label:"1\" = 200'",value:2400},{label:"1\" = 400'",value:4800},{label:"1\" = 800'",value:9600},{label:"1\" = 1,600'",value:17200},{label:"1\" = 3,200'",value:38400},{label:"1\" = 6,400'",value:76800},{label:"1\" = 12,800'",value:153600},{label:"1\" = 25,600'",value:307200},{label:"Custom",value:void 0,custom:!0}],b.printScale=b.printScales[0];var i=function(){var a="";return b.$parent.accountInfo&&b.printAtts&&angular.forEach(b.$parent.accountInfo,function(b){"Crime"!=b.field&&"Septic Permit"!=b.field&&"Well Samples"!=b.field&&(a+=b.field+": "+b.value+"\r\n")}),a},j=function(a){var c=b.printScale.value;return b.printScale.current?c=parseInt(a.getScale(b.map)):b.printScale.custom&&(c=12*c),c};b.exportMap=function(c){require(["esri/tasks/PrintTask","esri/tasks/PrintParameters","esri/tasks/PrintTemplate"],function(d,e,g){var h=new d(b.config.tools["export"].url),i=new g;i.format="JPG",i.layout="MAP_ONLY",i.exportOptions={width:c.width,height:c.height,dpi:96};var j=new e;j.map=c,j.template=i,a.start(),b.printing=!0,b.printMessage="Generating Image...",f.eventTrack("Export Image"),h.execute(j,function(c){window.open(c.url),a.complete(),b.printing=!1},function(c){a.complete(),b.printing=!1})})},b.printPDF=function(c){require(["esri/tasks/PrintTask","esri/tasks/PrintParameters","esri/tasks/PrintTemplate","esri/geometry/scaleUtils"],function(d,e,g,k){var l=new d("https://maps.raleighnc.gov/arcgis/rest/services/Geoprocessing/ExportWebMap/GPServer/Export%20Web%20Map",{async:!0}),m=new e,n=i();m.map=c;var o=new g;o.format="PDF",o.layout=b.printSize.value+"_"+b.printOrient.value+(b.$parent.accountInfo&&b.printAtts?"_attributes":""),o.layoutOptions={titleText:b.printTitle,scalebarUnit:"Feet",customTextElements:[{title:b.printTitle},{Fields:n}]},o.exportOptions={dpi:b.printSize.dpi},o.preserveScale=!0,o.outScale=j(k),m.template=o,a.start(),b.printing=!0,b.printMessage="Generating PDF...",f.eventTrack("Export PDF",{category:"size",label:b.printSize.value}),f.eventTrack("Export PDF",{category:"layout",label:b.printOrient.value}),f.eventTrack("Export PDF",{category:"attributes",label:""!=n}),h.setVisibility(!1),l.execute(m,function(c){window.open(c.url),a.complete(),b.printing=!1},function(c){a.complete(),b.printing=!1,console.log(c)}),h.setVisibility(!0)})},b.printFormatChanged=function(a){"PDF"===a?(b.tool.height=325,h.setVisibility(!0)):"Image"===a&&(b.tool.height=150,h.setVisibility(!1))};var k=function(a,c,d,e,f,g){var i=b.map.extent.getCenter().x-a/2,j=b.map.extent.getCenter().x+a/2,k=b.map.extent.getCenter().y-c/2,l=b.map.extent.getCenter().y+c/2,n=new d(i,k,j,l);n.spatialReference=b.map.spatialReference,h=b.map.getLayer("printFrame");var o=null;h||(h=new f({id:"printFrame"}),b.map.addLayer(h)),h.clear(),m="light"===b.basemap.tone?[0,0,0,80]:[255,255,255,80];var p=new g({type:"esriSFS",style:"esriSFSSolid",color:m,outline:{type:"esriSLS",style:"esriSLSNull",color:[255,140,0,255],width:5}});o=new e(n,p),h.add(o)};b.displayFrame=function(){if(b.map&&"Print"===b.tool.title){var a=b.printOrient.value,c=b.$parent.accountInfo&&b.printAtts,d=b.printSize.mapframe[a],e=0,f=0;c&&(d=d.attributes),require(["esri/geometry/Extent","esri/graphic","esri/layers/GraphicsLayer","esri/symbols/SimpleFillSymbol","esri/geometry/scaleUtils"],function(a,b,c,g,h){e=j(h)/12*d.width,f=j(h)/12*d.height,k(e,f,a,b,c,g)})}};var l=null,m=[0,0,0,80];b.$watch("basemap",function(a){a&&(m="light"===a.tone?[0,0,0,80]:[255,255,255,80],b.displayFrame())}),b.$watch("tool",function(a){"Print"===a.title?(g(b.displayFrame),require(["dojo/on"],function(a){l=a(b.map,"extent-change",function(){b.displayFrame()})})):l&&(l.remove(),h&&h.clear())})}],link:function(a,b,c){}}}]),angular.module("imapsNgApp").directive("selectTool",function(){return{templateUrl:"directives/toolPanel/selectTool/selectTool.html",restrict:"E",controller:["$scope","$rootScope","property","mapUtils",function(a,b,c,d){a.selectBufferDist=0,a.bufferProperty=function(){e(a.geometry,"esriGeometryPolygon")};var e=function(b,c){require(["esri/geometry/geometryEngine","esri/geometry/Polygon","esri/graphic","esri/graphicsUtils"],function(c,d,e,g){b.type||(b=new d(b));var h=c.buffer(b,parseInt(a.selectBufferDist),9002,!0);a.bufferGraphics.clear();var i=new e({geometry:h,symbol:{color:[0,0,0,0],outline:{color:[0,0,0,100],width:3,type:"esriSLS",style:"esriSLSSolid"},type:"esriSFS",style:"esriSFSSolid"}});a.bufferGraphics.add(i),a.map.setExtent(g.graphicsExtent(a.bufferGraphics.graphics),!0),f(h,"esriGeometryPolygon",a.map.spatialReference.wkid)})},f=function(d,e,f){c.getPropertiesByGeometry(d,e,0,f).then(function(g){c.getPropertiesByGeometry(d,e,1,f).then(function(d){g.features=g.features.concat(d.features);var e=[];angular.forEach(g.features,function(a){e.push(a.attributes.PIN_NUM)}),a.selectionSingle.clear(),a.selectionMultiple.clear(),c.getRealEstate("pin",e).then(function(c){a.account=null,a.$parent.account=null,a.geometry=null,a.fields=c.Fields,a.accounts=c.Accounts,b.zoomTo=!1,b.$broadcast("accountUpdate",c.Accounts)})})})};require(["esri/toolbars/draw","dojo/on"],function(b,c){var d=null,g=function(b){var c="";switch(b.geometry.type){case"point":c="esriGeometryPoint";break;case"polygon":c="esriGeometryPolygon";break;case"polyline":c="esriGeometryPolyline";break;case"multipoint":c="esriGeometryMultipoint"}b.geometry.spatialReference=a.map.spatialReference,a.selectBufferDist>0?e(b.geometry,c):f(b.geometry,c,a.map.spatialReference.wkid)};a.selectTypeChanged=function(b){a.freehand&&-1===b.indexOf("point")?(b="freehand"+b,a.map.disableMapNavigation()):a.map.enableMapNavigation(),d.activate(b)},a.$watch("geometry",function(b){"Property Select"===a.tool.title&&(a.tool.height=b?290:240)}),a.$watch("tool",function(e){"Property Select"===e.title?(e.height=a.geometry?290:240,d||(d=new b(a.map),c(d,"draw-end",g)),a.selectType="point",a.selectTypeChanged("point")):(d&&(d.deactivate(),a.selectType=""),a.map&&a.map.enableMapNavigation())})})}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("streetviewTool",function(){return{templateUrl:"directives/toolPanel/streetviewTool/streetviewTool.html",restrict:"E",controller:["$scope","$rootScope","$timeout",function(a,b,c){a.streetviewActive=!1;var d=null;a.streetviewFull=!1;var e=b.checked,f=function(b,e){var f=new google.maps.LatLng(b,e),g=new google.maps.StreetViewService;g.getPanoramaByLocation(f,50,function(b,e){if(e==google.maps.StreetViewStatus.OK){var f=(b.location.latLng,{position:b.location.latLng,imageDateControl:!0});d=new google.maps.StreetViewPanorama(document.getElementById("streetview")),d.setOptions(f),a.streetviewActive=!0,c(function(){google.maps.event.trigger(streetview,"resize")})}else a.streetviewActive=!1})},g=function(a){var b=spToDd(a.mapPoint.x,a.mapPoint.y);f(b[0],b[1])},h=null;a.$watch("tool",function(b){require(["dojo/on"],function(c){if("Streetview"===b.title){h=c(a.map,"click",g);var d=spToDd(a.map.extent.getCenter().x,a.map.extent.getCenter().y);f(d[0],d[1])}else h&&h.remove()})}),a.goFull=function(){$("app-header").hide(),a.streetviewFull=!0,$("#streetview").css("position","fixed").css("top",0).css("bottom",0).css("left",0).css("right",0).css("z-index",1e4).css("height","auto"),e=b.checked,b.checked=!1,google.maps.event.trigger(d,"resize")},a.minimizeStreetview=function(){$("app-header").show(),a.streetviewFull=!1,$("#streetview").css("position","relative").css("top",0).css("bottom",0).css("left",0).css("right",0).css("z-index",1e4).css("height","240px"),
b.checked=e,google.maps.event.trigger(d,"resize")}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").directive("obliqueTool",function(){return{templateUrl:"directives/toolPanel/obliqueTool/obliqueTool.html",restrict:"E",controller:["$scope","$rootScope","$timeout",function(a,b,c){var d=null;a.obliqueFull=!1;var e=b.checked,f=function(a,b){var e=new google.maps.LatLng(a,b),f={center:e,zoom:18,mapTypeId:google.maps.MapTypeId.SATELLITE,heading:0,tilt:45,overviewMapControl:!1,streetViewControl:!1,mapTypeControl:!1};d=new google.maps.Map(document.getElementById("obliqueMap"),f),c(function(){google.maps.event.trigger(d,"resize")})},g=function(a){var b=spToDd(a.mapPoint.x,a.mapPoint.y);f(b[0],b[1])},h=null;a.$watch("tool",function(b){require(["dojo/on"],function(c){if("Oblique"===b.title){h=c(a.map,"click",g);var d=spToDd(a.map.extent.getCenter().x,a.map.extent.getCenter().y);f(d[0],d[1])}else h&&h.remove()})}),a.goFullOblique=function(){$("app-header").hide(),a.obliqueFull=!0,$("#obliqueMap").css("position","fixed").css("top",0).css("bottom",0).css("left",0).css("right",0).css("z-index",1e4).css("height","auto"),e=b.checked,b.checked=!1,google.maps.event.trigger(d,"resize")},a.minimizeOblique=function(){$("app-header").show(),a.obliqueFull=!1,$("#obliqueMap").css("position","relative").css("top",0).css("bottom",0).css("left",0).css("right",0).css("z-index",1e4).css("height","240px"),b.checked=e,google.maps.event.trigger(d,"resize")}}],link:function(a,b,c){}}}),angular.module("imapsNgApp").factory("config",["$http","$q",function(a,b){function c(c){var d=b.defer();return a({method:"GET",url:c}).success(d.resolve),d.promise}var d={loadConfig:c};return d}]),angular.module("imapsNgApp").factory("property",["$http","$q",function(a,b){function c(c,d){var e=b.defer();return a({method:"POST",url:m+"RealEstateSearch",data:$.param({type:c,values:JSON.stringify(d),f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(e.resolve),e.promise}function d(c){var d=b.defer();return a({method:"GET",url:m+"PhotoSearch",params:{reid:c,f:"json"}}).success(d.resolve),d.promise}function e(c){var d=b.defer();return a({method:"GET",url:m+"DeedSearch",params:{reid:c,f:"json"}}).success(d.resolve),d.promise}function f(c,d){var e=b.defer();return a({method:"GET",url:m+"AddressSearch",params:{pin:c,reid:d,f:"json"}}).success(e.resolve),e.promise}function g(c,d,e,f){var g=b.defer();return a({method:"POST",url:n+"/identify",data:$.param({f:"json",geometry:stringify(c),geometryType:"esriGeometryPolygon",layers:"all",tolerance:1,mapExtent:stringify(d),imageDisplay:e+","+f+",96",returnGeometry:!1}),headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"}}).success(g.resolve),g.promise}function h(c){var d=b.defer();return a({method:"GET",url:m+"SepticPermits",params:{pin:c,f:"json"}}).success(d.resolve),d.promise}function i(c){var d=b.defer();return a({method:"GET",url:m+"WellResults",params:{pin:c,f:"json"}}).success(d.resolve),d.promise}function j(c,d,e){var f=b.defer();return a({method:"POST",url:o+"/"+d+"/query",data:$.param({where:c,returnGeometry:!0,outFields:"PIN_NUM,SITE_ADDRESS,OWNER",outSR:e,geometryPrecision:0,f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(f.resolve),f.promise}function k(c,d,e,f){var g=b.defer();return a({method:"POST",url:o+"/"+e+"/query",data:$.param({where:"1=1",geometry:stringify(c),returnGeometry:!1,outFields:"PIN_NUM",geometryType:d,geometryPrecision:0,outSR:f,f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(g.resolve),g.promise}var l={getRealEstate:c,getPhotos:d,getDeeds:e,getAddresses:f,getGeometryByPins:j,getPropertiesByGeometry:k,getSepticPermits:h,getWellResults:i,getServices:g},m="https://maps.raleighnc.gov/arcgis/rest/services/Parcels/MapServer/exts/PropertySOE/",n="https://maps.raleighnc.gov/arcgis/rest/services/Services/ServicesIMaps/MapServer",o="https://maps.raleighnc.gov/arcgis/rest/services/Parcels/MapServer";return l}]),angular.module("imapsNgApp").factory("mapUtils",["$http","$q",function(a,b){function c(c){var d=b.defer();return a({method:"GET",url:c}).success(d.resolve),d.promise}function d(c,d,e,f,g,h){var i=b.defer();return a({method:"POST",url:c+"/buffer",data:{geometries:stringify(d),inSR:e,outSR:e,bufferSR:e,distances:f,unit:g,unionResults:!0,f:"json"},headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(i.resolve),i.promise}function e(c,d,e,f){var g=b.defer();return a({method:"POST",url:c+"/project",data:$.param({geometries:stringify(d),inSR:e,outSR:f,f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(g.resolve),g.promise}var f={loadRaleighBounds:c,buffer:d,project:e};return f}]),angular.module("imapsNgApp").factory("locationFactory",["$http","$q",function(a,b){function c(c){var d=b.defer();return a({method:"GET",url:"https://maps.raleighnc.gov/arcgis/rest/services/Planning/Subdivisions/MapServer/0/query",params:{where:"NAME LIKE '"+c.toUpperCase()+"%'",orderByFields:"NAME",outFields:"NAME",returnGeometry:!0,f:"json"}}).success(d.resolve),d.promise}function d(c){var d=b.defer();return a({method:"GET",url:"https://maps.raleighnc.gov/arcgis/rest/services/StreetsDissolved/MapServer/0/query",params:{where:"CARTONAME LIKE '%"+c.toUpperCase()+"%'",orderByFields:"CARTONAME",outFields:"CARTONAME",returnGeometry:!0,f:"json"}}).success(d.resolve),d.promise}function e(c){var d=b.defer();return a({method:"POST",url:"https://maps.raleighnc.gov/arcgis/rest/services/StreetsDissolved/MapServer/0/query",data:$.param({geometry:JSON.stringify(c),geometryType:"esriGeometryPolyline",returnGeometry:!1,outFields:"CARTONAME",orderByFields:"CARTONAME",f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(d.resolve),d.promise}function f(c){var d=b.defer();return a({method:"GET",url:"https://maps.raleighnc.gov/arcgis/rest/services/Locators/CompositeLocator/GeocodeServer/findAddressCandidates",params:{SingleLine:c,returnGeometry:!0,f:"json"}}).success(d.resolve),d.promise}function g(){var c=b.defer();return a({method:"GET",url:"https://maps.raleighnc.gov/arcgis/rest/services/POI1/MapServer/0/query",params:{where:"1=1",outFields:"ICON",returnDistinctValues:!0,orderByFields:"ICON",returnGeometry:!1,f:"json"}}).success(c.resolve),c.promise}function h(c){var d=b.defer();return a({method:"GET",url:"https://maps.raleighnc.gov/arcgis/rest/services/POI1/MapServer/0/query",params:{where:"ICON = '"+c+"'",outFields:"*",orderByFields:"NAME",returnGeometry:!0,f:"json"}}).success(d.resolve),d.promise}var i={getSubdivision:c,getStreets:d,getIntersectingStreets:e,geocodeAddress:f,getPlaceTypes:g,getPlacesByType:h};return i}]),angular.module("imapsNgApp").factory("puma",["$http","$q",function(a,b){function c(c,d,e,f){var g=b.defer();return a({method:"POST",url:c,data:$.param({searchText:e,searchFields:f,layers:d,geometryPrecision:0,contains:"true",returnGeometry:"true",f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(g.resolve),g.promise}function d(c){var d=b.defer();return a({method:"POST",url:c,data:$.param({f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(d.resolve),d.promise}var e={findUtilitiesById:c,getUtilityLayers:d};return e}]),require(["esri/layers/LabelLayer"],function(a){"function"==typeof a.prototype._addLabel&&(a.prototype._addLabel2=a.prototype._addLabel,a.prototype._addLabel=function(a,b,c,d,e,f,g){a=a.replace(/\n/g,"<br />"),this._addLabel2(a,b,c,d,e,f,g)})}),require(["esri/symbols/TextSymbol","dojox/gfx/svg"],function(a,b){"function"==typeof dojox.gfx.svg.Text.prototype.setShape&&(dojox.gfx.svg.Text.prototype.setShape=function(a){this.shape=dojox.gfx.makeParameters(this.shape,a),this.bbox=null;var b=this.rawNode,c=this.shape;for(b.setAttribute("x",c.x),b.setAttribute("y",c.y),b.setAttribute("text-anchor",c.align),b.setAttribute("text-decoration",c.decoration),b.setAttribute("rotate",c.rotated?90:0),b.setAttribute("kerning",c.kerning?"auto":0),b.setAttribute("text-rendering","optimizeLegibility");b.firstChild;)b.removeChild(b.firstChild);if(c.text){var d=c.text.replace(/<br\s*\/?>/gi,"\n").split("\n"),e=1.1*parseInt(document.defaultView.getComputedStyle(b,"").getPropertyValue("font-size"),10);(isNaN(e)||!isFinite(e))&&(e=15);for(var f=0,g=d.length;g>f;f++){var h=document.createElementNS?document.createElementNS(dojox.gfx.svg.xmlns.svg,"tspan"):document.createElement("tspan");h.setAttribute("dy",f?e:-(d.length-1)*e/2),h.setAttribute("x",c.x),h.appendChild(dojox.gfx.useSvgWeb?document.createTextNode(d[f],!0):document.createTextNode(d[f])),b.appendChild(h)}}return this})});